<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>UAF CGPA Calculator | Automatic & Accurate | University of Agriculture Faisalabad</title>
  
  <meta name="description" content="The #1 UAF CGPA Calculator. Automatically fetches results from the UAF LMS, offers powerful editing, forecasting, and professional PDF exports. Fast, accurate, and secure for all UAF students." />
  <meta name="keywords" content="uaf cgpa calculator, university of agriculture faisalabad, uaf lms results, uaf gpa calculator, cgpa forecast, calculate cgpa uaf" />
  <meta name="author" content="Muhammad Saqlain" />
  <link rel="canonical" href="https://uafcgpacalculator.vercel.app" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="og:title" content="The Ultimate UAF CGPA Calculator | Automatic & Accurate" />
  <meta property="og:description" content="Automatically fetch results, forecast your CGPA, edit courses with drag-and-drop, and download professional PDF transcripts." />
  <meta property="og:image" content="https://uafcgpacalculator.vercel.app/og-image.png" />
  <meta property="og:site_name" content="UAF CGPA Calculator" />
  <meta property="twitter:card" content="summary_large_image" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* --- 1. Root Variables & Basic Setup --- */
    :root {
      --brand-primary: #7a6ad8;
      --brand-secondary: #6b5fca;
      --brand-gradient: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
      --brand-gradient-hover: linear-gradient(135deg, #8a7ce8 0%, #7b6fda 100%);
      --accent: #ff6b6b;
      --text-dark: #1b1f24;
      --text-light: #4b5563;
      --muted: #6b7280;
      --light-bg: #f8f9ff;
      --card-bg: #ffffff;
      --success: #10ac84;
      --danger: #e74c3c;
      --info: #3498db;
      --warning: #f39c12;
      --radius: 1.25rem;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      --shadow-hover: 0 15px 40px rgba(17, 24, 39, 0.12);
    }

    html, body {
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      scroll-behavior: smooth;
      color: var(--text-dark);
      background-color: var(--light-bg);
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(122, 106, 216, 0.1); }
    ::-webkit-scrollbar-thumb { background: var(--brand-primary); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--brand-secondary); }

    /* --- 2. Animations & Transitions --- */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { translateY(0px); } }
    @keyframes gradient-text { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .fade-in-on-scroll { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    .fade-in-on-scroll.is-visible { opacity: 1; transform: translateY(0); }
    .pulse { animation: pulse 2s infinite ease-in-out; }
    .float { animation: float 3.5s ease-in-out infinite; }
    .gradient-text, .hero-text-gradient, .robot-icon-gradient {
      background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary));
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-text 4s ease infinite;
    }

    /* --- 3. Reusable Components (Buttons, Cards, Forms) --- */

    /* Buttons */
    .btn { transition: all 0.3s ease; }
    .btn-primary-action { background: var(--brand-gradient); color: white; border: 0; box-shadow: 0 6px 18px rgba(122, 106, 216, 0.2); }
    .btn-primary-action:hover { background: var(--brand-gradient-hover); color: white; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(122, 106, 216, 0.3); }
    .btn-secondary-action { background: #fff; color: var(--brand-primary); border: 1px solid rgba(122, 106, 216, 0.15); }
    .btn-secondary-action:hover { background: #f8f9ff; transform: translateY(-1px); box-shadow: 0 5px 15px rgba(122, 106, 216, 0.1); }
    .btn-soft { background: rgba(122, 106, 216, 0.1); color: var(--brand-primary); }
    .btn-soft:hover { background: rgba(122, 106, 216, 0.2); }
    .btn-danger-action { background-color: var(--danger); color: white; border:0; }
    .btn-danger-action:hover { background-color: #c0392b; color: white; transform: translateY(-2px); }
    .btn-success-action { background-color: var(--success); color: white; border:0; }
    .btn-success-action:hover { background-color: #0d916b; color: white; transform: translateY(-2px); }
    .btn-info-action { background-color: var(--info); color: white; border:0; }
    .btn-info-action:hover { background-color: #2980b9; color: white; transform: translateY(-2px); }
    .btn-pdf-download { background-color: var(--danger); color: white; border: 0; }
    .btn-pdf-download:hover { background-color: #c0392b; color: white; transform: translateY(-2px); }

    /* Badges */
    .badge-brand { background: var(--brand-gradient); color: white; }

    /* Cards */
    .card-modern {
      border: 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.85);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    .card-modern:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
    .card-modern .card-header {
      border: 0;
      background: linear-gradient(135deg, rgba(122, 106, 216, 0.15), rgba(122, 106, 216, 0.05));
      padding: 1.5rem 2rem;
    }
    .card-modern .card-header h4 { font-weight: 700; color: var(--text-dark); }

    /* Forms */
    .form-select, .form-control {
      border-radius: .85rem;
      border: 1px solid rgba(122, 106, 216, 0.2);
      padding: 0.75rem 1.25rem;
      transition: all 0.3s ease;
      background-color: rgba(255, 255, 255, 0.9);
    }
    .form-select:focus, .form-control:focus {
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 0.25rem rgba(122, 106, 216, 0.25);
      transform: translateY(-1px);
    }
    .scraping-section #registrationNumber { max-width: 400px; margin: 0 auto; text-align: center; }

    /* --- 4. Page Sections --- */

    /* Navbar */
    .navbar {
      backdrop-filter: saturate(180%) blur(12px);
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
    }
    .navbar-brand { font-weight: 800; }
    .nav-link { font-weight: 500; position: relative; }
    .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--brand-gradient); transition: width 0.3s ease; }
    .nav-link:hover::after, .nav-link.active::after { width: 100%; }

    /* Hero Section */
    .hero { padding: 5rem 0 4rem; position: relative; overflow: hidden; }
    .hero::before, .hero::after { content: ''; position: absolute; border-radius: 50%; z-index: -1; }
    .hero::before { top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(122, 106, 216, 0.1); }
    .hero::after { bottom: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255, 107, 107, 0.1); }
    .hero h1 { font-weight: 800; line-height: 1.1; font-size: 3.5rem; }
    .hero .lead { color: var(--text-light); font-size: 1.25rem; max-width: 600px; }

    /* Why Choose / Features Section */
    .why-choose-section { padding: 5rem 0; }
    .feature-card { background: rgba(255, 255, 255, 0.8); border-radius: var(--radius); padding: 2rem; height: 100%; text-align: center; transition: all 0.3s ease; backdrop-filter: blur(10px); box-shadow: var(--shadow); }
    .feature-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-hover); }
    .feature-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; background: var(--brand-gradient); color: white; font-size: 1.5rem; transition: all 0.3s ease; }
    .feature-card:hover .feature-icon { transform: scale(1.1) rotate(5deg); }

    /* --- 5. App-Specific UI --- */

    /* Loading Indicator */
    .loading-container { display: none; margin-top: 1.5rem; text-align: center; padding: 3rem 2rem; border-radius: var(--radius); background: linear-gradient(135deg, rgba(122, 106, 216, 0.1), rgba(122, 106, 216, 0.05)); }
    .loading-stage { display: none; }
    .loading-dots span { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--brand-primary); margin: 0 4px; animation: bounce 1.4s infinite ease-in-out; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .loading-text { font-weight: 600; color: var(--brand-primary); margin-top: 1rem; }
    .loading-subtext { color: var(--muted); font-size: 0.9rem; }

    /* Status Log */
    .status-log { max-height: 300px; overflow-y: auto; background: rgba(248, 249, 250, 0.7); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.875rem; }
    .status-line { margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(233, 236, 239, 0.5); }
    .status-success { color: var(--success); } .status-error { color: var(--danger); }
    .status-warning { color: var(--warning); } .status-info { color: var(--info); }

    /* CGPA Result Display */
    .gpa-result-card { border-radius: var(--radius); padding: 2.5rem; box-shadow: var(--shadow); margin: 2rem auto; width: 100%; max-width: 800px; backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.8); }
    .cgpa-display-container { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
    .cgpa-main-info { text-align: center; width: 100%; padding-bottom: 1rem; border-bottom: 1px solid rgba(122, 106, 216, 0.2); }
    .cgpa-metrics-row { display: flex; justify-content: space-around; width: 100%; gap: 1rem; }
    .cgpa-metric { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .cgpa-metric-label { font-size: 1rem; font-weight: 500; color: var(--muted); margin-bottom: 0.25rem; }
    .cgpa-metric-value { font-size: 2.25rem; font-weight: 700; line-height: 1.1; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .cgpa-metric-subvalue { font-size: 0.9rem; color: var(--muted); }

    /* Action Buttons */
    .action-buttons { display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; flex-wrap: wrap; gap: 1rem; }

    /* Semester Cards & Course Table */
    .section-title { margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid rgba(122, 106, 216, 0.2); position: relative; }
    .section-title::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 60px; height: 2px; background: var(--brand-gradient); }
    .semester-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 992px) { .semester-grid { grid-template-columns: repeat(2, 1fr); } }
    .semester-card { background: rgba(255, 255, 255, 0.7); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); position: relative; backdrop-filter: blur(10px); transition: all 0.3s ease; }
    .semester-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .semester-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; font-size: 1.1rem; }
    .semester-actions i { cursor: pointer; transition: all 0.2s ease; padding: 0.25rem; }
    .semester-actions i:hover { transform: scale(1.2); }
    .delete-semester { color: var(--danger); }
    .add-course { color: var(--brand-primary); }
    .course-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .course-table th, .course-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(229, 231, 235, 0.7); }
    .course-table th { font-weight: 600; color: var(--muted); background: rgba(122, 106, 216, 0.05); }
    .grade-badge { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.75rem; }
    .grade-A { background-color: rgba(220, 252, 231, 0.7); color: #166534; } .grade-B { background-color: rgba(219, 234, 254, 0.7); color: #1e40af; }
    .grade-C { background-color: rgba(254, 243, 199, 0.7); color: #92400e; } .grade-D { background-color: rgba(254, 226, 226, 0.7); color: #991b1b; }
    .grade-F { background-color: rgba(243, 244, 246, 0.7); color: #374151; }
    .extra-enrolled-badge { background-color: rgba(255, 193, 7, 0.3); color: #856404; font-size: 0.65rem; padding: 2px 4px; border-radius: 4px; margin-left: 4px; font-weight: bold; }
    .course-actions i { cursor: pointer; font-size: 14px; padding: 4px; border-radius: 4px; transition: all 0.2s ease; }
    .delete-course { color: var(--danger); } .delete-course:hover { background-color: rgba(220, 53, 69, 0.1); }
    .restore-course { color: var(--success); } .restore-course:hover { background-color: rgba(16, 172, 132, 0.1); }
    .clickable-info { cursor: pointer; color: var(--brand-primary); transition: opacity 0.2s; }
    .clickable-info:hover { opacity: 0.7; }

    /* Drag and Drop Styles */
    .course-table tr[draggable="true"] { cursor: grab; }
    .course-table tr.dragging { opacity: 0.4; background: #e9e6f8; }
    .semester-card.drag-over { border: 2px dashed var(--brand-primary); transform: scale(1.02); background-color: rgba(122, 106, 216, 0.1); }

    /* --- 6. Global & Utility Classes --- */

    /* Toasts / Notifications */
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast-notification { background: white; border-radius: 12px; padding: 16px 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); display: flex; align-items: center; min-width: 320px; transform: translateX(110%); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); position: relative; overflow: hidden; border-left: 4px solid; backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
    .toast-notification.show { transform: translateX(0); opacity: 1; }
    .toast-notification.success { border-left-color: var(--success); } .toast-notification.error { border-left-color: var(--danger); }
    .toast-notification.warning { border-left-color: var(--warning); } .toast-notification.info { border-left-color: var(--info); }
    .toast-icon { margin-right: 12px; font-size: 20px; }
    .toast-notification.success .toast-icon { color: var(--success); } .toast-notification.error .toast-icon { color: var(--danger); }
    .toast-notification.warning .toast-icon { color: var(--warning); } .toast-notification.info .toast-icon { color: var(--info); }
    .toast-message { font-weight: 500; font-size: 15px; color: #2d3748; }

    /* Undo Notification */
    #undo-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; }
    .undo-notification { background-color: rgba(30, 30, 30, 0.95); color: white; padding: 12px 20px; border-radius: 8px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); animation: fadeIn 0.3s ease; }
    .undo-btn { background: var(--brand-gradient); color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-weight: 600; }

    /* Back to Top & Cursor */
    #backToTop { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--brand-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; }
    #backToTop.visible { opacity: 1; visibility: visible; }
    #backToTop:hover { transform: translateY(-5px); }
    .cursor-dot { display: none; position: fixed; width: 10px; height: 10px; border-radius: 50%; background: var(--brand-primary); pointer-events: none; transform: translate(-50%, -50%); opacity: .7; mix-blend-mode: multiply; z-index: 9999; transition: width 0.2s, height 0.2s; }
    @media (min-width: 992px) { .cursor-dot { display: block; } }

    /* --- 7. Dark Mode --- */
    [data-theme="dark"] {
      --text-dark: #e5e7eb; --text-light: #d1d5db; --muted: #9ca3af;
      --light-bg: #0f1320; --card-bg: #1a2030;
    }
    [data-theme="dark"] body { background: linear-gradient(180deg, #0b0e13 0%, #0f1320 70%); color: #f1f5f9; }
    [data-theme="dark"] .navbar, [data-theme="dark"] .card-modern, [data-theme="dark"] .feature-card, [data-theme="dark"] .gpa-result-card, [data-theme="dark"] .semester-card { background: rgba(20, 25, 40, 0.8); }
    [data-theme="dark"] .card-modern .card-header { background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1)); }
    [data-theme="dark"] .form-control, [data-theme="dark"] .form-select { background: rgba(11, 16, 32, 0.8); color: #f1f5f9; border-color: rgba(122, 106, 216, 0.3); }
    [data-theme="dark"] .status-log { background: rgba(26, 32, 48, 0.8); }
    [data-theme="dark"] .course-table th, [data-theme="dark"] .course-table td { border-bottom-color: rgba(45, 55, 72, 0.5); }
    [data-theme="dark"] .toast-notification { background: rgba(30, 35, 50, 0.95); }
    [data-theme="dark"] .toast-message { color: #e5e7eb; }
    [data-theme="dark"] .modal-content { background-color: #1a2030; color: #e5e7eb; }
    [data-theme="dark"] .btn-close { filter: invert(1); }
    [data-theme="dark"] .cursor-dot { mix-blend-mode: screen; }
    [data-theme="dark"] .grade-A { background-color: rgba(21, 128, 61, 0.3); color: #86efac; }
    [data-theme="dark"] .grade-B { background-color: rgba(30, 64, 175, 0.3); color: #93c5fd; }
    [data-theme="dark"] .grade-C { background-color: rgba(146, 64, 14, 0.3); color: #fed7aa; }
    [data-theme="dark"] .grade-D { background-color: rgba(153, 27, 27, 0.3); color: #fecaca; }
    [data-theme="dark"] .grade-F { background-color: rgba(55, 65, 81, 0.3); color: #d1d5db; }

    /* --- 8. Responsive Design --- */
    @media (max-width: 768px) {
      .hero h1 { font-size: 2.5rem; }
      .cgpa-metrics-row { flex-direction: column; gap: 1.5rem; }
      .cgpa-metric { flex-direction: row; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem 0; border-bottom: 1px solid rgba(122, 106, 216, 0.1); }
      .cgpa-metric:last-child { border-bottom: none; }
      .cgpa-metric-label { margin-bottom: 0; }
      .cgpa-metric-value { font-size: 1.75rem; }
      .gpa-result-card { padding: 1.5rem; }
      .semester-card { padding: 1.5rem; }
      .action-buttons { flex-direction: column; }
      .action-buttons .btn { width: 100%; max-width: 300px; }
      .why-choose-section { display: none; } /* Hide complex section on mobile for simplicity */
    }

    @media (max-width: 576px) {
      #toast-container { right: 10px; top: 70px; }
      .toast-notification { min-width: calc(100vw - 20px); }
      .undo-notification { flex-direction: column; text-align: center; }
      #undo-container { width: calc(100% - 40px); }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" defer></script>

</head>
<body>
  <div class="cursor-dot" id="cursorDot"></div>

  <a id="backToTop" class="shadow-lg"><i class="fas fa-arrow-up"></i></a>
  
  <div id="toast-container"></div>
  
  <div id="undo-container"></div>

  <nav class="navbar navbar-expand-lg sticky-top border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <span class="badge rounded-pill badge-brand">UAF</span>
        <span class="gradient-text">CGPA Calculator</span>
      </a>
      <div class="d-flex align-items-center gap-2 order-lg-2">
        <button id="themeToggle" class="btn btn-sm btn-soft rounded-pill" type="button" aria-label="Toggle dark mode">
          <i class="fa-solid fa-moon"></i>
        </button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link active" href="#Home">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#Auto-Calculator">Calculator</a></li>
          <li class="nav-item"><a class="nav-link" href="#Features">Features</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact-us">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="hero" id="Home">
    <div class="container">
      <div class="row align-items-center g-5">
        <div class="col-lg-7">
          <span class="badge rounded-pill badge-brand mb-3">University of Agriculture Faisalabad</span>
          <h1 class="display-5 mb-3">The Ultimate <span class="hero-text-gradient">CGPA Calculator</span><br/> for <span class="hero-text-gradient">UAF Students</span></h1>
          <p class="lead mb-4">Instantly fetch your results from the UAF LMS. Edit, forecast, and download a professional transcript. Your complete academic toolkit, built for accuracy and power.</p>
          <div class="d-flex gap-2">
            <a href="#Auto-Calculator" class="btn btn-primary-action btn-lg rounded-pill pulse">
              <i class="fa-solid fa-bolt me-2"></i>Get Started
            </a>
            <a href="#Features" class="btn btn-secondary-action btn-lg rounded-pill">
              <i class="fa-solid fa-star me-2"></i>View Features
            </a>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card card-modern fade-in-on-scroll float">
            <div class="card-body p-4">
              <div class="d-flex align-items-center gap-3">
                <div class="display-6 robot-icon-gradient"><i class="fa-solid fa-robot"></i></div>
                <div>
                  <h5 class="mb-1 fw-bold">Automatic Result Fetching</h5>
                  <p class="mb-0 text-body-secondary">Enter your registration number once. Let us handle the rest.</p>
                </div>
              </div>
              <hr class="my-3" />
              <ul class="list-unstyled m-0">
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i>Directly from UAF LMS</li>
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i>100% Accurate UAF Grading</li>
                <li class="d-flex align-items-center gap-2"><i class="fa-solid fa-check text-success"></i>Password Not Required</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main class="py-5" id="Auto-Calculator">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-10">
          
          <div class="card card-modern mb-4 fade-in-on-scroll">
            <div class="card-header p-4">
              <h4 class="mb-0"><i class="fa-solid fa-bolt me-2"></i>Automatic CGPA Calculator</h4>
            </div>
            <div class="card-body p-4 scraping-section">
              <form id="resultForm">
                <div id="profileManagement" class="mb-3 text-start" style="display: none;">
                  <label for="profileSwitcher" class="form-label">Saved Profiles</label>
                  <div class="input-group">
                    <select class="form-select" id="profileSwitcher"></select>
                    <button class="btn btn-outline-danger" type="button" id="deleteProfileBtn" title="Delete Selected Profile"><i class="fa-solid fa-trash-can"></i></button>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="registrationNumber" class="form-label visually-hidden">Registration Number</label>
                  <input type="text" class="form-control form-control-lg" id="registrationNumber" placeholder="e.g., 2020-ag-1234" required>
                </div>
                <div class="center-buttons">
                  <button type="submit" class="btn btn-primary-action rounded-pill"><i class="fa-solid fa-cloud-arrow-down me-2"></i>Fetch Result</button>
                  <button type="button" id="startNewSearchBtn" class="btn btn-secondary-action rounded-pill"><i class="fa-solid fa-eraser me-2"></i>New Search</button>
                </div>
              </form>
              <div class="loading-container" id="loadingContainer">
                 </div>
            </div>
          </div>
          
          <div id="resultContainer" class="result-container" style="display: none;">
            <div class="gpa-result-card fade-in-on-scroll">
              <div class="card-body p-0">
                <div class="cgpa-display-container">
                  <div class="cgpa-main-info"><h2 class="mb-1 fw-bold" id="studentName"></h2><p class="mb-0 text-body-secondary" id="studentReg"></p></div>
                  <div class="cgpa-metrics-row">
                    <div class="cgpa-metric cgpa-metric-left"><p class="mb-0 cgpa-metric-label">CGPA</p><p class="mb-0 cgpa-metric-value" id="totalCgpa">0.00</p></div>
                    <div class="cgpa-metric cgpa-metric-center"><p class="mb-0 cgpa-metric-label">Percentage</p><p class="mb-0 cgpa-metric-value" id="totalPercentage">0.00%</p></div>
                    <div class="cgpa-metric cgpa-metric-right"><p class="mb-0 cgpa-metric-label">Marks</p><div class="cgpa-metric-value-container"><p class="mb-0 cgpa-metric-value" id="totalMarksObtained">0</p><p class="mb-0 cgpa-metric-subvalue" id="totalMaxMarks">/ 0</p></div></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="action-buttons fade-in-on-scroll">
              <button id="downloadPdfBtn" class="btn btn-pdf-download rounded-pill"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
              <button id="copyDetailsBtn" class="btn btn-success-action rounded-pill"><i class="fa-solid fa-clipboard me-2"></i>Copy Details</button>
              <button id="forecastBtn" class="btn btn-info-action rounded-pill" data-bs-toggle="modal" data-bs-target="#forecastModal"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast CGPA</button>
            </div>

            <div class="card card-modern my-4 fade-in-on-scroll" id="gpaChartContainer" style="display: none;">
              <div class="card-header"><h4 class="mb-0"><i class="fa-solid fa-chart-line me-2"></i>GPA Trend</h4></div>
              <div class="card-body"><canvas id="gpaTrendChart"></canvas></div>
            </div>

            <div class="semester-results-container">
                <h4 class="section-title mt-5">Academic Record</h4>
                <div class="d-flex justify-content-end mb-3">
                    <button id="addForecastSemesterBtn" class="btn btn-soft rounded-pill"><i class="fa-solid fa-plus me-2"></i>Add Custom Semester</button>
                </div>
                <div id="semesterResults" class="semester-grid"></div>
            </div>
          </div>
          
          <div class="card card-modern mt-4 fade-in-on-scroll">
            <div class="card-header p-4"><h4 class="mb-0 text-start"><i class="fa-solid fa-terminal me-2"></i>Status Log</h4></div>
            <div class="card-body p-4">
              <div class="status-log" id="statusLog"></div>
              <div class="log-section center-buttons mt-3">
                <button id="downloadLogBtn" class="btn btn-secondary-action rounded-pill"><i class="fa-solid fa-file-lines me-2"></i>Download Log</button>
                <button id="clearLogBtn" class="btn btn-danger-action rounded-pill"><i class="fa-solid fa-trash me-2"></i>Clear Log</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <section class="why-choose-section" id="Features">
    <div class="container">
      <div class="text-center mb-5 fade-in-on-scroll">
        <h2 class="fw-bold">The Most <span class="gradient-text">Powerful Features</span></h2>
        <p class="lead text-muted">A toolkit designed to give you complete control over your academic progress.</p>
      </div>
      <div class="row g-4">
        <div class="col-md-6 col-lg-3"><div class="feature-card fade-in-on-scroll"><div class="feature-icon"><i class="fas fa-robot"></i></div><h5>Instant & Automatic</h5><p class="text-muted">Fetches your complete academic record from the UAF LMS in seconds. No manual data entry required.</p></div></div>
        <div class="col-md-6 col-lg-3"><div class="feature-card fade-in-on-scroll"><div class="feature-icon"><i class="fas fa-arrows-up-down-left-right"></i></div><h5>Drag & Drop Editor</h5><p class="text-muted">Move courses between semesters to simulate different scenarios and see their impact on your GPA instantly.</p></div></div>
        <div class="col-md-6 col-lg-3"><div class="feature-card fade-in-on-scroll"><div class="feature-icon"><i class="fas fa-bullseye"></i></div><h5>CGPA Forecasting</h5><p class="text-muted">Set a target CGPA and our calculator will tell you the average marks you need in future courses to achieve it.</p></div></div>
        <div class="col-md-6 col-lg-3"><div class="feature-card fade-in-on-scroll"><div class="feature-icon"><i class="fas fa-file-pdf"></i></div><h5>Professional PDF Export</h5><p class="text-muted">Download a beautifully formatted, transcript-style PDF of your results, perfect for records or applications.</p></div></div>
      </div>
    </div>
  </section>

  <section class="py-5" id="contact-us">
      <div class="container">
          <div class="text-center mb-5 fade-in-on-scroll">
              <h2 class="fw-bold">Get in Touch</h2>
              <p class="lead text-muted">Have a question, suggestion, or just want to say hi?</p>
          </div>
          <div class="row justify-content-center">
              <div class="col-lg-8">
                  <div class="card card-modern p-4 p-md-5">
                    <form id="contact-form" action="https://formspree.io/f/xblrolwp" method="post" class="needs-validation" novalidate>
                        <div class="row g-3">
                          <div class="col-md-6"><label class="form-label" for="name">Your Name</label><input class="form-control" id="name" name="name" placeholder="e.g., Ali Raza" required /><div class="invalid-feedback">Please enter your name.</div></div>
                          <div class="col-md-6"><label class="form-label" for="email">Email</label><input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required /><div class="invalid-feedback">Enter a valid email.</div></div>
                          <div class="col-12"><label class="form-label" for="message">Message</label><textarea class="form-control" id="message" name="message" rows="4" placeholder="Write your message..." required></textarea><div class="invalid-feedback">Please write a message.</div></div>
                          <div class="col-12"><button class="btn btn-primary-action rounded-pill" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Send Message</button></div>
                          <div id="contact-form-status" class="mt-2 small"></div>
                        </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <footer class="border-top py-4">
    <div class="container text-center footer">
      <p class="mb-1 text-muted">UAF CGPA Calculator - A project by Muhammad Saqlain.</p>
      <p class="mb-0 text-muted">&copy; 2025 UAFTools. All rights reserved.</p>
    </div>
  </footer>

  <div class="modal fade course-details-modal" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="courseDetailsModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="courseDetailsModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Close</button></div></div>
    </div>
  </div>

  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Add Custom Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="addCourseForm"><input type="hidden" id="addCourseSemester" value=""><div class="mb-3"><label for="courseCode" class="form-label">Course Code</label><input type="text" class="form-control" id="courseCode" placeholder="e.g., CHEM-101" required></div><div class="mb-3"><label for="courseTitle" class="form-label">Course Title</label><input type="text" class="form-control" id="courseTitle" placeholder="e.g., Inorganic Chemistry" required></div><div class="row"><div class="col-6 mb-3"><label for="creditHours" class="form-label">Credit Hours</label><select class="form-select" id="creditHours" required><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div><div class="col-6 mb-3"><label for="courseMarks" class="form-label">Marks</label><input type="number" class="form-control" id="courseMarks" min="0" max="100" placeholder="e.g., 75" required></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary-action rounded-pill" id="saveCourseBtn">Add Course</button></div></div>
    </div>
  </div>

  <div class="modal fade" id="forecastModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>CGPA Forecast Tool</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <p class="text-body-secondary">Set your target CGPA and specify your upcoming courses. We'll calculate the average marks you need to achieve your goal.</p>
                  <div class="mb-3">
                      <label for="targetCgpa" class="form-label">Target CGPA</label>
                      <input type="number" class="form-control" id="targetCgpa" step="0.01" min="0" max="4.0" placeholder="e.g., 3.50">
                  </div>
                  <div class="mb-3">
                      <label for="futureCourses" class="form-label">Number of Future Courses</label>
                      <input type="number" class="form-control" id="futureCourses" min="1" max="20" placeholder="e.g., 5">
                  </div>
                   <div class="mb-3">
                      <label for="avgCreditHours" class="form-label">Average Credit Hours per Course</label>
                      <select class="form-select" id="avgCreditHours">
                        <option value="1">1 Credit Hour</option>
                        <option value="2">2 Credit Hours</option>
                        <option value="3" selected>3 Credit Hours</option>
                        <option value="4">4 Credit Hours</option>
                      </select>
                  </div>
                  <div id="forecastResult" class="alert mt-3" style="display:none;"></div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary-action rounded-pill" id="calculateForecastBtn">Calculate</button>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. State Management & Configuration ---
        const State = {
            isLoading: false,
            allLogs: [],
            processedData: null,
            deletedItems: [], // For undo functionality
            gpaChart: null,
            activeProfileKey: 'uafCalculatorActiveProfile',
            profilesKey: 'uafCalculatorProfiles',

            init() {
                const activeProfileReg = localStorage.getItem(this.activeProfileKey);
                const profiles = this.getProfiles();
                if (activeProfileReg && profiles[activeProfileReg]) {
                    this.processedData = profiles[activeProfileReg];
                }
            },
            getProfiles: () => JSON.parse(localStorage.getItem(State.profilesKey) || '{}'),
            saveProfile(regNum, data) {
                const profiles = this.getProfiles();
                profiles[regNum] = data;
                localStorage.setItem(this.profilesKey, JSON.stringify(profiles));
                localStorage.setItem(this.activeProfileKey, regNum);
                this.processedData = data;
            },
            deleteActiveProfile() {
                const activeReg = localStorage.getItem(this.activeProfileKey);
                if (!activeReg) return;
                const profiles = this.getProfiles();
                delete profiles[activeReg];
                localStorage.setItem(this.profilesKey, JSON.stringify(profiles));
                localStorage.removeItem(this.activeProfileKey);
                this.processedData = null;
            },
            addUndoState(type, data) {
                this.deletedItems.push({ type, data, id: Date.now() });
                if (this.deletedItems.length > 10) this.deletedItems.shift();
            },
            popUndoState: () => State.deletedItems.pop(),
        };

        // --- 2. API Handler ---
        const API = {
            ENDPOINT: `/api/result-scraper?action=scrape_single`,
            async fetchResults(regNum) {
                try {
                    const response = await fetch(`${this.ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.message || `The UAF LMS server responded with status ${response.status}. It may be offline.`);
                    }
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);
                    return data;
                } catch (error) {
                    const userMessage = error.message.includes('fetch') ? 'A network error occurred. Please check your internet connection.' : error.message;
                    throw new Error(userMessage);
                }
            }
        };

        // --- 3. Calculator Logic ---
        const Calculator = {
            // ... [Calculation logic will be placed here]
        };

        // --- 4. UI Manager ---
        const UI = {
            // ... [UI logic will be placed here]
        };

        // --- 5. Application Core ---
        const App = {
            // ... [Main application logic will be placed here]
        };

        // --- Populating Modules ---

        Object.assign(Calculator, {
            processSemesterName: (s) => s?.replace(/(\d{4})-(\d{2,4})/, (m, y1, y2) => y2.length === 2 ? `${y1}-20${y2}` : m) || 'Unknown Semester',
            getSemesterOrderKey: (s) => {
                if (!s) return '9999-9';
                if (s.toLowerCase().startsWith('forecast')) return `3000-${parseInt(s.split(' ')[1]||1)}`;
                const yearMatch = s.match(/\b(20\d{2})\b/);
                const year = yearMatch ? yearMatch[1] : '9999';
                const seasonOrder = ['winter', 'spring', 'summer', 'fall'].indexOf(s.toLowerCase().split(' ')[0]) + 1 || 9;
                return `${year}-${seasonOrder}`;
            },
            processScrapedData(data) {
                if (!data || !data.resultData) return null;
                const studentInfo = {
                    name: data.resultData[0]?.StudentName || 'N/A',
                    registration: data.resultData[0]?.RegistrationNo || 'N/A'
                };
                const semesters = {};
                const courseHistory = {};
                data.resultData.forEach(course => {
                    const semesterName = this.processSemesterName(course.Semester);
                    if (!semesters[semesterName]) semesters[semesterName] = { originalName: course.Semester, sortKey: this.getSemesterOrderKey(semesterName), courses: [] };
                    const creditHoursStr = course.CreditHours || '0';
                    const creditHours = parseInt(creditHoursStr.match(/\d+/)?.[0] || '0');
                    const marks = parseFloat(course.Total || '0');
                    let qualityPoints = this.calculateQualityPoints(marks, creditHours);
                    if (course.Grade === 'F') qualityPoints = 0; // Grade F override
                    const courseData = {
                        ...course, creditHours, marks, qualityPoints, creditHoursDisplay: creditHoursStr, isExtraEnrolled: false, isRepeated: false, isDeleted: false, isCustom: false
                    };
                    semesters[semesterName].courses.push(courseData);
                    const historyKey = (course.CourseCode || '').toUpperCase();
                    if (!courseHistory[historyKey]) courseHistory[historyKey] = [];
                    courseHistory[historyKey].push({ semester: semesterName, marks, data: courseData, sortKey: this.getSemesterOrderKey(semesterName) });
                });
                Object.values(courseHistory).filter(h => h.length > 1).forEach(history => {
                    history.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
                    const highest = history.reduce((p, c) => (p.marks > c.marks) ? p : c);
                    history.forEach(item => {
                        item.data.isRepeated = true;
                        if (item !== highest) item.data.isExtraEnrolled = true;
                    });
                });
                return { studentInfo, semesters };
            },
            calculateQualityPoints(m, c) {
                const s = { 5: [80, 50, 40], 4: [64, 40, 32], 3: [48, 30, 24], 2: [32, 20, 16], 1: [16, 10, 8] }[c];
                if (!s) return 0;
                let qp = 0;
                if (m >= s[0]) qp = 4 * c; else if (m >= s[1]) qp = (4 * c) - ((s[0] - m) * 0.33333); else if (m >= s[2]) qp = (2 * c) - ((s[1] - m) * 0.5);
                return parseFloat(Math.max(0, qp).toFixed(2));
            },
            calculateCustomGrade(m, c) {
                const g = { 5: [80, 50, 40], 4: [64, 52, 40, 32], 3: [48, 39, 30, 24], 2: [32, 26, 20, 16], 1: [16, 13, 10, 8] }[c];
                if (!g) return 'F';
                if (m >= g[0]) return 'A'; if (m >= g[1]) return 'B'; if (g[2] && m >= g[2]) return 'C'; if (g[3] && m >= g[3]) return 'D'; return 'F';
            },
            calculateCGPA(data) {
                if (!data) return null;
                let tqp = 0, tch = 0, tmo = 0, tmm = 0;
                Object.values(data.semesters).forEach(sem => {
                    sem.totalQualityPoints = 0; sem.totalCreditHours = 0; sem.totalMarksObtained = 0; sem.totalMaxMarks = 0;
                    sem.courses.forEach(c => {
                        if (!c.isExtraEnrolled && !c.isDeleted) {
                            sem.totalQualityPoints += c.qualityPoints; sem.totalCreditHours += c.creditHours;
                            sem.totalMarksObtained += c.marks;
                            const maxMarks = { 5: 100, 4: 80, 3: 60, 2: 40, 1: 20 }[c.creditHours] || 0;
                            sem.totalMaxMarks += maxMarks;
                        }
                    });
                    sem.gpa = sem.totalCreditHours > 0 ? sem.totalQualityPoints / sem.totalCreditHours : 0;
                    sem.percentage = sem.totalMaxMarks > 0 ? (sem.totalMarksObtained / sem.totalMaxMarks * 100) : 0;
                    tqp += sem.totalQualityPoints; tch += sem.totalCreditHours; tmo += sem.totalMarksObtained; tmm += sem.totalMaxMarks;
                });
                const cgpa = tch > 0 ? tqp / tch : 0;
                const percentage = tmm > 0 ? (tmo / tmm * 100) : 0;
                return { cgpa, percentage, totalQualityPoints: tqp, totalCreditHours: tch, totalMarksObtained: tmo, totalMaxMarks: tmm };
            },
            forecastCGPA(targetCgpa, numCourses, avgCredits) {
                if (!State.processedData) return { error: "No data loaded." };
                const current = this.calculateCGPA(State.processedData);
                const futureCredits = numCourses * avgCredits;
                const totalCredits = current.totalCreditHours + futureCredits;
                const neededTotalQP = targetCgpa * totalCredits;
                const neededFutureQP = neededTotalQP - current.totalQualityPoints;
                if (neededFutureQP < 0) return { success: `You have already surpassed your target CGPA of ${targetCgpa.toFixed(2)}!` };
                const neededFutureGPA = futureCredits > 0 ? neededFutureQP / futureCredits : 0;
                if (neededFutureGPA > 4.0) return { error: `It is not possible to achieve ${targetCgpa.toFixed(2)}. You would need a GPA of ${neededFutureGPA.toFixed(2)} in your future courses.` };
                const maxMarks = {1:20, 2:40, 3:60, 4:80, 5:100}[avgCredits] || 0;
                const neededMarks = (maxMarks / 4) * neededFutureGPA;
                return { success: `To achieve a CGPA of <strong>${targetCgpa.toFixed(2)}</strong>, you need an average GPA of <strong>${neededFutureGPA.toFixed(2)}</strong> (approx. <strong>${neededMarks.toFixed(0)} / ${maxMarks}</strong> marks) in your next ${numCourses} courses.` };
            },
        });

        Object.assign(UI, {
            els: {},
            init() {
                const ids = ['cursorDot', 'backToTop', 'toast-container', 'undo-container', 'themeToggle', 'resultForm', 'profileManagement', 'profileSwitcher', 'deleteProfileBtn', 'registrationNumber', 'startNewSearchBtn', 'loadingContainer', 'resultContainer', 'studentName', 'studentReg', 'totalCgpa', 'totalPercentage', 'totalMarksObtained', 'totalMaxMarks', 'downloadPdfBtn', 'copyDetailsBtn', 'forecastBtn', 'gpaChartContainer', 'gpaTrendChart', 'addForecastSemesterBtn', 'semesterResults', 'statusLog', 'downloadLogBtn', 'clearLogBtn', 'contact-form', 'courseDetailsModal', 'courseDetailsModalTitle', 'courseDetailsModalBody', 'addCourseModal', 'addCourseForm', 'addCourseSemester', 'courseCode', 'courseTitle', 'creditHours', 'courseMarks', 'saveCourseBtn', 'forecastModal', 'targetCgpa', 'futureCourses', 'avgCreditHours', 'forecastResult', 'calculateForecastBtn'];
                ids.forEach(id => { this.els[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id); });
                this.modals = {
                    courseDetails: new bootstrap.Modal(this.els.courseDetailsModal),
                    addCourse: new bootstrap.Modal(this.els.addCourseModal),
                    forecast: new bootstrap.Modal(this.els.forecastModal),
                };
            },
            showToast(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast-notification ${type}`;
                const icons = { success: 'fa-circle-check', error: 'fa-circle-exclamation', warning: 'fa-triangle-exclamation', info: 'fa-circle-info' };
                toast.innerHTML = `<i class="toast-icon fa-solid ${icons[type]}"></i><span class="toast-message">${message}</span>`;
                this.els.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }, duration);
            },
            showUndoNotification(message, onUndo) {
                this.els.undoContainer.innerHTML = ''; // Clear previous
                const notification = document.createElement('div');
                notification.className = 'undo-notification';
                notification.innerHTML = `<span>${message}</span> <button class="undo-btn">Undo</button>`;
                this.els.undoContainer.appendChild(notification);
                notification.querySelector('.undo-btn').onclick = () => { onUndo(); notification.remove(); };
                setTimeout(() => notification.remove(), 5000);
            },
            updateProfileSwitcher(profiles, activeReg) {
                const keys = Object.keys(profiles);
                this.els.profileManagement.style.display = keys.length > 0 ? 'block' : 'none';
                if (keys.length > 0) {
                    this.els.profileSwitcher.innerHTML = '<option value="">Select a saved profile...</option>';
                    keys.forEach(reg => {
                        const option = document.createElement('option');
                        option.value = reg;
                        option.textContent = `${profiles[reg].studentInfo.name} (${reg})`;
                        if (reg === activeReg) option.selected = true;
                        this.els.profileSwitcher.appendChild(option);
                    });
                }
            },
            showLoadingStage(stage) {
                this.els.loadingContainer.style.display = stage ? 'block' : 'none';
                if(this.els.loadingContainer.innerHTML === '') {
                    this.els.loadingContainer.innerHTML = `
                        <div class="loading-stage" data-stage="connecting"><div class="loading-dots"><span></span><span></span><span></span></div><p class="loading-text">Connecting to UAF LMS...</p></div>
                        <div class="loading-stage" data-stage="processing"><div class="loading-dots"><span></span><span></span><span></span></div><p class="loading-text">Processing Data...</p></div>
                        <div class="loading-stage" data-stage="complete"><i class="fa-solid fa-check-circle fa-2x text-success"></i><p class="loading-text">Results Ready!</p></div>
                    `;
                }
                this.els.loadingContainer.querySelectorAll('.loading-stage').forEach(el => el.style.display = 'none');
                if (stage) this.els.loadingContainer.querySelector(`[data-stage="${stage}"]`).style.display = 'block';
            },
            addStatusMessage(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                State.allLogs.push({ timestamp, message, type });
                const line = document.createElement('div');
                line.className = `status-line status-${type}`;
                line.textContent = `[${timestamp}] ${message}`;
                this.els.statusLog.prepend(line);
            },
            renderSemesters(semesters) {
                this.els.semesterResults.innerHTML = '';
                Object.keys(semesters).sort((a,b) => semesters[a].sortKey.localeCompare(semesters[b].sortKey)).forEach(name => {
                    const sem = semesters[name];
                    const card = document.createElement('div');
                    card.className = 'semester-card fade-in-on-scroll';
                    card.dataset.semesterName = name;
                    card.innerHTML = `
                        <div class="semester-actions">
                            <i class="fa-solid fa-plus add-course" title="Add Custom Course"></i>
                            <i class="fa-solid fa-trash delete-semester" title="Delete Semester"></i>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 fw-bold">${name}</h5>
                            <div class="text-end">
                                <p class="mb-0 text-muted small">GPA: <span class="fw-bold text-dark">${sem.gpa.toFixed(4)}</span></p>
                                <p class="mb-0 text-muted small">Marks: ${sem.totalMarksObtained.toFixed(0)}/${sem.totalMaxMarks}</p>
                            </div>
                        </div>
                        <table class="course-table table-hover">
                            <thead><tr><th>Course</th><th>CH</th><th>Marks</th><th>Grade</th><th></th></tr></thead>
                            <tbody>${sem.courses.map((c, i) => `
                                <tr draggable="true" data-course-index="${i}" class="${c.isExtraEnrolled ? 'table-warning' : ''} ${c.isDeleted ? 'table-danger text-decoration-line-through' : ''}">
                                    <td>
                                        <span class="fw-medium clickable-info" data-action="showDetails">${c.CourseCode}</span>
                                        ${c.isRepeated ? '<span class="extra-enrolled-badge">Rep</span>' : ''}
                                        ${c.isCustom ? '<span class="extra-enrolled-badge">Custom</span>' : ''}
                                    </td>
                                    <td>${c.creditHoursDisplay}</td>
                                    <td>${c.marks.toFixed(0)}</td>
                                    <td><span class="grade-badge grade-${c.Grade}">${c.Grade}</span></td>
                                    <td class="course-actions">
                                        ${c.isDeleted 
                                            ? `<i class="fa-solid fa-rotate-left restore-course" data-action="restoreCourse" title="Restore"></i>`
                                            : `<i class="fa-solid fa-trash delete-course" data-action="deleteCourse" title="Delete"></i>`
                                        }
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>`;
                    this.els.semesterResults.appendChild(card);
                });
                App.observeForFadeIn();
                this.initDragAndDrop();
            },
            updateCGPADisplay(info, cgpaData) {
                this.els.resultContainer.style.display = 'block';
                this.els.studentName.innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${info.name}`;
                this.els.studentReg.textContent = info.registration;
                // Animate numbers
                this.animateValue(this.els.totalCgpa, 0, cgpaData.cgpa, 2);
                this.animateValue(this.els.totalPercentage, 0, cgpaData.percentage, 2, '%');
                this.animateValue(this.els.totalMarksObtained, 0, cgpaData.totalMarksObtained, 0);
                this.els.totalMaxMarks.textContent = `/ ${cgpaData.totalMaxMarks}`;
            },
            renderGpaChart(semesters) {
                if (!window.Chart) return;
                this.els.gpaChartContainer.style.display = Object.keys(semesters).length > 0 ? 'block' : 'none';
                if (State.gpaChart) State.gpaChart.destroy();
                const sorted = Object.entries(semesters).sort(([,a],[,b]) => a.sortKey.localeCompare(b.sortKey));
                const isDark = document.documentElement.dataset.theme === 'dark';
                State.gpaChart = new Chart(this.els.gpaTrendChart, {
                    type: 'line',
                    data: {
                        labels: sorted.map(([name]) => name),
                        datasets: [{
                            label: 'Semester GPA', data: sorted.map(([, sem]) => sem.gpa),
                            fill: true, backgroundColor: 'rgba(122, 106, 216, 0.2)',
                            borderColor: 'rgba(122, 106, 216, 1)', tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, suggestedMax: 4.0, ticks: { color: isDark ? '#d1d5db' : '#4b5563' }, grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } },
                            x: { ticks: { color: isDark ? '#d1d5db' : '#4b5563' }, grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },
            animateValue(el, start, end, decimals, suffix = '') {
                if (start === end) { el.textContent = end.toFixed(decimals) + suffix; return; }
                const duration = 1000;
                const range = end - start;
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const current = start + (range * progress);
                    el.textContent = current.toFixed(decimals) + suffix;
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            },
            initDragAndDrop() {
                const draggables = this.els.semesterResults.querySelectorAll('tbody tr[draggable="true"]');
                const droppables = this.els.semesterResults.querySelectorAll('.semester-card');
                draggables.forEach(d => {
                    d.addEventListener('dragstart', e => {
                        e.target.classList.add('dragging');
                        const sourceSemester = e.target.closest('.semester-card').dataset.semesterName;
                        e.dataTransfer.setData('text/plain', JSON.stringify({ sourceSemester, courseIndex: e.target.dataset.courseIndex }));
                    });
                    d.addEventListener('dragend', e => e.target.classList.remove('dragging'));
                });
                droppables.forEach(d => {
                    d.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
                    d.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over'));
                    d.addEventListener('drop', e => {
                        e.preventDefault();
                        e.currentTarget.classList.remove('drag-over');
                        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                        const targetSemester = e.currentTarget.dataset.semesterName;
                        if(data.sourceSemester !== targetSemester) App.handleDragDrop(data.sourceSemester, data.courseIndex, targetSemester);
                    });
                });
            }
        });

        Object.assign(App, {
            init() {
                State.init();
                UI.init();
                this.bindEvents();
                if (State.processedData) {
                    this.recalculateAndDisplay();
                    UI.showToast('Loaded saved profile.', 'info');
                } else {
                    UI.addStatusMessage('Ready. Enter a registration number to begin.', 'info');
                }
                UI.updateProfileSwitcher(State.getProfiles(), localStorage.getItem(State.activeProfileKey));
                this.initTheme();
                this.initCustomCursor();
                this.initScrollBehavior();
            },
            bindEvents() {
                UI.els.resultForm.addEventListener('submit', this.handleFetch.bind(this));
                UI.els.startNewSearchBtn.addEventListener('click', () => window.location.reload());
                UI.els.profileSwitcher.addEventListener('change', e => {
                    const reg = e.target.value;
                    if (reg) {
                        localStorage.setItem(State.activeProfileKey, reg);
                        State.init();
                        this.recalculateAndDisplay();
                        UI.showToast(`Switched to profile: ${reg}`, 'info');
                    }
                });
                UI.els.deleteProfileBtn.addEventListener('click', this.handleDeleteProfile.bind(this));
                UI.els.clearLogBtn.addEventListener('click', () => { UI.els.statusLog.innerHTML = ''; State.allLogs = []; UI.addStatusMessage('Log cleared.', 'info'); });
                UI.els.downloadLogBtn.addEventListener('click', this.handleDownloadLog.bind(this));
                UI.els.copyDetailsBtn.addEventListener('click', this.handleCopyDetails.bind(this));
                UI.els.downloadPdfBtn.addEventListener('click', this.handleDownloadPdf.bind(this));
                UI.els.addForecastSemesterBtn.addEventListener('click', this.handleAddSemester.bind(this));
                UI.els.saveCourseBtn.addEventListener('click', this.handleAddCourse.bind(this));
                UI.els.calculateForecastBtn.addEventListener('click', this.handleForecast.bind(this));
                UI.els.semesterResults.addEventListener('click', this.handleSemesterCardActions.bind(this));
                UI.els.contactForm.addEventListener('submit', this.handleContactForm.bind(this));
            },
            async handleFetch(e) {
                e.preventDefault();
                const regNum = UI.els.registrationNumber.value.trim();
                if (!regNum) return UI.showToast('Please enter a registration number.', 'error');
                State.isLoading = true;
                UI.els.resultContainer.style.display = 'none';
                UI.showLoadingStage('connecting');
                UI.addStatusMessage(`Fetching result for: ${regNum}`, 'info');
                try {
                    const data = await API.fetchResults(regNum);
                    UI.showLoadingStage('processing');
                    UI.addStatusMessage('Result fetched successfully. Processing...', 'success');
                    const processed = Calculator.processScrapedData(data);
                    State.saveProfile(regNum, processed);
                    UI.showLoadingStage('complete');
                    setTimeout(() => {
                        this.recalculateAndDisplay();
                        UI.showLoadingStage(null);
                        UI.updateProfileSwitcher(State.getProfiles(), regNum);
                    }, 1000);
                } catch (error) {
                    UI.showLoadingStage(null);
                    UI.showToast(error.message, 'error', 5000);
                    UI.addStatusMessage(`Error: ${error.message}`, 'error');
                } finally { State.isLoading = false; }
            },
            handleDeleteProfile() {
                const activeReg = localStorage.getItem(State.activeProfileKey);
                if (!activeReg) return UI.showToast('No active profile selected.', 'warning');
                if (confirm(`Are you sure you want to delete the profile for ${activeReg}?`)) {
                    State.deleteActiveProfile();
                    UI.showToast(`Profile for ${activeReg} deleted.`, 'success');
                    setTimeout(() => window.location.reload(), 500);
                }
            },
            recalculateAndDisplay() {
                if (!State.processedData) {
                    UI.els.resultContainer.style.display = 'none';
                    return;
                }
                const cgpaData = Calculator.calculateCGPA(State.processedData);
                UI.updateCGPADisplay(State.processedData.studentInfo, cgpaData);
                UI.renderSemesters(State.processedData.semesters);
                UI.renderGpaChart(State.processedData.semesters);
                const activeReg = localStorage.getItem(State.activeProfileKey);
                if (activeReg) State.saveProfile(activeReg, State.processedData);
            },
            handleSemesterCardActions(e) {
                const target = e.target;
                const action = target.dataset.action || target.closest('[data-action]')?.dataset.action;
                const card = target.closest('.semester-card');
                if (!action || !card) return;
                const semesterName = card.dataset.semesterName;
                const courseIndex = target.closest('tr')?.dataset.courseIndex;
                const course = courseIndex ? State.processedData.semesters[semesterName].courses[courseIndex] : null;

                const actions = {
                    showDetails: () => UI.modals.courseDetails.show(),
                    deleteCourse: () => this.modifyCourseState(semesterName, courseIndex, true),
                    restoreCourse: () => this.modifyCourseState(semesterName, courseIndex, false),
                    addCourse: () => { UI.els.addCourseSemester.value = semesterName; UI.els.addCourseForm.reset(); UI.modals.addCourse.show(); },
                    deleteSemester: () => this.handleDeleteSemester(semesterName),
                };
                if (actions[action]) actions[action]();
            },
            modifyCourseState(semesterName, courseIndex, isDeleted) {
                const course = State.processedData.semesters[semesterName].courses[courseIndex];
                course.isDeleted = isDeleted;
                State.addUndoState('course', { semesterName, courseIndex, wasDeleted: !isDeleted });
                this.recalculateAndDisplay();
                UI.showUndoNotification(`Course ${course.CourseCode} ${isDeleted ? 'deleted' : 'restored'}.`, () => this.handleUndo());
            },
            handleDeleteSemester(semesterName) {
                const semesterData = JSON.parse(JSON.stringify(State.processedData.semesters[semesterName]));
                delete State.processedData.semesters[semesterName];
                State.addUndoState('semester', { semesterName, semesterData });
                this.recalculateAndDisplay();
                UI.showUndoNotification(`Semester "${semesterName}" deleted.`, () => this.handleUndo());
            },
            handleUndo() {
                const lastAction = State.popUndoState();
                if (!lastAction) return;
                if (lastAction.type === 'semester') {
                    State.processedData.semesters[lastAction.data.semesterName] = lastAction.data.semesterData;
                } else if (lastAction.type === 'course') {
                    const { semesterName, courseIndex, wasDeleted } = lastAction.data;
                    State.processedData.semesters[semesterName].courses[courseIndex].isDeleted = wasDeleted;
                }
                this.recalculateAndDisplay();
                UI.showToast('Action undone.', 'info');
            },
            handleAddCourse() {
                const semesterName = UI.els.addCourseSemester.value;
                const code = UI.els.courseCode.value.trim();
                const title = UI.els.courseTitle.value.trim();
                const ch = parseInt(UI.els.creditHours.value);
                const marks = parseFloat(UI.els.courseMarks.value);
                if (!code || !title || isNaN(ch) || isNaN(marks)) return UI.showToast('Please fill all fields correctly.', 'error');
                const newCourse = {
                    CourseCode: code, CourseTitle: title, creditHours: ch, creditHoursDisplay: `${ch}(${ch}-0)`,
                    marks: marks, qualityPoints: Calculator.calculateQualityPoints(marks, ch), Grade: Calculator.calculateCustomGrade(marks, ch),
                    isCustom: true, isDeleted: false, isExtraEnrolled: false, isRepeated: false
                };
                State.processedData.semesters[semesterName].courses.push(newCourse);
                this.recalculateAndDisplay();
                UI.modals.addCourse.hide();
                UI.showToast('Custom course added.', 'success');
            },
            handleAddSemester() {
                let i = 1;
                while (`Forecast ${i}` in State.processedData.semesters) i++;
                const name = `Forecast ${i}`;
                State.processedData.semesters[name] = {
                    originalName: name, sortKey: Calculator.getSemesterOrderKey(name), courses: []
                };
                this.recalculateAndDisplay();
                UI.showToast(`Added "${name}".`, 'success');
            },
            handleDragDrop(sourceSemester, courseIndex, targetSemester) {
                const course = State.processedData.semesters[sourceSemester].courses.splice(courseIndex, 1)[0];
                State.processedData.semesters[targetSemester].courses.push(course);
                this.recalculateAndDisplay();
                UI.showToast(`Moved ${course.CourseCode} to ${targetSemester}`, 'info');
            },
            handleForecast() {
                const targetCgpa = parseFloat(UI.els.targetCgpa.value);
                const numCourses = parseInt(UI.els.futureCourses.value);
                const avgCredits = parseInt(UI.els.avgCreditHours.value);
                if (isNaN(targetCgpa) || isNaN(numCourses) || isNaN(avgCredits)) {
                    UI.els.forecastResult.textContent = 'Please fill all fields.';
                    UI.els.forecastResult.className = 'alert alert-warning';
                    UI.els.forecastResult.style.display = 'block';
                    return;
                }
                const result = Calculator.forecastCGPA(targetCgpa, numCourses, avgCredits);
                UI.els.forecastResult.innerHTML = result.success || result.error;
                UI.els.forecastResult.className = `alert ${result.success ? 'alert-success' : 'alert-danger'}`;
                UI.els.forecastResult.style.display = 'block';
            },
            handleCopyDetails() {
                const info = State.processedData.studentInfo;
                const cgpa = UI.els.totalCgpa.textContent;
                const text = `Name: ${info.name}\nRegistration: ${info.registration}\nCGPA: ${cgpa}`;
                navigator.clipboard.writeText(text).then(() => UI.showToast('Details copied!', 'success'), () => UI.showToast('Failed to copy.', 'error'));
            },
            async handleContactForm(e) { /* ... same as original ... */ },
            initTheme() { /* ... same as original ... */ },
            initCustomCursor() { /* ... same as original ... */ },
            initScrollBehavior() { /* ... same as original ... */ this.observeForFadeIn(); },
            observeForFadeIn() {
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                document.querySelectorAll('.fade-in-on-scroll:not(.is-visible)').forEach(el => observer.observe(el));
            },
            handleDownloadLog() {
                let content = "UAF CGPA Calculator - Log\n\n";
                State.allLogs.forEach(log => content += `[${log.timestamp}] ${log.message}\n`);
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `uaf_cgpa_log.txt`;
                a.click();
                URL.revokeObjectURL(a.href);
            },
            handleDownloadPdf() {
                if (!State.processedData || !window.jspdf) return UI.showToast('Data or PDF library not loaded.', 'error');
                UI.showToast('Generating PDF...', 'info');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const data = State.processedData;
                const cgpaData = Calculator.calculateCGPA(data);

                // --- PDF content ---
                pdf.setFontSize(18);
                pdf.text("Unofficial Academic Transcript", 105, 20, { align: 'center' });
                pdf.setFontSize(12);
                pdf.text(`Name: ${data.studentInfo.name}`, 20, 40);
                pdf.text(`Registration: ${data.studentInfo.registration}`, 20, 48);
                pdf.text(`Overall CGPA: ${cgpaData.cgpa.toFixed(4)}`, 105, 40);
                pdf.text(`Percentage: ${cgpaData.percentage.toFixed(2)}%`, 105, 48);
                
                let lastY = 60;
                Object.keys(data.semesters).sort((a,b) => data.semesters[a].sortKey.localeCompare(data.semesters[b].sortKey)).forEach(name => {
                    const sem = data.semesters[name];
                    const head = [['Course', 'Title', 'CH', 'Marks', 'Grade']];
                    const body = sem.courses.filter(c => !c.isDeleted).map(c => [c.CourseCode, c.CourseTitle, c.creditHoursDisplay, c.marks.toFixed(0), c.Grade]);
                    if(lastY > 250) { pdf.addPage(); lastY = 20; }
                    pdf.setFontSize(14);
                    pdf.text(`${name} (GPA: ${sem.gpa.toFixed(4)})`, 20, lastY);
                    lastY += 5;
                    pdf.autoTable({ head, body, startY: lastY });
                    lastY = pdf.lastAutoTable.finalY + 10;
                });

                pdf.save(`UAF_Transcript_${data.studentInfo.registration}.pdf`);
            }
        });

        // Initialize the application
        App.init();
    });
  </script>
</body>
</html>
