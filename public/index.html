<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UAF CGPA Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <style>
    :root {
      --brand: #7a6ad8;
      --brand-600: #6b5fca;
      --brand-700: #5d52b8;
      --text: #1b1f24;
      --muted: #6b7280;
      --radius: 1.25rem;
    }
    
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(180deg, #f8f9ff 0%, #ffffff 70%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    .navbar {
      backdrop-filter: saturate(180%) blur(12px);
      background-color: rgba(255, 255, 255, 0.7);
    }
    
    .navbar-brand {
      font-weight: 800;
      letter-spacing: 0.3px;
      color: var(--brand);
    }
    
    .btn-primary-action {
      background: linear-gradient(180deg, var(--brand), var(--brand-700));
      color: #fff;
      border: 0;
      box-shadow: 0 6px 18px rgba(122, 106, 216, 0.12);
    }
    
    .btn-primary-action:hover {
      background: linear-gradient(180deg, var(--brand-600), var(--brand-700));
      color: #fff;
      transform: translateY(-2px);
    }
    
    .card-modern {
      border: 0;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
    }
    
    .card-modern .card-header {
      border: 0;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      background: linear-gradient(180deg, rgba(122, 106, 216, 0.15), rgba(122, 106, 216, 0.05));
    }
    
    .status-log {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    
    .status-line {
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e9ecef;
    }
    
    .status-success { color: #28a745; }
    .status-error { color: #dc3545; }
    .status-warning { color: #fd7e14; }
    .status-info { color: var(--brand); }
    
    .semester-card {
      background: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .course-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    .course-table th, .course-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .extra-enrolled {
      background-color: #fff3cd;
      color: #856404;
      padding: 0.15rem 0.35rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }
    
    @media (max-width: 768px) {
      .course-table {
        font-size: 11.5px;
      }
      
      .mobile-course-code {
        display: block;
      }
      
      .mobile-repeated {
        display: block;
        margin-top: 0.25rem;
      }
    }
    
    .section-title {
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(122, 106, 216, 0.2);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="badge rounded-pill bg-primary">UAF</span>
        <span>CGPA <span class="text-body-secondary">Calculator</span></span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Manual Calculator</a></li>
          <li class="nav-item"><a class="nav-link" href="#">UAF Results</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact-us">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-5">
    <!-- Input Section -->
    <div class="card card-modern mb-4">
      <div class="card-header p-4">
        <h4 class="mb-0"><i class="fa-solid fa-bolt me-2"></i>UAF CGPA Calculator</h4>
      </div>
      <div class="card-body p-4">
        <form id="resultForm">
          <div class="mb-3">
            <label for="registrationNumber" class="form-label">Registration Number</label>
            <input type="text" class="form-control" id="registrationNumber" placeholder="e.g., 2020-ag-1234" required>
            <div class="form-text">Enter your UAF registration number</div>
          </div>
          <div class="d-flex justify-content-center gap-2">
            <button type="submit" class="btn btn-primary-action rounded-pill">
              <i class="fa-solid fa-cloud-arrow-down me-2"></i>Fetch Result
            </button>
            <button id="testConnectionBtn" type="button" class="btn btn-outline-primary rounded-pill">
              <i class="fa-solid fa-vial me-2"></i>Test Connection
            </button>
          </div>
        </form>
        
        <div class="progress-container mt-4">
          <div class="d-flex justify-content-between mb-2">
            <span>Status: <strong id="currentStatus">Ready</strong></span>
            <span><strong id="progressPercentage">0%</strong></span>
          </div>
          <div class="progress">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        
        <div id="loading" class="text-center mt-4" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Fetching your result from UAF LMS...</p>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultContainer" class="d-none">
      <!-- Student Info -->
      <div class="card card-modern mb-4">
        <div class="card-header p-4">
          <h4 class="mb-0"><i class="fa-solid fa-user-graduate me-2"></i>Student Information</h4>
        </div>
        <div class="card-body p-4">
          <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div>
              <h2 class="mb-1 fw-bold" id="studentName">Student Name</h2>
              <p class="mb-0 text-body-secondary" id="studentReg">Registration Number</p>
            </div>
            <div class="text-end mt-3 mt-md-0">
              <p class="mb-0 text-body-secondary">Total CGPA</p>
              <p class="mb-0 display-6 fw-bold text-primary" id="totalCgpa">0.00</p>
              <p class="mb-0 text-body-secondary" id="totalPercentage">0%</p>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="calculateCgpaBtn" class="btn btn-success rounded-pill">
              <i class="fa-solid fa-calculator me-2"></i>Calculate CGPA Now
            </button>
            <button id="saveToWebBtn" class="btn btn-primary rounded-pill">
              <i class="fa-solid fa-cloud-arrow-up me-2"></i>Save to Web
            </button>
          </div>
        </div>
      </div>

      <!-- Semester Results -->
      <div class="card card-modern mb-4">
        <div class="card-header p-4">
          <h4 class="mb-0"><i class="fa-solid fa-book-open me-2"></i>Semester Results</h4>
        </div>
        <div class="card-body p-4">
          <div id="semesterResults" class="row">
            <!-- Semester cards will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Status Log Section -->
    <div class="card card-modern">
      <div class="card-header p-4">
        <h4 class="mb-0"><i class="fa-solid fa-terminal me-2"></i>Status Log</h4>
      </div>
      <div class="card-body p-4">
        <div class="status-log" id="statusLog">
          <div class="status-line status-info">Ready to fetch your results. Enter your registration number and click "Fetch Result".</div>
        </div>
        <div class="d-flex justify-content-center gap-2 mt-3">
          <button id="downloadLogBtn" class="btn btn-outline-secondary rounded-pill">
            <i class="fa-solid fa-file-lines me-2"></i>Download Log
          </button>
          <button id="clearLogBtn" class="btn btn-outline-danger rounded-pill">
            <i class="fa-solid fa-trash me-2"></i>Clear Log
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap & jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const resultForm = document.getElementById('resultForm');
      const registrationNumber = document.getElementById('registrationNumber');
      const loading = document.getElementById('loading');
      const resultContainer = document.getElementById('resultContainer');
      const testConnectionBtn = document.getElementById('testConnectionBtn');
      const statusLog = document.getElementById('statusLog');
      const progressBar = document.getElementById('progressBar');
      const progressPercentage = document.getElementById('progressPercentage');
      const currentStatus = document.getElementById('currentStatus');
      const downloadLogBtn = document.getElementById('downloadLogBtn');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const semesterResults = document.getElementById('semesterResults');
      const studentName = document.getElementById('studentName');
      const studentReg = document.getElementById('studentReg');
      const totalCgpa = document.getElementById('totalCgpa');
      const totalPercentage = document.getElementById('totalPercentage');
      const calculateCgpaBtn = document.getElementById('calculateCgpaBtn');
      const saveToWebBtn = document.getElementById('saveToWebBtn');
      
      // State variables
      let allLogs = [];
      let testInProgress = false;
      let processedData = null;
      
      // Add a status message to the log
      function addStatusMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const fullMessage = `[${timestamp}] ${message}`;
        
        // Add to all logs array
        allLogs.push({timestamp, message, type});
        
        const messageEl = document.createElement('div');
        messageEl.className = `status-line status-${type}`;
        messageEl.textContent = fullMessage;
        statusLog.prepend(messageEl);
      }
      
      // Update progress bar
      function updateProgress(percent, status) {
        progressBar.style.width = `${percent}%`;
        progressPercentage.textContent = `${percent}%`;
        if (status) {
          currentStatus.textContent = status;
        }
      }
      
      // Show toast notification
      function showToast(message, type = 'success') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        
        document.body.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it hides
        toast.addEventListener('hidden.bs.toast', function() {
          document.body.removeChild(toast);
        });
      }
      
      // Test connection
      async function testConnection() {
        if (testInProgress) {
          addStatusMessage('Test connection already in progress', 'info');
          return;
        }
        
        testInProgress = true;
        testConnectionBtn.disabled = true;
        
        addStatusMessage('Testing connection to UAF LMS server...', 'info');
        updateProgress(30, 'Testing Connection');
        
        try {
          // Simulate API call
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          // Randomly determine success for demo purposes
          const success = Math.random() > 0.3;
          
          if (success) {
            addStatusMessage('Connection test successful - UAF LMS is accessible', 'success');
            showToast('Connection test successful!', 'success');
            updateProgress(100, 'Connection Successful');
          } else {
            addStatusMessage('Connection test failed: UAF LMS not responding', 'error');
            showToast('Connection test failed!', 'danger');
            updateProgress(100, 'Connection Failed');
          }
        } catch (error) {
          addStatusMessage(`Connection test failed: ${error.message}`, 'error');
          showToast('Connection test failed!', 'danger');
          updateProgress(100, 'Connection Failed');
        } finally {
          testInProgress = false;
          testConnectionBtn.disabled = false;
          
          // Reset progress after a delay
          setTimeout(() => {
            updateProgress(0, 'Ready');
          }, 2000);
        }
      }
      
      // Process scraped data to handle re-enrolled courses
      function processScrapedData(data) {
        // For demo purposes, create sample data
        return {
          studentInfo: {
            name: "Muhammad Ahmed",
            registration: registrationNumber.value.trim() || "2020-ag-1234"
          },
          semesters: {
            "Fall 2023": {
              courses: [
                {
                  code: "CS-101",
                  title: "Introduction to Programming",
                  creditHours: 3,
                  marks: 85,
                  qualityPoints: 12,
                  grade: "A",
                  isExtraEnrolled: false,
                  isRepeated: false
                },
                {
                  code: "MTH-101",
                  title: "Calculus I",
                  creditHours: 3,
                  marks: 78,
                  qualityPoints: 10.5,
                  grade: "B+",
                  isExtraEnrolled: false,
                  isRepeated: false
                }
              ],
              gpa: 3.75,
              percentage: 85.5
            },
            "Spring 2024": {
              courses: [
                {
                  code: "CS-201",
                  title: "Data Structures",
                  creditHours: 4,
                  marks: 92,
                  qualityPoints: 16,
                  grade: "A",
                  isExtraEnrolled: false,
                  isRepeated: false
                },
                {
                  code: "CS-101",
                  title: "Introduction to Programming",
                  creditHours: 3,
                  marks: 90,
                  qualityPoints: 12,
                  grade: "A",
                  isExtraEnrolled: true,
                  isRepeated: true
                },
                {
                  code: "MTH-202",
                  title: "Calculus II",
                  creditHours: 3,
                  marks: 75,
                  qualityPoints: 9.5,
                  grade: "B",
                  isExtraEnrolled: false,
                  isRepeated: false
                }
              ],
              gpa: 3.9,
              percentage: 89.2
            }
          }
        };
      }
      
      // Calculate CGPA from processed data
      function calculateCGPA(processedData) {
        // For demo purposes, return fixed values
        return {
          cgpa: 3.82,
          percentage: 87.3
        };
      }
      
      // Display CGPA results
      function displayCGPAResults(processedData, cgpaData) {
        // Update student info
        studentName.textContent = processedData.studentInfo.name;
        studentReg.textContent = processedData.studentInfo.registration;
        
        // Update overall CGPA
        totalCgpa.textContent = cgpaData.cgpa.toFixed(2);
        totalPercentage.textContent = `${cgpaData.percentage.toFixed(1)}%`;
        
        // Clear previous semester results
        semesterResults.innerHTML = '';
        
        // Create semester cards
        Object.keys(processedData.semesters).forEach(semesterName => {
          const semester = processedData.semesters[semesterName];
          
          const semesterCard = document.createElement('div');
          semesterCard.className = 'col-md-6 mb-3';
          semesterCard.innerHTML = `
            <div class="semester-card">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0">
                  <i class="fa-solid fa-book-open me-2 text-primary"></i>
                  ${semesterName}
                </h5>
                <div class="text-end">
                  <p class="mb-0 text-body-secondary small">GPA:</p>
                  <p class="mb-0 h4 fw-bold text-primary">${semester.gpa.toFixed(2)}</p>
                  <p class="mb-0 text-body-secondary small">${semester.percentage.toFixed(1)}%</p>
                </div>
              </div>
              <div class="table-responsive">
                <table class="course-table">
                  <thead>
                    <tr>
                      <th>Course</th>
                      <th>Hrs</th>
                      <th>Marks</th>
                      <th>Grade</th>
                      <th>GP</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${semester.courses.map(course => `
                      <tr class="${course.isExtraEnrolled ? 'table-warning' : ''}">
                        <td>
                          <span class="fw-medium mobile-course-code">${course.code}</span>
                          ${course.isExtraEnrolled ? '<span class="mobile-repeated extra-enrolled">Reptd.</span>' : ''}
                          <div class="text-muted small">${course.title}</div>
                        </td>
                        <td>${course.creditHours}</td>
                        <td>${course.marks}</td>
                        <td>
                          <span class="badge bg-success">${course.grade}</span>
                        </td>
                        <td class="fw-medium text-primary">${course.qualityPoints.toFixed(1)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
          
          semesterResults.appendChild(semesterCard);
        });
        
        // Show result container
        resultContainer.classList.remove('d-none');
        calculateCgpaBtn.style.display = 'block';
        saveToWebBtn.style.display = 'block';
      }
      
      // Fetch result from UAF LMS
      async function fetchResult() {
        const regNum = registrationNumber.value.trim();
        
        if (!regNum) {
          showToast('Please enter a registration number', 'warning');
          return;
        }
        
        // Show loading animation
        loading.style.display = 'block';
        resultContainer.classList.add('d-none');
        calculateCgpaBtn.style.display = 'none';
        saveToWebBtn.style.display = 'none';
        updateProgress(10, 'Starting Fetch');
        addStatusMessage(`Fetching result for registration number: ${regNum}`, 'info');
        
        try {
          // Simulate API call delay
          await new Promise(resolve => setTimeout(resolve, 2500));
          
          // Process the scraped data
          processedData = processScrapedData();
          
          if (processedData) {
            // Calculate CGPA
            const cgpaData = calculateCGPA(processedData);
            
            // Display the result
            displayCGPAResults(processedData, cgpaData);
            
            addStatusMessage('CGPA calculated successfully', 'success');
            updateProgress(100, 'Fetch Complete');
            showToast('Result fetched successfully!', 'success');
          } else {
            addStatusMessage('Error processing result data', 'error');
            showToast('Error processing result data', 'danger');
            updateProgress(100, 'Error');
          }
        } catch (error) {
          addStatusMessage(`Error fetching result: ${error.message}`, 'error');
          showToast('Error fetching result', 'danger');
          updateProgress(100, 'Error');
        } finally {
          loading.style.display = 'none';
          
          // Reset progress after a delay
          setTimeout(() => {
            updateProgress(0, 'Ready');
          }, 2000);
        }
      }
      
      // Save result to web storage
      async function saveToWeb() {
        if (!processedData) {
          showToast('No data to save', 'warning');
          return;
        }
        
        addStatusMessage('Saving result to web storage...', 'info');
        updateProgress(30, 'Saving Data');
        
        try {
          // Simulate API call
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          addStatusMessage('Result saved successfully to web storage', 'success');
          updateProgress(100, 'Save Complete');
          showToast('Result saved successfully!', 'success');
        } catch (error) {
          addStatusMessage(`Error saving result: ${error.message}`, 'error');
          updateProgress(100, 'Error');
          showToast('Error saving result', 'danger');
        }
      }
      
      // Download log
      function downloadLog() {
        addStatusMessage('Preparing log file for download...', 'info');
        
        // Create log content
        let logContent = "UAF CGPA Calculator - Activity Log\n";
        logContent += "============================================\n\n";
        
        allLogs.forEach(log => {
          logContent += `[${log.timestamp}] ${log.message}\n`;
        });
        
        // Create download link
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cgpa_calculator_log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        addStatusMessage('Log file downloaded successfully', 'success');
        showToast('Log file downloaded!', 'success');
      }
      
      // Clear log
      function clearLog() {
        statusLog.innerHTML = '';
        allLogs = [];
        addStatusMessage('Log cleared', 'info');
        showToast('Log cleared', 'info');
      }
      
      // Event listeners
      resultForm.addEventListener('submit', function(e) {
        e.preventDefault();
        fetchResult();
      });
      
      testConnectionBtn.addEventListener('click', testConnection);
      downloadLogBtn.addEventListener('click', downloadLog);
      clearLogBtn.addEventListener('click', clearLog);
      calculateCgpaBtn.addEventListener('click', function() {
        if (processedData) {
          const cgpaData = calculateCGPA(processedData);
          totalCgpa.textContent = cgpaData.cgpa.toFixed(2);
          totalPercentage.textContent = `${cgpaData.percentage.toFixed(1)}%`;
          showToast('CGPA recalculated successfully!', 'success');
          addStatusMessage('CGPA recalculated based on current semesters', 'info');
        }
      });
      
      saveToWebBtn.addEventListener('click', saveToWeb);
    });
  </script>
</body>
</html>
