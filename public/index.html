<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>UAF CGPA Calculator | Automatic & Accurate | University of Agriculture Faisalabad</title>
  
  <meta name="description" content="The best UAF CGPA Calculator. Automatically fetches results from the UAF LMS, visualizes your progress with charts, and helps you forecast your future CGPA." />
  <meta name="keywords" content="uaf cgpa calculator, gpa forecast, uaf results chart, university of agriculture faisalabad, uaf lms results, uaf gpa calculator, uaf percentage calculator, calculate cgpa uaf" />
  <meta name="author" content="Muhammad Saqlain" />
  
  <link rel="canonical" href="https://uafcgpacalculator.vercel.app" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="og:title" content="UAF CGPA Calculator | Automatic, Visual & Predictive" />
  <meta property="og:description" content="The best UAF CGPA Calculator. Automatically fetches results, visualizes your GPA trends, and lets you forecast your future CGPA." />
  <meta property="og:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta property="og:site_name" content="UAF CGPA Calculator" />

  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="twitter:title" content="UAF CGPA Calculator | Automatic, Visual & Predictive" />
  <meta property="twitter:description" content="The best UAF CGPA Calculator. Automatically fetches results, visualizes your GPA trends, and lets you forecast your future CGPA." />
  <meta property="twitter:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "UAF CGPA Calculator",
    "url": "https://uafcgpacalculator.vercel.app/",
    "applicationCategory": "EducationalApplication",
    "description": "An automatic CGPA calculator for students of the University of Agriculture Faisalabad (UAF) that fetches results directly from the university's LMS, visualizes GPA trends, and allows for forecasting.",
    "operatingSystem": "All",
    "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "PKR" },
    "creator": { "@type": "Person", "name": "Muhammad Saqlain" },
    "mainEntity": {
      "@type": "FAQPage",
      "mainEntity": [
        { "@type": "Question", "name": "How does the UAF CGPA Calculator work?", "acceptedAnswer": { "@type": "Answer", "text": "The UAF CGPA Calculator securely connects to the public UAF LMS portal using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA)." } },
        { "@type": "Question", "name": "Is it safe to use my registration number?", "acceptedAnswer": { "@type": "Answer", "text": "Yes, it is completely safe. The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private." } },
        { "@type": "Question", "name": "Can I use this calculator for other universities?", "acceptedAnswer": { "@type": "Answer", "text": "This calculator is specifically designed for the students of the University of Agriculture, Faisalabad (UAF). It uses UAF's unique grading system and connects directly to the UAF LMS, so it will not work for other universities." } }
      ]
    }
  }
  </script>
  
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <style>
    :root {
      --brand: #7a6ad8; --brand-600: #6b5fca; --brand-700: #5d52b8;
      --brand-gradient: linear-gradient(135deg, #7a6ad8 0%, #6b5fca 50%, #5d52b8 100%);
      --brand-gradient-hover: linear-gradient(135deg, #8a7ce8 0%, #7b6fda 50%, #6d62c8 100%);
      --accent: #ff6b6b; --accent-gradient: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      --text: #1b1f24; --text-light: #4b5563; --muted: #6b7280;
      --light-bg: #f8f9ff; --card-bg: #ffffff; --radius: 1.25rem;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.1);
      --shadow-hover: 0 15px 40px rgba(17, 24, 39, 0.15);
      --brand-primary: #7a6ad8; --brand-secondary: #6b5fca;
    }
    html, body {
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      scroll-behavior: smooth;
    }
    body { background-color: var(--light-bg); min-height: 100vh; margin: 0; padding: 0; color: var(--text); }
    .navbar { backdrop-filter: saturate(180%) blur(12px); background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
    .navbar .navbar-brand { font-weight: 800; letter-spacing: .3px; color: var(--brand); transition: all 0.3s ease; }
    .navbar .navbar-brand:hover { transform: translateY(-1px); }
    .navbar .nav-link { position: relative; font-weight: 500; transition: all 0.3s ease; color: var(--text); }
    .navbar .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--brand-gradient); transition: width 0.3s ease; }
    .navbar .nav-link:hover::after { width: 100%; }
    .btn-brand { background: var(--brand-gradient); border: none; color: white; transition: all 0.3s ease; box-shadow: var(--shadow); }
    .btn-brand:hover { background: var(--brand-gradient-hover); transform: translateY(-2px); box-shadow: var(--shadow-hover); color: white; }
    .btn-soft { background: rgba(122, 106, 216, 0.1); color: var(--brand); transition: all 0.3s ease; }
    .btn-soft:hover { background: rgba(122, 106, 216, 0.2); transform: translateY(-1px); }
    .badge-brand { background: var(--brand-gradient); color: white; }
    .btn-primary-action { background: var(--brand-gradient); color: #fff; border: 0; box-shadow: 0 6px 18px rgba(122, 106, 216, 0.2); cursor: pointer; transition: all 0.3s ease; }
    .btn-primary-action:hover { background: var(--brand-gradient-hover); color: #fff; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(122, 106, 216, 0.3); }
    .btn-secondary-action { background: #fff; color: var(--brand); border: 1px solid rgba(122, 106, 216, 0.15); cursor: pointer; transition: all 0.3s ease; }
    .btn-secondary-action:hover { background: #f8f9ff; color: var(--brand); transform: translateY(-1px); box-shadow: 0 5px 15px rgba(122, 106, 216, 0.1); }
    .btn-danger-action { background: var(--accent-gradient); color: white; border: 0; cursor: pointer; transition: all 0.3s ease; }
    .btn-danger-action:hover { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; transform: translateY(-2px); }
    .btn-success-action { background: linear-gradient(135deg, #10ac84 0%, #0d916b 100%); color: white; border: 0; cursor: pointer; transition: all 0.3s ease; }
    .btn-success-action:hover { background: linear-gradient(135deg, #12c29a 0%, #0fa57c 100%); color: white; transform: translateY(-2px); }
    .hero { padding: 5rem 0 4rem; position: relative; overflow: hidden; }
    .hero::before, .hero::after { content: ''; position: absolute; border-radius: 50%; z-index: -1; }
    .hero::before { top: -100px; right: -100px; width: 300px; height: 300px; background: rgba(122, 106, 216, 0.1); }
    .hero::after { bottom: -50px; left: -50px; width: 200px; height: 200px; background: rgba(255, 107, 107, 0.1); }
    .hero h1 { font-weight: 800; line-height: 1.05; font-size: 3.5rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--brand) 0%, var(--text) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero .lead { color: var(--text-light); font-size: 1.25rem; margin-bottom: 2rem; }
    .mt-3 { margin-top: 1rem !important; display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }
    .card-modern { border: 0; border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.8); transition: all 0.3s ease; overflow: hidden; color: var(--text); }
    .card-modern:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
    .card-modern .card-header { border: 0; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1)); padding: 1.5rem 2rem; }
    .card-modern .card-header h4 { font-weight: 700; color: var(--text); text-align: center; }
    .form-select, .form-control { border-radius: .85rem; border: 1px solid rgba(122, 106, 216, 0.2); padding: 0.75rem 1rem; transition: all 0.3s ease; color: var(--text); background-color: rgba(255, 255, 255, 0.9); }
    .form-select:focus, .form-control:focus { border-color: var(--brand); box-shadow: 0 0 0 0.25rem rgba(122, 106, 216, 0.25); }
    label { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; }
    .loading-container { margin-top: 1.5rem; text-align: center; padding: 3rem 2rem; border-radius: var(--radius); background: linear-gradient(135deg, rgba(122, 106, 216, 0.1), rgba(122, 106, 216, 0.05)); display: none; backdrop-filter: blur(10px); }
    .loading-stage { display: none; }
    .loading-animation { width: 80px; height: 80px; margin: 0 auto 1.5rem; position: relative; }
    .loading-connecting { display: flex; justify-content: center; align-items: center; }
    .loading-connecting .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--brand); margin: 0 5px; animation: bounce 1.5s infinite ease-in-out; }
    .loading-connecting .dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-connecting .dot:nth-child(3) { animation-delay: 0.4s; }
    .loading-complete .checkmark { width: 80px; height: 80px; margin: 0 auto; position: relative; }
    .loading-complete .checkmark:before { content: ''; position: absolute; top: 50%; left: 50%; width: 40px; height: 20px; border: 6px solid var(--brand); border-top: none; border-right: none; transform: translate(-50%, -60%) rotate(-45deg); animation: checkmark 0.6s ease-in-out; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    @keyframes checkmark { 0% { opacity: 0; transform: translate(-50%, -60%) rotate(-45deg) scale(0); } 50% { opacity: 1; transform: translate(-50%, -60%) rotate(-45deg) scale(1.2); } 100% { opacity: 1; transform: translate(-50%, -60%) rotate(-45deg) scale(1); } }
    .loading-text { font-weight: 600; color: var(--brand); margin-bottom: 0.5rem; font-size: 1.1rem; }
    .loading-subtext { color: var(--muted); font-size: 0.9rem; max-width: 400px; margin: 0 auto; }
    .status-log { max-height: 300px; overflow-y: auto; background: rgba(248, 249, 250, 0.7); border-radius: 0.5rem; padding: 1rem; font-family: monospace; font-size: 0.875rem; margin-bottom: 1rem; backdrop-filter: blur(10px); }
    .status-line { margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(233, 236, 239, 0.5); cursor: pointer; transition: all 0.3s ease; }
    .status-line:hover { background: rgba(255, 255, 255, 0.5); border-radius: 0.25rem; padding-left: 0.5rem; }
    .status-line:last-child { margin-bottom: 0; border-bottom: none; }
    .status-success { color: #28a745; } .status-error { color: #dc3545; } .status-warning { color: #fd7e14; } .status-info { color: var(--brand); }
    .footer { color: #9ca3af; background-color: var(--light-bg); }
    a { color: var(--brand); text-decoration: none; cursor: pointer; transition: all 0.3s ease; }
    a:hover { color: var(--brand-600); }
    .result-container { display: none; }
    #toast-container { position: fixed; top: 65px; right: 10px; z-index: 9999; display: flex; flex-direction: column-reverse; gap: 10px; }
    .toast { background: white; border-radius: 12px; padding: 16px 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); display: flex; align-items: center; min-width: 300px; max-width: 400px; transform: translateX(100%); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; position: relative; overflow: hidden; border-left: 4px solid var(--brand); backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast-success { border-left-color: #10ac84; } .toast-error { border-left-color: #e74c3c; } .toast-warning { border-left-color: #f39c12; } .toast-info { border-left-color: #3498db; }
    .toast-content { display: flex; align-items: center; width: 100%; }
    .toast-icon { margin-right: 12px; font-size: 20px; }
    .toast-success .toast-icon { color: #10ac84; } .toast-error .toast-icon { color: #e74c3c; } .toast-warning .toast-icon { color: #f39c12; } .toast-info .toast-icon { color: #3498db; }
    .toast-message { flex: 1; font-weight: 500; font-size: 14px; color: #2d3748; }
    .toast-progress { position: absolute; bottom: 0; left: 0; height: 3px; width: 100%; background: rgba(0, 0, 0, 0.1); transform: scaleX(1); transform-origin: left; animation: toastProgress 3s linear forwards; }
    .toast-success .toast-progress { background: linear-gradient(to right, #10ac84, #0d916b); } .toast-error .toast-progress { background: linear-gradient(to right, #e74c3c, #c0392b); } .toast-warning .toast-progress { background: linear-gradient(to right, #f39c12, #e67e22); } .toast-info .toast-progress { background: linear-gradient(to right, #3498db, #2980b9); }
    @keyframes toastProgress { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    .gpa-result-card { background: rgba(255, 255, 255, 0.8); border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2rem; margin-top: 2rem; width: 100%; margin-left: auto; margin-right: auto; backdrop-filter: blur(10px); transition: all 0.3s ease; }
    .gpa-result-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
    .semester-card { background: rgba(255, 255, 255, 0.8); border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; position: relative; backdrop-filter: blur(10px); transition: all 0.3s ease; }
    .semester-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .delete-semester { position: absolute; top: 1rem; right: 1rem; cursor: pointer; color: #dc3545; font-size: 1.2rem; z-index: 10; transition: all 0.3s ease; }
    .delete-semester:hover { transform: scale(1.2); }
    .add-course-btn { position: absolute; top: 1rem; right: 3rem; cursor: pointer; color: var(--brand); font-size: 1.2rem; z-index: 10; transition: all 0.3s ease; }
    .add-course-btn:hover { transform: scale(1.2); }
    .course-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .course-table th, .course-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(229, 231, 235, 0.5); }
    .course-table th { font-weight: 600; color: var(--muted); background: rgba(122, 106, 216, 0.05); }
    .grade-badge { padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.75rem; }
    .grade-A { background-color: rgba(220, 252, 231, 0.7); color: #166534; } .grade-B { background-color: rgba(219, 234, 254, 0.7); color: #1e40af; } .grade-C { background-color: rgba(254, 243, 199, 0.7); color: #92400e; } .grade-D { background-color: rgba(254, 226, 226, 0.7); color: #991b1b; } .grade-F { background-color: rgba(243, 244, 246, 0.7); color: #374151; }
    .extra-enrolled { background-color: rgba(255, 193, 7, 0.2); color: #856404; padding: 0.15rem 0.35rem; border-radius: 0.25rem; font-size: 0.7rem; margin-left: 0.5rem; }
    .course-details-modal .modal-content { border-radius: var(--radius); backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
    .course-details-modal .modal-header { background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1)); border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }
    [data-theme="dark"] { --text: #e5e7eb; --text-light: #d1d5db; --muted: #9ca3af; }
    [data-theme="dark"] body { background: linear-gradient(180deg, #0b0e13 0%, #0f1320 70%); color: #f1f5f9; }
    [data-theme="dark"] .navbar { background-color: rgba(17, 24, 39, 0.8); }
    [data-theme="dark"] .navbar .nav-link { color: #d1d5db; }
    [data-theme="dark"] .navbar .nav-link:hover { color: #fff; }
    [data-theme="dark"] .card-modern { background: rgba(15, 20, 34, 0.8); color: #e5e7eb; }
    [data-theme="dark"] .card-modern .card-header { background: linear-gradient(135deg, rgba(122, 106, 216, 0.3), rgba(122, 106, 216, 0.15)); }
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4, [data-theme="dark"] h5 { color: #ffffff; }
    [data-theme="dark"] .lead { color: #9ca3af; }
    [data-theme="dark"] label { color: #e5e7eb; }
    [data-theme="dark"] .form-control, [data-theme="dark"] .form-select { background: rgba(11, 16, 32, 0.8); color: #f1f5f9; border-color: rgba(122, 106, 216, 0.3); }
    [data-theme="dark"] .form-control::placeholder { color: #9ca3af; }
    [data-theme="dark"] .form-text { color: var(--muted); }
    [data-theme="dark"] .input-group-text { background: rgba(31, 41, 55, 0.8); color: #e5e7eb; }
    [data-theme="dark"] .footer { color: #9ca3af; background: rgba(17, 24, 39, 0.8); }
    [data-theme="dark"] a { color: rgb(158, 141, 240); }
    [data-theme="dark"] a:hover { color: #9f8df0; }
    [data-theme="dark"] .status-log { background: rgba(26, 32, 48, 0.8); }
    [data-theme="dark"] .status-line { border-bottom-color: rgba(45, 55, 72, 0.5); }
    [data-theme="dark"] .gpa-result-card { background: rgba(26, 32, 48, 0.8); }
    [data-theme="dark"] .semester-card { background: rgba(26, 32, 48, 0.8); }
    [data-theme="dark"] .course-table th, [data-theme="dark"] .course-table td { border-bottom-color: rgba(45, 55, 72, 0.5); }
    [data-theme="dark"] .course-table th { background: rgba(122, 106, 216, 0.1); }
    [data-theme="dark"] .loading-container { background: linear-gradient(135deg, rgba(122, 106, 216, 0.15), rgba(122, 106, 216, 0.08)); }
    [data-theme="dark"] .grade-A { background-color: rgba(21, 128, 61, 0.3); color: #86efac; }
    [data-theme="dark"] .grade-B { background-color: rgba(30, 64, 175, 0.3); color: #93c5fd; }
    [data-theme="dark"] .grade-C { background-color: rgba(146, 64, 14, 0.3); color: #fed7aa; }
    [data-theme="dark"] .grade-D { background-color: rgba(153, 27, 27, 0.3); color: #fecaca; }
    [data-theme="dark"] .grade-F { background-color: rgba(55, 65, 81, 0.3); color: #d1d5db; }
    [data-theme="dark"] .course-details-modal .modal-content, [data-theme="dark"] #addCourseModal .modal-content { background: rgba(26, 32, 48, 0.95); color: #e5e7eb; }
    [data-theme="dark"] .course-details-modal .modal-header, [data-theme="dark"] #addCourseModal .modal-header { background: linear-gradient(135deg, rgba(122, 106, 216, 0.3), rgba(122, 106, 216, 0.15)); border-bottom-color: rgba(45, 55, 72, 0.5); }
    [data-theme="dark"] .course-details-modal .modal-header .btn-close, [data-theme="dark"] #addCourseModal .modal-header .btn-close { filter: invert(1); }
    [data-theme="dark"] .course-details-modal .alert-info { background-color: rgba(23, 162, 184, 0.2); border-color: rgba(23, 162, 184, 0.3); color: #71d4f0; }
    [data-theme="dark"] .course-details-modal .alert-warning { background-color: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.3); color: #ffd351; }
    [data-theme="dark"] .text-body-secondary { color: #d1d5db !important; }
    [data-theme="dark"] .btn-primary-action { color: #ffffff !important; }
    .cursor-dot { position: fixed; width: 10px; height: 10px; border-radius: 50%; background: var(--brand); pointer-events: none; transform: translate(-50%, -50%); opacity: .7; mix-blend-mode: multiply; z-index: 9999; transition: all 0.1s ease; }
    [data-theme="dark"] .cursor-dot { mix-blend-mode: screen; }
    .course-actions i { cursor: pointer; font-size: 14px; padding: 4px; border-radius: 4px; transition: all 0.3s ease; }
    .delete-course { color: #dc3545; }
    .delete-course:hover { background-color: rgba(220, 53, 69, 0.1); transform: scale(1.2); }
    .restore-course { color: #10ac84; }
    .restore-course:hover { background-color: rgba(16, 172, 132, 0.1); transform: scale(1.2); }
    .clickable-info { cursor: pointer; color: var(--brand); transition: all 0.3s ease; }
    .clickable-info:hover { opacity: 0.8; transform: scale(1.1); }
    .course-code-container .fa-info-circle { margin-left: 0.3rem !important; }
    .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; justify-content: center; }
    .semester-results-container { width: 100%; }
    .semester-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; width: 100%; }
    .custom-course-btn { background: var(--brand-gradient); color: white; border: none; border-radius: 8px; padding: 8px 12px; font-size: 0.9rem; margin-top: 10px; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: all 0.3s ease; }
    .custom-course-btn:hover { background: var(--brand-gradient-hover); transform: translateY(-2px); }
    .undo-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(51, 51, 51, 0.9); color: white; padding: 12px 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; z-index: 10000; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); width: calc(100% - 40px); max-width: 400px; justify-content: space-between; }
    .undo-btn { background: var(--brand-gradient); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; }
    .undo-btn:hover { background: var(--brand-gradient-hover); transform: translateY(-1px); }
    .cgpa-display-container { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
    .cgpa-main-info { text-align: center; width: 100%; padding-bottom: 1rem; border-bottom: 1px solid rgba(122, 106, 216, 0.3); }
    .cgpa-metrics-row { display: flex; justify-content: space-between; width: 100%; gap: 1rem; }
    .cgpa-metric { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .cgpa-metric-left { align-items: flex-start; }
    .cgpa-metric-center { align-items: center; }
    .cgpa-metric-right { align-items: flex-end; }
    .cgpa-metric-label { font-size: 1rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; }
    .cgpa-metric-value { font-size: 1.75rem; font-weight: 650; color: var(--brand); line-height: 1.2; background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .cgpa-metric-subvalue { font-size: 0.9rem; color: var(--muted); }
    #backToTop { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--brand-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(122, 106, 216, 0.3); z-index: 1000; }
    #backToTop.visible { opacity: 1; visibility: visible; }
    #backToTop:hover { background: var(--brand-gradient-hover); transform: translateY(-5px); box-shadow: 0 8px 20px rgba(122, 106, 216, 0.4); }
    .gradient-text { background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary)); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-text 3s ease infinite; }
    @keyframes gradient-text { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .hero-text-gradient { background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary)); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-text 3s ease infinite; }
    .robot-icon-gradient { background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary)); background-size: 300% 300%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-text 3s ease infinite; }
    .btn-pdf-download { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: 0; box-shadow: 0 6px 18px rgba(231, 76, 60, 0.2); cursor: pointer; transition: all 0.3s ease; }
    .btn-pdf-download:hover { background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%); color: white; transform: translateY(-2px); box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3); }
    .scraping-section .mb-3 { text-align: center; }
    .scraping-section #registrationNumber { max-width: 350px; margin: 0 auto; text-align: center; }
    
    /* NEW: Animation for scroll-in effect */
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    .fade-in-up.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* NEW: Styles for GPA Chart */
    .gpa-chart-container {
        background: rgba(255, 255, 255, 0.8);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
        margin-top: 2rem;
        backdrop-filter: blur(10px);
    }
    [data-theme="dark"] .gpa-chart-container {
        background: rgba(26, 32, 48, 0.8);
    }

    @media (min-width: 992px) {
      .semester-grid { grid-template-columns: repeat(2, 1fr); }
      .course-table tbody tr { cursor: grab; }
      .course-table tbody tr.dragging { opacity: 0.5; background: #e9e6f8; }
      .semester-card.drag-over { border: 2px dashed var(--brand); transform: scale(1.02); background-color: rgba(122, 106, 216, 0.1); }
      [data-theme="dark"] .semester-card.drag-over { background-color: rgba(122, 106, 216, 0.2); }
    }
    @media (max-width: 768px) {
      .hero h1 { font-size: 2.5rem; }
      .course-table { white-space: nowrap; font-size: 11px; }
      .gpa-result-card { width: 95%; padding: 1.5rem; }
      .semester-card { padding: 1.5rem; max-width: 420px; }
      .cgpa-metrics-row { flex-direction: column; gap: 1.5rem; }
      .cgpa-metric { flex-direction: row; justify-content: space-between; align-items: center; width: 100%; padding: 0.5rem 0; border-bottom: 1px solid rgba(122, 106, 216, 0.1); }
      .cgpa-metric:last-child { border-bottom: none; }
      .cgpa-metric-left, .cgpa-metric-center, .cgpa-metric-right { align-items: center; }
      .cgpa-metric-label { margin-bottom: 0; min-width: 100px; text-align: left; }
      .cgpa-metric-value-container { display: flex; flex-direction: column; align-items: flex-end; }
      .cgpa-metric-value { font-size: 1.5rem; }
      .semester-grid { display: block; }
    }
  </style>
</head>
<body>
  <div class="cursor-dot" id="cursorDot"></div>
  <div id="backToTop"><i class="fas fa-arrow-up"></i></div>

  <div class="modal fade course-details-modal" id="courseDetailsModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="courseDetailsModalTitle">Course Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="courseDetailsModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Close</button></div></div></div></div>
  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Add Custom Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="addCourseForm"><input type="hidden" id="addCourseSemester" value=""><div class="mb-3"><label for="courseCode" class="form-label">Course Code</label><input type="text" class="form-control" id="courseCode" placeholder="e.g., CHEM-101" required></div><div class="mb-3"><label for="courseTitle" class="form-label">Course Title</label><input type="text" class="form-control" id="courseTitle" placeholder="e.g., Inorganic Chemistry" required></div><div class="row"><div class="col-6 mb-3"><label for="creditHours" class="form-label">Credit Hours</label><select class="form-select" id="creditHours" required><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div><div class="col-6 mb-3"><label for="courseMarks" class="form-label">Marks Obtained</label><input type="number" class="form-control" id="courseMarks" min="0" max="100" placeholder="e.g., 75" required></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary-action rounded-pill" id="saveCourseBtn">Add Course</button></div></div></div></div>

  <nav class="navbar navbar-expand-lg sticky-top border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <span class="badge rounded-pill badge-brand">UAF</span>
        <span class="gradient-text">CGPA Calculator</span>
      </a>
      <div class="d-flex align-items-center gap-2 order-lg-2">
        <button id="themeToggle" class="btn btn-sm btn-soft rounded-pill" type="button" aria-label="Toggle dark mode"><i class="fa-solid fa-moon"></i></button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"><span class="navbar-toggler-icon"></span></button>
      </div>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#Auto-Calculator">Calculator</a></li>
          <li class="nav-item"><a class="nav-link" href="#faq">FAQ</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact-us">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="hero" id="Home">
    <div class="container">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <span class="badge rounded-pill badge-brand mb-3">University of Agriculture Faisalabad</span>
          <h1 class="display-5 mb-3">Your Academic Progress, <span class="hero-text-gradient">Visualized & Perfected</span></h1>
          <p class="lead mb-4">The ultimate tool for UAF students. Instantly fetch results from LMS, <strong>visualize your GPA trend</strong>, and <strong>forecast your future CGPA</strong> with powerful 'what-if' scenarios.</p>
          <div class="d-flex gap-2">
            <a href="#Auto-Calculator" class="btn btn-primary-action btn-lg rounded-pill" style="font-size: 1.05rem; padding: 0.9rem;"><i class="fa-solid fa-bolt me-2"></i>Get Started</a>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card card-modern fade-in-up">
            <div class="card-body p-4">
              <div class="d-flex align-items-center gap-3">
                <div class="display-6 robot-icon-gradient"><i class="fa-solid fa-chart-line"></i></div>
                <div>
                  <h5 class="mb-1 fw-bold">Beyond Calculation</h5>
                  <p class="mb-0 text-body-secondary">More than just numbers. See your progress and plan your future.</p>
                </div>
              </div>
              <hr class="my-4" />
              <ul class="list-unstyled m-0">
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> Automatic result fetching from LMS</li>
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> Interactive GPA trend chart</li>
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> 'What-If' CGPA forecasting</li>
                <li class="d-flex align-items-center gap-2"><i class="fa-solid fa-check text-success"></i> Professional PDF transcript export</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="py-5" id="Auto-Calculator">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card card-modern mb-4 fade-in-up">
            <div class="card-header p-4"><h4 class="mb-0"><i class="fa-solid fa-bolt me-2"></i>Automatic CGPA Calculator</h4></div>
            <div class="card-body p-4 scraping-section">
              <form id="resultForm">
                <div class="mb-3">
                  <label for="registrationNumber" class="form-label">Enter Your Registration Number</label>
                  <input type="text" class="form-control" id="registrationNumber" placeholder="e.g., 2020-ag-1234" required>
                </div>
                <div class="center-buttons">
                  <button type="submit" class="btn btn-primary-action rounded-pill"><i class="fa-solid fa-cloud-arrow-down me-2"></i>Fetch & Calculate</button>
                </div>
              </form>
              <div class="loading-container" id="loadingContainer">
                <div class="loading-stage" id="connectingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Connecting to UAF LMS</p><p class="loading-subtext">Establishing secure connection...</p></div>
                <div class="loading-stage" id="fetchingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Fetching Your Results</p><p class="loading-subtext">Retrieving academic records...</p></div>
                <div class="loading-stage" id="processingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Processing Data</p><p class="loading-subtext">Analyzing grades & calculating...</p></div>
                <div class="loading-stage" id="completeStage"><div class="loading-animation loading-complete"><div class="checkmark"></div></div><p class="loading-text">Results Ready!</p><p class="loading-subtext">Your CGPA has been calculated.</p></div>
              </div>
            </div>
          </div>
          
          <div id="resultContainer" class="result-container">
            <div class="gpa-result-card fade-in-up">
              <div class="card-body p-0">
                <div class="cgpa-display-container">
                  <div class="cgpa-main-info"><h2 class="mb-1 fw-bold" id="studentName"><i class="fa-solid fa-user-graduate me-2"></i>Student Name</h2><p class="mb-0 text-body-secondary" id="studentReg">Registration Number</p></div>
                  <div class="cgpa-metrics-row">
                    <div class="cgpa-metric cgpa-metric-left"><p class="mb-0 cgpa-metric-label">CGPA</p><p class="mb-0 cgpa-metric-value" id="totalCgpa">0.0000</p></div>
                    <div class="cgpa-metric cgpa-metric-center"><p class="mb-0 cgpa-metric-label">Percentage</p><p class="mb-0 cgpa-metric-value" id="totalPercentage">0.00%</p></div>
                    <div class="cgpa-metric cgpa-metric-right"><p class="mb-0 cgpa-metric-label">Marks</p><div class="cgpa-metric-value-container"><p class="mb-0 cgpa-metric-value" id="totalMarksObtained">0</p><p class="mb-0 cgpa-metric-subvalue" id="totalMaxMarks">/ 0</p></div></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="action-buttons fade-in-up">
              <button id="downloadPdfBtn" class="btn btn-pdf-download rounded-pill"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
              <button id="copyDetailsBtn" class="btn btn-success-action rounded-pill"><i class="fa-solid fa-copy me-2"></i>Copy Details</button>
              <button id="addForecastSemesterBtn" class="btn btn-primary-action rounded-pill"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast Semester</button>
            </div>
            
            <div class="gpa-chart-container fade-in-up">
                <h4 class="mb-3 text-center gradient-text">GPA Trend</h4>
                <canvas id="gpaTrendChart"></canvas>
            </div>

            <div class="semester-results-container mt-4">
              <div id="semesterResults" class="semester-grid"></div>
            </div>
          </div>
          
          <div class="card card-modern mt-4 fade-in-up">
            <div class="card-header p-4"><h4 class="mb-0 text-start"><i class="fa-solid fa-terminal me-2"></i>Status Log</h4></div>
            <div class="card-body p-4">
              <div class="status-log" id="statusLog"><div class="status-line status-info">Ready to fetch your results. Enter your registration number and click "Fetch & Calculate".</div></div>
              <div class="log-section center-buttons mt-3">
                <button id="downloadLogBtn" class="btn btn-secondary-action rounded-pill"><i class="fa-solid fa-file-lines me-2"></i>Download Log</button>
                <button id="clearLogBtn" class="btn btn-danger-action rounded-pill"><i class="fa-solid fa-trash me-2"></i>Clear Log</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main>
    <section class="py-5" id="faq">
      <div class="container">
        <div class="text-center mb-5">
          <h2 class="fw-bold">Frequently Asked Questions</h2>
          <p class="lead text-muted">Answers to common questions about the UAF CGPA Calculator.</p>
        </div>
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
              <div class="accordion-item card-modern mb-3 fade-in-up"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">How does the UAF CGPA Calculator work?</button></h2><div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#faqAccordion"><div class="accordion-body">The UAF CGPA Calculator securely connects to the public UAF LMS portal using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA).</div></div></div>
              <div class="accordion-item card-modern mb-3 fade-in-up"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">Is it safe to use my registration number?</button></h2><div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#faqAccordion"><div class="accordion-body"><strong>Yes, it is completely safe.</strong> The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private.</div></div></div>
              <div class="accordion-item card-modern mb-3 fade-in-up"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">Can I use this calculator for other universities?</button></h2><div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#faqAccordion"><div class="accordion-body">This calculator is specifically designed for the students of the <strong>University of Agriculture, Faisalabad (UAF)</strong>. It uses UAF's unique grading system and connects directly to the UAF LMS, so it will not work for other universities.</div></div></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <section class="py-5" id="contact-us">
      <div class="container">
          <div class="row g-4">
              <div class="col-lg-6 fade-in-up">
                  <h3 class="fw-bold mb-2">Contact</h3>
                  <p class="text-body-secondary">Questions or suggestions? Send a message.</p>
                  <form id="contact-form" action="https://formspree.io/f/xblrolwp" method="post" class="needs-validation" novalidate>
                      <div class="row g-3">
                          <div class="col-md-6"><label class="form-label" for="name">Your Name</label><input class="form-control" id="name" name="name" placeholder="e.g., Ali Raza" required /><div class="invalid-feedback">Please enter your name.</div></div>
                          <div class="col-md-6"><label class="form-label" for="email">Email</label><input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required /><div class="invalid-feedback">Enter a valid email.</div></div>
                          <div class="col-12"><label class="form-label" for="message">Message</label><textarea class="form-control" id="message" name="message" rows="4" placeholder="Write your message..." required></textarea><div class="invalid-feedback">Please write a message.</div></div>
                          <div class="col-12"><button class="btn btn-primary-action rounded-pill" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Send</button></div>
                          <div id="contact-form-status" class="mt-2 small"></div>
                      </div>
                  </form>
              </div>
              <div class="col-lg-6 fade-in-up">
                  <div class="h-100 p-4 p-lg-5 rounded-4" style="background:linear-gradient(180deg, rgba(122,106,216,.15), rgba(122,106,216,.05));">
                      <h5 class="fw-bold">Developer</h5>
                      <div class="d-flex align-items-center gap-3 mt-2">
                          <img src="https://avatars.githubusercontent.com/u/108975317" alt="Muhammad Saqlain" class="rounded-circle" width="56" height="56" />
                          <div>
                              <div class="fw-semibold">Muhammad Saqlain</div><div class="text-body-secondary small">BS Chemistry (2020â€“2024)</div>
                              <div class="d-flex gap-3 mt-2">
                                  <a class="text-decoration-none" href="https://www.facebook.com/UAFChemist.Rustam" target="_blank"><i class="fa-brands fa-facebook"></i></a>
                                  <a class="text-decoration-none" href="https://x.com/M_Saqlain_Akbar" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                                  <a class="text-decoration-none" href="https://www.linkedin.com/in/muhammad-saqlain-akbar/" target="_blank"><i class="fa-brands fa-linkedin"></i></a>
                              </div>
                          </div>
                      </div>
                      <hr class="my-4" /><p class="mb-0 small text-body-secondary">Share this tool with your friends to support the project. â™¥</p>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <footer class="border-top py-4">
    <div class="container text-center footer">
      <p class="mb-1">UAF CGPA Calculator - A project by <a href="#contact-us">Muhammad Saqlain</a>.</p>
      <p class="mb-0">Â© 2025 UAFTools. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const registrationNumber = document.getElementById('registrationNumber');
      const resultContainer = document.getElementById('resultContainer');
      const statusLog = document.getElementById('statusLog');
      const themeToggle = document.getElementById('themeToggle');
      const cursorDot = document.getElementById('cursorDot');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      // NEW: Additional element selectors
      const copyDetailsBtn = document.getElementById('copyDetailsBtn');
      const addForecastSemesterBtn = document.getElementById('addForecastSemesterBtn');
      let gpaChart = null; // To hold the chart instance

      // State
      let allLogs = [];
      let processedData = null;
      let deletedSemesters = {};
      
      const API_ENDPOINT = `https://uaf-cgpa-calculator.vercel.app/api/result-scraper?action=scrape_single`;

      // --- Initialization ---
      function init() {
        initCustomCursor();
        initTheme();
        initContactForm();
        initBackToTop();
        initScrollAnimations(); // NEW
        createToastContainer();
        loadFromLocalStorage(); // NEW
        
        // Event Listeners
        document.getElementById('resultForm').addEventListener('submit', (e) => { e.preventDefault(); fetchResult(); });
        document.getElementById('downloadLogBtn').addEventListener('click', downloadLog);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        document.getElementById('saveCourseBtn').addEventListener('click', addCustomCourse);
        downloadPdfBtn.addEventListener('click', generatePDF);
        copyDetailsBtn.addEventListener('click', copyDetailsToClipboard); // NEW
        addForecastSemesterBtn.addEventListener('click', addForecastSemester); // NEW
      }

      // --- NEW: Load saved data ---
      function loadFromLocalStorage() {
          const savedData = localStorage.getItem('uafCgpaResult');
          const savedRegNum = localStorage.getItem('uafCgpaRegNum');
          if (savedRegNum) {
              registrationNumber.value = savedRegNum;
          }
          if (savedData) {
              try {
                  const data = JSON.parse(savedData);
                  processedData = data;
                  recalculateAndDisplay();
                  addStatusMessage('Loaded saved results from your last session.', 'success');
                  showToast('Loaded saved results!', 'info');
              } catch (e) {
                  localStorage.removeItem('uafCgpaResult');
                  localStorage.removeItem('uafCgpaRegNum');
              }
          }
      }

      // --- NEW: Save data to localStorage ---
      function saveToLocalStorage() {
          if (processedData) {
              localStorage.setItem('uafCgpaResult', JSON.stringify(processedData));
              localStorage.setItem('uafCgpaRegNum', processedData.studentInfo.registration);
          }
      }
      
      // --- NEW: Scroll Animations ---
      function initScrollAnimations() {
          const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                  if (entry.isIntersecting) {
                      entry.target.classList.add('visible');
                      observer.unobserve(entry.target);
                  }
              });
          }, { threshold: 0.1 });

          document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
      }

      // --- NEW: GPA Trend Chart ---
      function renderGpaChart() {
          if (gpaChart) {
              gpaChart.destroy();
          }
          const ctx = document.getElementById('gpaTrendChart').getContext('2d');
          const sortedSemesters = Object.keys(processedData.semesters)
              .sort((a, b) => processedData.semesters[a].sortKey.localeCompare(processedData.semesters[b].sortKey));

          const labels = sortedSemesters.map(s => s.replace(' ', '\n'));
          const data = sortedSemesters.map(s => processedData.semesters[s].gpa);

          const theme = document.documentElement.getAttribute('data-theme') || 'light';
          const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
          const labelColor = theme === 'dark' ? '#d1d5db' : '#4b5563';

          gpaChart = new Chart(ctx, {
              type: 'line',
              data: { labels, datasets: [{
                  label: 'Semester GPA',
                  data: data,
                  borderColor: 'rgba(122, 106, 216, 1)',
                  backgroundColor: 'rgba(122, 106, 216, 0.2)',
                  borderWidth: 3,
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: '#fff',
                  pointBorderColor: 'rgba(122, 106, 216, 1)',
                  pointHoverBackgroundColor: 'rgba(122, 106, 216, 1)',
                  pointHoverBorderColor: '#fff',
              }]},
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: { beginAtZero: true, max: 4.0, grid: { color: gridColor }, ticks: { color: labelColor } },
                      x: { grid: { display: false }, ticks: { color: labelColor, maxRotation: 0, minRotation: 0 } }
                  },
                  plugins: { legend: { display: false } },
                  animation: {
                      duration: 1000,
                      easing: 'easeInOutQuart'
                  }
              }
          });
      }

      // --- NEW: Copy Details ---
      function copyDetailsToClipboard() {
          const cgpaData = calculateCGPA(processedData);
          const textToCopy = `
Name: ${processedData.studentInfo.name}
Registration No: ${processedData.studentInfo.registration}
CGPA: ${formatNumber(cgpaData.cgpa).toFixed(4)}
Percentage: ${formatNumber(cgpaData.percentage, 2).toFixed(2)}%
Generated by UAF CGPA Calculator
          `.trim();
          navigator.clipboard.writeText(textToCopy).then(() => {
              showToast('Details copied to clipboard!', 'success');
          }).catch(err => {
              showToast('Failed to copy details.', 'error');
          });
      }
      
      // --- NEW: Add Forecast Semester ---
      function addForecastSemester() {
          const semesterCount = Object.keys(processedData.semesters).length + 1;
          const newSemesterName = `Forecast Semester ${semesterCount}`;
          const lastSortKey = Object.values(processedData.semesters).reduce((max, s) => s.sortKey > max ? s.sortKey : max, '2000-0');
          const newYear = parseInt(lastSortKey.split('-')[0]) + 1;

          processedData.semesters[newSemesterName] = {
              originalName: newSemesterName,
              sortKey: `${newYear}-1`, // Place it at the end
              courses: [],
              isForecast: true // Mark as forecast semester
          };
          recalculateAndDisplay();
          showToast(`'${newSemesterName}' added. Add custom courses to it.`, 'info');
      }

      // Core Logic (mostly unchanged, just added calls to new functions)
      function displayCGPAResults(data, cgpaData) {
        processedData = data;
        resultContainer.style.display = 'block';
        
        document.getElementById('studentName').innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${data.studentInfo.name}`;
        document.getElementById('studentReg').textContent = data.studentInfo.registration;
        document.getElementById('totalCgpa').textContent = formatNumber(cgpaData.cgpa).toFixed(4);
        document.getElementById('totalPercentage').textContent = `${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`;
        document.getElementById('totalMarksObtained').textContent = cgpaData.totalMarksObtained.toFixed(0);
        document.getElementById('totalMaxMarks').textContent = `/ ${cgpaData.totalMaxMarks.toFixed(0)}`;
        
        const semesterResults = document.getElementById('semesterResults');
        semesterResults.innerHTML = '';
        Object.keys(data.semesters).sort((a,b) => data.semesters[a].sortKey.localeCompare(data.semesters[b].sortKey)).forEach(semesterName => {
          const semester = data.semesters[semesterName];
          const semesterCard = document.createElement('div');
          // NEW: Add a special class for forecast semester
          semesterCard.className = `semester-card fade-in-up ${semester.isForecast ? 'border border-primary' : ''}`;
          semesterCard.dataset.semester = semesterName;
          semesterCard.innerHTML = `
            <i class="fa-solid fa-trash delete-semester" title="Delete this semester" data-semester="${semesterName}"></i>
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="mb-0"><i class="fa-solid ${semester.isForecast ? 'fa-wand-magic-sparkles' : 'fa-book-open'} me-2" style="color: var(--brand);"></i>${semesterName}</h5>
              <div class="text-end" style="margin-right: 40px;">
                <p class="mb-0 text-body-secondary small">GPA:</p>
                <p class="mb-0 h4 fw-bold" style="color: var(--brand);">${formatNumber(semester.gpa).toFixed(4)}</p>
                <p class="mb-0 text-body-secondary small">${formatNumber(semester.percentage, 2).toFixed(2)}%</p>
              </div>
            </div>
            <button class="custom-course-btn" data-semester="${semesterName}"><i class="fa-solid fa-plus"></i> Add Course</button>
            <div class="table-responsive"><table class="course-table"><thead><tr><th>Course</th><th>Hrs</th><th>Marks</th><th>Grade</th><th>Action</th></tr></thead>
              <tbody>${semester.courses.map((course, index) => {
                  const courseIdentifier = `${semesterName}-${course.code}-${course.total}-${index}`;
                  return `
                  <tr data-course-identifier="${courseIdentifier}" draggable="true" class="${course.isExtraEnrolled ? 'table-warning' : ''} ${course.isDeleted ? 'table-danger text-decoration-line-through' : ''} ${course.isCustom ? 'table-info' : ''}">
                    <td><div class="course-code-container">
                        <span class="fw-medium course-code clickable-info" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}'>${course.code}${course.isExtraEnrolled ? '<span class="extra-enrolled">Rep.</span>' : ''}</span>
                        <i class="fa-solid fa-info-circle ms-2 clickable-info small" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' title="${course.title}"></i>
                        ${course.isCustom ? '<span class="extra-enrolled">Custom</span>' : ''}
                    </div></td>
                    <td>${course.creditHoursDisplay || course.creditHours}</td><td>${course.marks}</td>
                    <td><span class="grade-badge grade-${course.grade}">${course.grade}</span></td>
                    <td class="course-actions">${course.isDeleted ? `<i class="fa-solid fa-rotate-left restore-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Restore"></i>` : `<i class="fa-solid fa-trash delete-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Delete"></i>`}</td>
                  </tr>`;
              }).join('')}</tbody>
            </table></div>`;
          semesterResults.appendChild(semesterCard);
        });
        attachResultEventListeners();
        renderGpaChart(); // NEW: Render chart after displaying results
        initScrollAnimations(); // NEW: Re-init for dynamically added cards
      }

      function recalculateAndDisplay() {
        const cgpaData = calculateCGPA(processedData);
        displayCGPAResults(processedData, cgpaData);
        saveToLocalStorage(); // NEW: Save state on every change
      }
      
      async function fetchResult() {
        const regNum = registrationNumber.value.trim();
        if (!regNum) { showToast('Please enter a registration number', 'error'); return; }
        
        resultContainer.style.display = 'none';
        document.getElementById('loadingContainer').style.display = 'block';
        showLoadingStage('connecting');
        addStatusMessage(`Fetching result for: ${regNum}`, 'info');

        try {
            const response = await fetch(`${API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
            if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
            showLoadingStage('fetching');
            const data = await response.json();
            showLoadingStage('processing');
            
            if (data.success && data.resultData && data.resultData.length > 0) {
                addStatusMessage('Result fetched successfully from UAF LMS', 'success');
                const processed = processScrapedData(data);
                const cgpaData = calculateCGPA(processed);
                
                showLoadingStage('complete');
                setTimeout(() => {
                    displayCGPAResults(processed, cgpaData);
                    showLoadingStage(null);
                    showToast('Result fetched successfully!', 'success');
                    saveToLocalStorage(); // NEW: Save fresh results
                }, 1000);
            } else {
                throw new Error(data.message || "No result found for this registration number.");
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            let userMessage, logMessage;
            
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                userMessage = 'Network error. Please check your connection.';
                logMessage = 'Failed to fetch due to a network error.';
            } else {
                userMessage = 'Could not retrieve results. The LMS may be offline or the registration number is incorrect.';
                logMessage = `API/LMS Error: ${error.message}`;
            }
            
            addStatusMessage(logMessage, 'error');
            showToast(userMessage, 'error');
            showLoadingStage(null);
        }
      }

      // --- Helper & Utility Functions (Unchanged from your original code) ---
      function initCustomCursor() { document.addEventListener('mousemove', (e) => { cursorDot.style.display = window.innerWidth > 768 ? 'block' : 'none'; cursorDot.style.left = `${e.clientX}px`; cursorDot.style.top = `${e.clientY}px`; }); }
      function initTheme() { const k='uaf-theme',a=(t)=>{document.documentElement.setAttribute('data-theme',t);localStorage.setItem(k,t);themeToggle.innerHTML=t==='dark'?'<i class="fa-solid fa-sun"></i>':'<i class="fa-solid fa-moon"></i>';};const c=localStorage.getItem(k)||'light';a(c);themeToggle.addEventListener('click',()=>a(document.documentElement.getAttribute('data-theme')==='light'?'dark':'light')); }
      function initContactForm() { document.getElementById('contact-form').addEventListener('submit', async (e) => { e.preventDefault(); const f=e.target,s=document.getElementById('contact-form-status');if(!f.checkValidity()){e.stopPropagation();f.classList.add('was-validated');return;}try{const r=await fetch(f.action,{method:'POST',body:new FormData(f),headers:{'Accept':'application/json'}});if(r.ok){s.textContent="Thanks!";s.className="text-success small";f.reset();f.classList.remove('was-validated');showToast('Message sent!', 'success');}else{throw new Error();}}catch{s.textContent="Oops! There was a problem.";s.className="text-danger small";showToast('Failed to send message.', 'error');}}); }
      function initBackToTop() { const b=document.getElementById('backToTop');window.addEventListener('scroll',()=>b.classList.toggle('visible',window.pageYOffset>300));b.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'})); }
      function createToastContainer() { if(!document.getElementById('toast-container')){const c=document.createElement('div');c.id='toast-container';document.body.appendChild(c);} }
      function showToast(m, t='success') { const c=document.getElementById('toast-container'),o=document.createElement('div');o.className=`toast toast-${t}`;const i={success:'fa-circle-check',error:'fa-circle-exclamation',warning:'fa-triangle-exclamation',info:'fa-circle-info'};o.innerHTML=`<div class="toast-content"><i class="toast-icon fa-solid ${i[t]}"></i><span class="toast-message">${m}</span></div><div class="toast-progress"></div>`;c.appendChild(o);setTimeout(()=>o.classList.add('show'),10);setTimeout(()=>{o.classList.remove('show');setTimeout(()=>o.remove(),300)},3000); }
      function addStatusMessage(m, t='info') { const d=new Date().toLocaleTimeString();allLogs.push({timestamp:d,message:m,type:t});const e=document.createElement('div');e.className=`status-line status-${t}`;e.textContent=`[${d}] ${m}`;statusLog.prepend(e);statusLog.scrollTop=0; }
      function showLoadingStage(s) { ['connecting','fetching','processing','complete'].forEach(x=>{const e=document.getElementById(`${x}Stage`);if(e)e.style.display='none'});if(s){const e=document.getElementById(`${s}Stage`);if(e)e.style.display='block';}document.getElementById('loadingContainer').style.display=s?'block':'none'; }
      function downloadLog() { addStatusMessage('Preparing log file...','info');let c="UAF CGPA Calculator - Log\n====================\n\n";allLogs.forEach(l=>c+=`[${l.timestamp}] ${l.message}\n`);const b=new Blob([c],{type:'text/plain'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`cgpa_log_${new Date().toISOString()}.txt`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);addStatusMessage('Log downloaded.','success');showToast('Log downloaded!','success'); }
      function clearLog() { statusLog.innerHTML='';allLogs=[];addStatusMessage('Log cleared.','info');showToast('Log cleared','info'); }
      function processSemesterName(s) { if(!s)return'Unknown';if(s.includes('Winter')){const m=s.match(/(\d{4})/);if(m)return`Winter ${m[1]}`}else if(s.includes('Spring')){const m=s.match(/(\d{4})-(\d{2,4})/);if(m&&m[2].length===4)return`Spring ${m[2]}`;if(m&&m[2].length===2)return`Spring 20${m[2]}`}else if(s.includes('Summer')){const m=s.match(/(\d{4})/);if(m)return`Summer ${m[1]}`}else if(s.includes('Fall')){const m=s.match(/(\d{4})/);if(m)return`Fall ${m[1]}`}return s; }
      function getSemesterOrderKey(s) { if(!s)return'9999-9';let y='9999',o=9;const m=s.match(/\b(20\d{2})\b/);if(m)y=m[1];if(s.toLowerCase().includes('winter'))o=1;else if(s.toLowerCase().includes('spring'))o=2;else if(s.toLowerCase().includes('summer'))o=3;else if(s.toLowerCase().includes('fall'))o=4;return`${y}-${o}`; }
      function processScrapedData(d){if(!d||!d.resultData)return null;const i={name:d.resultData[0]?.StudentName||'',registration:d.resultData[0]?.RegistrationNo||''},s={},h={};d.resultData.forEach(c=>{const o=c.Semester||'Unknown',n=processSemesterName(o),k=(c.CourseCode||'').toUpperCase();if(!s[n])s[n]={originalName:o,sortKey:getSemesterOrderKey(o),courses:[]};const r=parseInt((c.CreditHours||'0').match(/\d+/)?.[0]||'0'),m=parseFloat(c.Total||'0');let q=calculateQualityPoints(m,r);if(c.Grade==='F')q=0;const a={code:c.CourseCode,title:c.CourseTitle||'',creditHours:r,creditHoursDisplay:c.CreditHours,marks:m,qualityPoints:q,grade:c.Grade||'',teacher:c.TeacherName||'',mid:c.Mid||'0',assignment:c.Assignment||'0',final:c.Final||'0',practical:c.Practical||'0',total:c.Total||'0',isExtraEnrolled:!1,isRepeated:!1,isDeleted:!1,isCustom:!1};if(!h[k])h[k]=[];h[k].push({semester:n,semesterSortKey:getSemesterOrderKey(o),marks:m,data:a});s[n].courses.push(a)});Object.values(h).forEach(y=>{if(y.length>1){y.sort((a,b)=>a.semesterSortKey.localeCompare(b.semesterSortKey));const h=y.reduce((p,c)=>p.marks>c.marks?p:c);y.forEach(i=>{i.data.isRepeated=!0;if(i!==h)i.data.isExtraEnrolled=!0})}});return{studentInfo:i,semesters:s,courseHistory:h}}
      function calculateQualityPoints(m,c){m=parseFloat(m);c=parseInt(c);let q=0;if(c===5){if(m>=80)q=20;else if(m>=50)q=20-((80-m)*0.33333);else if(m<50)q=10-((50-m)*0.5);if(m<40)q=0}else if(c===4){if(m>=64)q=16;else if(m>=40)q=16-((64-m)*0.33333);else if(m<40)q=8-((40-m)*0.5);if(m<32)q=0}else if(c===3){if(m>=48)q=12;else if(m>=30)q=12-((48-m)*0.33333);else if(m<30)q=6-((30-m)*0.5);if(m<24)q=0}else if(c===2){if(m>=32)q=8;else if(m>=20)q=8-((32-m)*0.33333);else if(m<20)q=4-((20-m)*0.5);if(m<16)q=0}else if(c===1){if(m>=16)q=4;else if(m>=10)q=4-((16-m)*0.33333);else if(m<10)q=2-((10-m)*0.5);if(m<8)q=0}return parseFloat(Math.max(0,q).toFixed(2))}
      function calculateCustomGrade(m,c){const g={5:{A:80,B:50,D:40},4:{A:64,B:52,C:40,D:32},3:{A:48,B:39,C:30,D:24},2:{A:32,B:26,C:20,D:16},1:{A:16,B:13,C:10,D:8}};const s=g[c];if(!s)return'F';if(m>=s.A)return'A';if(m>=s.B)return'B';if(s.C&&m>=s.C)return'C';if(m>=s.D)return'D';return'F'}
      function calculateCGPA(d){if(!d)return null;let t=0,h=0,o=0,m=0;Object.values(d.semesters).forEach(s=>{s.totalQualityPoints=0;s.totalCreditHours=0;s.totalMarksObtained=0;s.totalMaxMarks=0;s.courses.forEach(c=>{if(!c.isExtraEnrolled&&!c.isDeleted){s.totalQualityPoints+=c.qualityPoints;s.totalCreditHours+=c.creditHours;s.totalMarksObtained+=c.marks;let x={5:100,4:80,3:60,2:40,1:20}[c.creditHours]||0;s.totalMaxMarks+=x;t+=c.qualityPoints;h+=c.creditHours;o+=c.marks;m+=x}});s.gpa=s.totalCreditHours>0?(s.totalQualityPoints/s.totalCreditHours):0;s.percentage=s.totalMaxMarks>0?(s.totalMarksObtained/s.totalMaxMarks*100):0});const c=h>0?(t/h):0,p=m>0?(o/m*100):0;return{cgpa:c,percentage:p,totalQualityPoints:t,totalCreditHours:h,totalMarksObtained:o,totalMaxMarks:m}}
      function formatNumber(v,p=4){return parseFloat(v.toFixed(p))}
      function attachResultEventListeners(){document.querySelectorAll('.clickable-info').forEach(e=>e.addEventListener('click',c=>showCourseDetails(JSON.parse(c.currentTarget.dataset.course.replace(/&#39;/g,"'")))));document.querySelectorAll('.delete-semester').forEach(b=>b.addEventListener('click',e=>deleteSemester(e.currentTarget.dataset.semester)));document.querySelectorAll('.custom-course-btn').forEach(b=>b.addEventListener('click',e=>openAddCourseModal(e.currentTarget.dataset.semester)));document.querySelectorAll('.delete-course').forEach(b=>{const c=JSON.parse(b.dataset.course.replace(/&#39;/g,"'"));b.onclick=()=>modifyCourseState(c,b.dataset.semester,!0)});document.querySelectorAll('.restore-course').forEach(b=>{const c=JSON.parse(b.dataset.course.replace(/&#39;/g,"'"));b.onclick=()=>modifyCourseState(c,b.dataset.semester,!1)});if(window.innerWidth>=992){initDragAndDrop()}}
      function initDragAndDrop(){const d=document.querySelectorAll('.course-table tr[draggable="true"]'),p=document.querySelectorAll('.semester-card');d.forEach(r=>{r.addEventListener('dragstart',e=>{e.target.classList.add('dragging');const s=e.target.closest('.semester-card').dataset.semester,i=e.target.dataset.courseIdentifier;e.dataTransfer.setData('text/plain',JSON.stringify({courseIdentifier:i,sourceSemester:s}))});r.addEventListener('dragend',e=>e.target.classList.remove('dragging'))});p.forEach(l=>{l.addEventListener('dragover',e=>{e.preventDefault();e.currentTarget.classList.add('drag-over')});l.addEventListener('dragleave',e=>e.currentTarget.classList.remove('drag-over'));l.addEventListener('drop',e=>{e.preventDefault();e.currentTarget.classList.remove('drag-over');const a=JSON.parse(e.dataTransfer.getData('text/plain')),t=e.currentTarget.dataset.semester;if(a.sourceSemester===t)return;let m=null,x=-1;const p=a.courseIdentifier.split('-'),o=parseInt(p[p.length-1],10),s=processedData.semesters[a.sourceSemester]?.courses;if(s&&s[o]){const c=s[o],i=`${a.sourceSemester}-${c.code}-${c.total}-${o}`;if(a.courseIdentifier===i){m=c;x=o}}if(m&&x>-1){s.splice(x,1);processedData.semesters[t].courses.push(m);recalculateAndDisplay();showToast(`Moved ${m.code} to ${t}`,'success');addStatusMessage(`Moved ${m.code} from ${a.sourceSemester} to ${t}`,'info')}else{showToast('Could not move course.','error')}})}) }
      function showCourseDetails(c){const m=new bootstrap.Modal(document.getElementById('courseDetailsModal'));document.getElementById('courseDetailsModalTitle').textContent=`${c.code} - ${c.title}`;document.getElementById('courseDetailsModalBody').innerHTML=`<div class="row"><div class="col-md-6"><p><strong>Teacher:</strong> ${c.teacher}</p><p><strong>Credit Hours:</strong> ${c.creditHoursDisplay||c.creditHours}</p><p><strong>Semester:</strong> ${processSemesterName(c.originalSemester)}</p></div><div class="col-md-6"><p><strong>Mid Term:</strong> ${c.mid}</p><p><strong>Assignment:</strong> ${c.assignment}</p><p><strong>Final Term:</strong> ${c.final}</p>${c.practical?`<p><strong>Practical:</strong> ${c.practical}</p>`:''}</div></div><div class="alert alert-info mt-3"><p class="mb-1"><strong>Total Marks:</strong> ${c.total}</p><p class="mb-1"><strong>Grade:</strong> <span class="grade-badge grade-${c.grade}">${c.grade}</span></p><p class="mb-0"><strong>Quality Points:</strong> ${c.qualityPoints.toFixed(2)}</p></div>${c.isExtraEnrolled?'<div class="alert alert-warning"><i class="fa-solid fa-exclamation-triangle me-2"></i>This repeated course\'s marks are not counted towards the CGPA.</div>':''}${c.isCustom?'<div class="alert alert-info"><i class="fa-solid fa-info-circle me-2"></i>This is a custom course.</div>':''}`;m.show()}
      function openAddCourseModal(s){document.getElementById('addCourseSemester').value=s;document.getElementById('addCourseForm').reset();new bootstrap.Modal(document.getElementById('addCourseModal')).show()}
      function addCustomCourse(){const s=document.getElementById('addCourseSemester').value,c=document.getElementById('courseCode').value.trim(),t=document.getElementById('courseTitle').value.trim(),h=parseInt(document.getElementById('creditHours').value),m=parseFloat(document.getElementById('courseMarks').value);if(!c||!t||!h||isNaN(m)){showToast('Please fill all fields.','error');return}const n={code:c,title:t,creditHours:h,creditHoursDisplay:`${h}(${h}-0)`,marks:m,qualityPoints:calculateQualityPoints(m,h),grade:calculateCustomGrade(m,h),semesterName:s,teacher:'Custom',mid:'N/A',assignment:'N/A',final:m,practical:'N/A',total:m,isExtraEnrolled:!1,isRepeated:!1,isDeleted:!1,isCustom:!0};processedData.semesters[s].courses.push(n);recalculateAndDisplay();bootstrap.Modal.getInstance(document.getElementById('addCourseModal')).hide();showToast(`Course ${c} added.`,'success')}
      function deleteSemester(s){if(!processedData||!processedData.semesters[s])return;deletedSemesters[s]=JSON.parse(JSON.stringify(processedData.semesters[s]));delete processedData.semesters[s];recalculateAndDisplay();showUndoNotification(`Semester "${s}" deleted`,()=>undoDeleteSemester(s));addStatusMessage(`Deleted semester: ${s}`,'info')}
      function showUndoNotification(m,c){document.getElementById('undo-notification')?.remove();const n=document.createElement('div');n.id='undo-notification';n.className='undo-notification';n.innerHTML=`<span>${m}</span> <button class="undo-btn">Undo</button>`;document.body.appendChild(n);n.querySelector('.undo-btn').onclick=()=>{c();n.remove()};setTimeout(()=>n.remove(),5000)}
      function undoDeleteSemester(s){if(!deletedSemesters[s])return;processedData.semesters[s]=deletedSemesters[s];delete deletedSemesters[s];recalculateAndDisplay();addStatusMessage(`Restored semester: ${s}`,'info')}
      function modifyCourseState(c,s,d){const i=processedData.semesters[s]?.courses.find(x=>x.code===c.code&&x.total===c.total);if(i){i.isDeleted=d;recalculateAndDisplay();const a=d?'Deleted':'Restored';showToast(`Course ${c.code} ${a.toLowerCase()}`,'info');addStatusMessage(`${a} course: ${c.code} from ${s}`,'info')}}
      function generatePDF(){if(!processedData){showToast('No data to download','error');return}addStatusMessage('Generating PDF report...','info');showLoadingStage('processing');try{const{jsPDF}=window.jspdf,p=new jsPDF({orientation:'p',unit:'mm',format:'a4'}),d=calculateCGPA(processedData);const m=15,w=p.internal.pageSize.getWidth(),h=p.internal.pageSize.getHeight(),a=w-2*m,c={primary:'#7a6ad8',textDark:'#1b1f24',textLight:'#4b5563',line:'#e0e0e0',fillLight:'#f8f9ff'};let y=0;const f=()=>{p.setFontSize(18);p.setTextColor(c.primary);p.setFont('helvetica','bold');p.text("University of Agriculture, Faisalabad",w/2,20,{align:'center'});p.setFontSize(12);p.setTextColor(c.textLight);p.setFont('helvetica','normal');p.text("Unofficial Academic Transcript",w/2,28,{align:'center'});p.setDrawColor(c.primary);p.setLineWidth(0.5);p.line(m,35,w-m,35);y=35};f();const b=y+8,g=28,x=w/2;p.setFillColor(c.fillLight);p.setDrawColor(c.line);p.roundedRect(m,b,a,g,3,3,'FD');p.setFont('helvetica','bold');p.setFontSize(12);p.setTextColor(c.textDark);p.text(processedData.studentInfo.name,x,b+8,{align:'center'});p.setFont('helvetica','normal');p.setFontSize(10);p.setTextColor(c.textLight);p.text(processedData.studentInfo.registration,x,b+14,{align:'center'});p.setDrawColor(c.line);p.line(m,b+18,w-m,b+18);const s=[{label:'OVERALL CGPA',value:formatNumber(d.cgpa,4).toFixed(4)},{label:'PERCENTAGE',value:`${formatNumber(d.percentage,2).toFixed(2)}%`},{label:'TOTAL CREDITS',value:d.totalCreditHours.toString()},{label:'TOTAL MARKS',value:`${d.totalMarksObtained.toFixed(0)}/${d.totalMaxMarks}`}];const z=a/4;s.forEach((t,i)=>{const e=m+i*z+z/2;p.setFontSize(7);p.setFont('helvetica','bold');p.setTextColor(c.textLight);p.text(t.label,e,b+22,{align:'center'});p.setFontSize(10);p.setFont('helvetica','bold');p.setTextColor(c.textDark);p.text(t.value,e,b+26,{align:'center'})});y=b+g;let j=0;Object.keys(processedData.semesters).sort((u,v)=>processedData.semesters[u].sortKey.localeCompare(processedData.semesters[v].sortKey)).forEach(n=>{j++;const o=processedData.semesters[n],k=o.courses.filter(q=>!q.isDeleted);if(k.length===0)return;const l=`GPA: ${formatNumber(o.gpa,4).toFixed(4)} | Credit Hours: ${o.totalCreditHours} | Marks: ${o.totalMarksObtained.toFixed(0)}/${o.totalMaxMarks}`;if(y+30>h){p.addPage();y=20}const q=y+12;p.setFontSize(14);p.setFont('helvetica','bold');p.setTextColor(c.primary);p.text(`${j}. ${n}`,m,q);p.setFontSize(9);p.setFont('helvetica','bold');p.setTextColor(c.textDark);p.text(l,w-m,q,{align:'right'});y=q+2;const r=[['Course Code','Course Title','CH','Marks','Grade']],t=k.map(u=>[u.code,u.title,u.creditHoursDisplay,u.marks.toFixed(0),u.grade]);p.autoTable({head:r,body:t,startY:y,margin:{left:m,right:m,bottom:25},headStyles:{fillColor:c.primary,textColor:'#ffffff',fontStyle:'bold',halign:'center',valign:'middle'},columnStyles:{0:{halign:'left',cellWidth:a*0.18},1:{halign:'left',cellWidth:a*0.46,cellPadding:{left:2}},2:{halign:'center',cellWidth:a*0.12},3:{halign:'center',cellWidth:a*0.12},4:{halign:'center',cellWidth:a*0.12}},styles:{valign:'middle',cellPadding:2.2,fontSize:9,overflow:'linebreak'},alternateRowStyles:{fillColor:'#f8f9ff'}});y=p.lastAutoTable.finalY;if(y<h-30){p.setDrawColor(c.line);p.setLineWidth(0.3);p.line(m,y+6,w-m,y+6);y+=6}});const u=p.internal.getNumberOfPages();p.setPage(u);p.setFontSize(9);p.setTextColor(c.textLight);p.setFont('helvetica','italic');const v=h-20;p.text("Generated by UAF CGPA Calculator (uafcgpacalculator.vercel.app)",w/2,v,{align:'center'});p.text("This is an unofficial transcript for reference purposes only.",w/2,v+5,{align:'center'});p.setFontSize(8).setTextColor('#b0b0b0');p.text(`Page ${u} of ${u}`,w-m,h-10,{align:'right'});p.save(`UAF_Transcript_${processedData.studentInfo.registration}.pdf`);addStatusMessage('PDF report generated.','success');showToast('PDF downloaded!','success')}catch(e){addStatusMessage(`Error generating PDF: ${e.message}`,'error');showToast('Error generating PDF','error')}finally{showLoadingStage(null)}}

      init();
    });
  </script>
</body>
</html>
