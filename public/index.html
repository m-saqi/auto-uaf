<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>UAF CGPA Calculator - M Saqlain | Automatic & Accurate</title>

  <meta name="description" content="The best UAF CGPA Calculator. Automatically fetches results from UAF LMS & Attendance System to calculate your exact CGPA and percentage. Easy to use for all UAF students." />

  <meta name="keywords" content="uaf cgpa calculator, university of agriculture faisalabad, uaf lms, uaf results, gpa calculator uaf, cgpa calculator for uaf, uaf grading system, calculate uaf cgpa, uaf attendance system result" />

  <meta name="author" content="Muhammad Saqlain" />

  <meta name="google-site-verification" content="google3e44586abf077c1e" />

  <link rel="canonical" href="https://uafcgpacalculator.vercel.app" />

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#7a6ad8">

  <meta property="og:title" content="UAF CGPA Calculator - Automatic & Accurate" />
  <meta property="og:description" content="Instantly fetch results from the UAF LMS and Attendance System, calculate your exact CGPA and percentage. The best tool for all UAF students." />
  <meta property="og:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="og:site_name" content="UAF CGPA Calculator" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="en_US" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta name="twitter:title" content="UAF CGPA Calculator - Automatic & Accurate" />
  <meta name="twitter:description" content="The #1 tool for UAF students. Automatically fetch results from the LMS & Attendance System to calculate your exact CGPA. Fast, free, and secure." />
  <meta name="twitter:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta name="twitter:creator" content="@M_Saqlain_Akbar" />

  <meta name="google-site-verification" content="zClcBWKWCeJyEGq-plDV2JvodudE4m_t8OK4sBMj8aw" />

  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MJW7HPPS');</script>
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "UAF CGPA Calculator",
    "url": "https://uafcgpacalculator.vercel.app/",
    "applicationCategory": "EducationalApplication",
    "description": "An automatic CGPA calculator for students of the University of Agriculture Faisalabad (UAF) that fetches results directly from the university's LMS and Attendance System.",
    "operatingSystem": "All",
    "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "PKR"
    },
    "creator": {
      "@type": "Person",
      "name": "Muhammad Saqlain"
    },
    "mainEntity": [
      {
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "How does the UAF CGPA Calculator work?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "The UAF CGPA Calculator securely connects to the public UAF LMS portal and Attendance System using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, allows importing missing courses, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA)."
            }
          },
          {
            "@type": "Question",
            "name": "Is it safe to use my registration number?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Yes, it is completely safe. The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private."
            }
          },
          {
            "@type": "Question",
            "name": "Can I use this calculator for other universities?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "This calculator is specifically designed for the students of the University of Agriculture, Faisalabad (UAF). It uses UAF's unique grading system and connects directly to the UAF LMS and Attendance System, so it will not work for other universities."
            }
          }
        ]
      },
      {
        "@type": "HowTo",
        "name": "How to Use the UAF CGPA Calculator",
        "step": [
          {
            "@type": "HowToStep",
            "text": "Enter your full registration number (e.g., 2020-ag-1234) into the input field.",
            "name": "Enter Registration Number"
          },
          {
            "@type": "HowToStep",
            "text": "Click the 'Fetch Result' button to securely connect to the UAF LMS and retrieve your academic records.",
            "name": "Fetch Your Results"
          },
           {
            "@type": "HowToStep",
            "text": "Optionally, click 'Attendance System' to find and import courses potentially missing from the LMS results.",
            "name": "Check Attendance System (Optional)"
          },
          {
            "@type": "HowToStep",
            "text": "View your automatically calculated CGPA, percentage, and detailed semester-wise results.",
            "name": "View Your CGPA"
          },
          {
            "@type": "HowToStep",
            "text": "Optionally, download a premium PDF of your transcript or use the forecast feature to plan for future semesters.",
            "name": "Download or Forecast"
          }
        ]
      }
    ]
  }
</script>


  <script src="https://analytics.ahrefs.com/analytics.js" data-key="CWWh1lx4Kz/fCxT0UN7M0w" async></script>

  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
  --brand: #7a6ad8;
  --brand-600: #6b5fca;
  --brand-700: #5d52b8;
  --brand-gradient: linear-gradient(135deg, #7a6ad8 0%, #6b5fca 50%, #5d52b8 100%);
  --brand-gradient-hover: linear-gradient(135deg, #8a7ce8 0%, #7b6fda 50%, #6d62c8 100%);
  --accent: #ff6b6b;
  --accent-gradient: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
  --text: #1b1f24;
  --text-light: #4b5563;
  --muted: #6b7280;
  --light-bg: #f8f9ff;
  --card-bg: #ffffff;
  --radius: 1.25rem; /* Standard radius */
  --radius-sm: 0.75rem; /* Slightly smaller radius */
  --radius-btn: 12px; /* Specific radius for certain buttons */
  --shadow: 0 10px 30px rgba(17, 24, 39, 0.1);
  --shadow-hover: 0 15px 40px rgba(17, 24, 39, 0.15);

  /* New gradient variables */
  --brand-primary: #7a6ad8;
  --brand-secondary: #6b5fca;
}

html, body {
  font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  scroll-behavior: smooth;
}

body {
  display: flex; /* ADDED: Makes the body a flex container */
  flex-direction: column; /* ADDED: Stacks children vertically */
  background-color: var(--light-bg);
  min-height: 100vh;
  margin: 0;
  padding: 0;
  color: var(--text);
}

/* Improved navbar with glassmorphism effect */
.navbar {
  backdrop-filter: saturate(180%) blur(12px);
  background-color: rgba(255, 255, 255, 0.8);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.navbar .navbar-brand {
  font-weight: 800;
  letter-spacing: .3px;
  color: var(--brand);
  transition: all 0.3s ease;
}

.navbar .navbar-brand:hover {
  transform: translateY(-1px);
}

.navbar .nav-link {
  position: relative;
  font-weight: 500;
  transition: all 0.3s ease;
  color: #6358c0;
}

.navbar .nav-link::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--brand-gradient);
  transition: width 0.3s ease;
}

.navbar .nav-link:hover::after {
  width: 100%;
}

/* Improved buttons */
.btn-brand {
  background: var(--brand-gradient);
  border: none;
  color: white;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}

.btn-brand:hover {
  background: var(--brand-gradient-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
  color: white;
}

.btn-soft {
  background: rgba(122, 106, 216, 0.1);
  color: var(--brand);
  transition: all 0.3s ease;
}

.btn-soft:hover {
  background: rgba(122, 106, 216, 0.2);
  transform: translateY(-1px);
}

.badge-brand {
  background: var(--brand-gradient);
  color: white;
}

.btn-primary-action {
  background: var(--brand-gradient);
  color: #fff;
  border: 0;
  box-shadow: 0 6px 18px rgba(122, 106, 216, 0.2);
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary-action:hover {
  background: var(--brand-gradient-hover);
  color: #fff;
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(122, 106, 216, 0.3);
}

.btn-secondary-action {
  background: #fff;
  color: var(--brand);
  border: 1px solid rgba(122, 106, 216, 0.15);
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-secondary-action:hover {
  background: #f8f9ff;
  color: var(--brand);
  transform: translateY(-1px);
  box-shadow: 0 5px 15px rgba(122, 106, 216, 0.1);
}

.btn-danger-action {
  background: var(--accent-gradient);
  color: white;
  border: 0;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-danger-action:hover {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: white;
  transform: translateY(-2px);
}

.btn-success-action {
  background: linear-gradient(135deg, #10ac84 0%, #0d916b 100%);
  color: white;
  border: 0;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-success-action:hover {
  background: linear-gradient(135deg, #12c29a 0%, #0fa57c 100%);
  color: white;
  transform: translateY(-2px);
}

/* Improved hero section */
.hero {
  padding: 5rem 0 4rem;
  position: relative;
  overflow: hidden;
  transition: filter 0.3s ease; /* For blur effect */
}

.hero::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  border-radius: 50%;
  background: rgba(122, 106, 216, 0.1);
  z-index: -1;
}

.hero::after {
  content: '';
  position: absolute;
  bottom: -50px;
  left: -50px;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: rgba(255, 107, 107, 0.1);
  z-index: -1;
}

.hero h1 {
  font-weight: 800;
  line-height: 1.05;
  font-size: 3.5rem;
  margin-bottom: 1.5rem;
  background: linear-gradient(135deg, var(--brand) 0%, var(--text) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero .lead {
  color: var(--text-light);
  font-size: 1.25rem;
  margin-bottom: 2rem;
}

.mt-3 {
  margin-top: 1rem !important;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Improved cards with glassmorphism effect */
.card-modern {
  border: 0;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s ease;
  overflow: hidden;
  color: var(--text);
}

.card-modern:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-hover);
}

.card-modern .card-header {
  border: 0;
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1));
  padding: 1.5rem 2rem;
}

.card-modern .card-header h4 {
  font-weight: 700;
  color: var(--text);
  text-align: center; /* Center header text */
}

.form-select, .form-control {
  border-radius: .85rem;
  border: 1px solid rgba(122, 106, 216, 0.2);
  padding: 0.75rem 1rem;
  transition: all 0.3s ease;
  color: var(--text);
  background-color: rgba(255, 255, 255, 0.9);
}

.form-select:focus, .form-control:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 0.25rem rgba(122, 106, 216, 0.25);
}

label {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.5rem;
}

.subject-row {
  border: 1px dashed rgba(122, 106, 216, 0.3);
  border-radius: 1rem;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.5);
  transition: all 0.3s ease;
}

.subject-row:hover {
  border-color: var(--brand);
  background: rgba(255, 255, 255, 0.8);
}

.result-display {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--brand);
  background: linear-gradient(135deg, var(--brand) 0%, var(--text) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Improved loading animations */
.loading-container {
  margin-top: 1.5rem;
  text-align: center;
  padding: 3rem 2rem;
  border-radius: var(--radius);
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.1), rgba(122, 106, 216, 0.05));
  display: none;
  backdrop-filter: blur(10px);
}

.loading-stage {
  display: none;
}

.loading-animation {
  width: 80px;
  height: 80px;
  margin: 0 auto 1.5rem;
  position: relative;
}

.loading-connecting {
  display: flex;
  justify-content: center;
  align-items: center;
}

.loading-connecting .dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--brand);
  margin: 0 5px;
  animation: bounce 1.5s infinite ease-in-out;
}

.loading-connecting .dot:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-connecting .dot:nth-child(3) {
  animation-delay: 0.4s;
}

.loading-complete .checkmark {
  width: 80px;
  height: 80px;
  margin: 0 auto;
  position: relative;
}

.loading-complete .checkmark:before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 20px;
  border: 6px solid var(--brand);
  border-top: none;
  border-right: none;
  transform: translate(-50%, -60%) rotate(-45deg);
  animation: checkmark 0.6s ease-in-out;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

@keyframes checkmark {
  0% { opacity: 0; transform: translate(-50%, -60%) rotate(-45deg) scale(0); }
  50% { opacity: 1; transform: translate(-50%, -60%) rotate(-45deg) scale(1.2); }
  100% { opacity: 1; transform: translate(-50%, -60%) rotate(-45deg) scale(1); }
}

.loading-text {
  font-weight: 600;
  color: var(--brand);
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.loading-subtext {
  color: var(--muted);
  font-size: 0.9rem;
  max-width: 400px;
  margin: 0 auto;
}

.status-log {
  max-height: 300px;
  overflow-y: auto;
  background: rgba(248, 249, 250, 0.7);
  border-radius: 0.5rem;
  padding: 1rem;
  font-family: monospace;
  font-size: 0.875rem;
  margin-bottom: 1rem;
  backdrop-filter: blur(10px);
}

.status-line {
  margin-bottom: 0.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid rgba(233, 236, 239, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
}

.status-line:hover {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 0.25rem;
  padding-left: 0.5rem;
}

.status-line:last-child {
  margin-bottom: 0;
  border-bottom: none;
}

.status-success { color: #28a745; }
.status-error { color: #dc3545; }
.status-warning { color: #fd7e14; } /* Corrected class name */
.status-info { color: var(--brand); }

.footer {
  margin-top: auto; /* ADDED: Pushes the footer to the bottom */
  color: #9ca3af;
  background-color: var(--light-bg);
}

a {
  color: var(--brand);
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

a:hover {
  color: var(--brand-600);
}

/* Loading spinner styles */
.loading {
  display: none;
  text-align: center;
  padding: 20px;
}

.loading p {
  margin-top: 10px;
}

/* Result container styles */
.result-container {
  display: none;
}

/* Toast notifications */
#toast-container {
  position: fixed;
  top: 65px;
  right: 10px;
  z-index: 9999;
  display: flex;
  flex-direction: column-reverse;
  gap: 10px;
}

.toast {
  background: white;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  min-width: 300px;
  max-width: 400px;
  transform: translateX(100%);
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
  position: relative;
  overflow: hidden;
  border-left: 4px solid var(--brand);
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
}

.toast.show {
  transform: translateX(0);
  opacity: 1;
}

.toast-success {
  border-left-color: #10ac84;
}

.toast-error {
  border-left-color: #e74c3c;
}

.toast-warning {
  border-left-color: #f39c12;
}

.toast-info {
  border-left-color: #3498db;
}

.toast-content {
  display: flex;
  align-items: center;
  width: 100%;
}

.toast-icon {
  margin-right: 12px;
  font-size: 20px;
}

.toast-success .toast-icon {
  color: #10ac84;
}

.toast-error .toast-icon {
  color: #e74c3c;
}

.toast-warning .toast-icon {
  color: #f39c12;
}

.toast-info .toast-icon {
  color: #3498db;
}

.toast-message {
  flex: 1;
  font-weight: 500;
  font-size: 14px;
  color: #2d3748;
}

.toast-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  width: 100%;
  background: rgba(0, 0, 0, 0.1);
  transform: scaleX(1);
  transform-origin: left;
  animation: toastProgress 3s linear forwards;
}

.toast-success .toast-progress {
  background: linear-gradient(to right, #10ac84, #0d916b);
}

.toast-error .toast-progress {
  background: linear-gradient(to right, #e74c3c, #c0392b);
}

.toast-warning .toast-progress {
  background: linear-gradient(to right, #f39c12, #e67e22);
}

.toast-info .toast-progress {
  background: linear-gradient(to right, #3498db, #2980b9);
}

@keyframes toastProgress {
  from { transform: scaleX(1); }
  to { transform: scaleX(0); }
}

    /* Positions the new icon relative to the card */
.gpa-result-card {
  position: relative;
}

/* Styles the new copy icon */
.copy-icon-btn {
  position: absolute;
  top: 1.25rem;
  right: 1.25rem;
  font-size: 1.2rem;
  color: #10ac84; /* Green color */
  cursor: pointer;
  transition: all 0.2s ease;
}
.copy-icon-btn:hover {
  transform: scale(1.15);
}

/* GPA Result Display */
.gpa-result-card {
  background: rgba(255, 255, 255, 0.8);
  border-radius: var(--radius);
  padding: 2rem;
  box-shadow: var(--shadow);
  margin-bottom: 2rem;
  margin-top: 2rem;
  width: 70%;
  margin-left: auto;
  margin-right: auto;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.gpa-result-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-hover);
}

.semester-card {
  background: rgba(255, 255, 255, 0.8);
  border-radius: var(--radius);
  padding: 2rem;
  box-shadow: var(--shadow);
  margin-bottom: 1.5rem;
  position: relative;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.semester-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-hover);
}

.delete-semester {
  position: absolute;
  top: 1rem;
  right: 1rem;
  cursor: pointer;
  color: #dc3545;
  font-size: 1.2rem;
  z-index: 10;
  transition: all 0.3s ease;
}

.delete-semester:hover {
  transform: scale(1.2);
}

.add-course-btn {
  position: absolute;
  top: 1rem;
  right: 3rem;
  cursor: pointer;
  color: var(--brand);
  font-size: 1.2rem;
  z-index: 10;
  transition: all 0.3s ease;
}

.add-course-btn:hover {
  transform: scale(1.2);
}

.course-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.course-table th, .course-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid rgba(229, 231, 235, 0.5);
}

.course-table th {
  font-weight: 600;
  color: var(--muted);
  background: rgba(122, 106, 216, 0.05);
}

.grade-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  font-weight: 600;
  font-size: 0.75rem;
}

.grade-A { background-color: rgba(220, 252, 231, 0.7); color: #166534; }
.grade-B { background-color: rgba(219, 234, 254, 0.7); color: #1e40af; }
.grade-C { background-color: rgba(254, 243, 199, 0.7); color: #92400e; }
.grade-D { background-color: rgba(254, 226, 226, 0.7); color: #991b1b; }
.grade-F { background-color: rgba(243, 244, 246, 0.7); color: #374151; }

.extra-enrolled, .attendance-import-badge, .custom-badge {
  background-color: rgba(255, 193, 7, 0.2);
  color: #856404;
  padding: 1px 5px;
  border-radius: 4px;
  font-size: 0.65rem;
  font-weight: 600;
  vertical-align: super;
  margin-left: 2px;
}
.attendance-import-badge {
    background-color: rgba(23, 162, 184, 0.2);
    color: #0c5460;
}
.custom-badge {
    background-color: rgba(108, 117, 125, 0.2);
    color: #383d41;
}


.course-details-modal .modal-content {
  border-radius: var(--radius);
  backdrop-filter: blur(10px);
  background: rgba(255, 255, 255, 0.95);
}

.course-details-modal .modal-header {
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1));
  border-top-left-radius: var(--radius);
  border-top-right-radius: var(--radius);
}

.calculate-cgpa-btn {
  margin-top: 1rem;
  display: none;
}

/* Add Course Form */
.add-course-form {
  background: rgba(248, 249, 250, 0.7);
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin-top: 1rem;
  display: none;
  backdrop-filter: blur(10px);
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}

.form-group {
  flex: 1;
  min-width: 200px;
}

    /* Styling for the collapsible chart header */
#gpaChartChevron {
  transition: transform 0.3s ease-in-out;
}
a[aria-expanded="true"] #gpaChartChevron {
  transform: rotate(180deg);
}
[data-theme="dark"] #gpaChartContainer .text-body {
    color: var(--text) !important;
}


    /* NEW: Modern Calculator Section Styles */
#Auto-Calculator { /* Added transition for blur */
    transition: filter 0.3s ease;
}
.calculator-section-modern {
  padding: 3rem 2rem;
  backdrop-filter: blur(10px);
  margin-bottom: 2rem;
}


.search-and-profiles-container {
  max-width: 600px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.modern-search-wrapper {
  position: relative;
  width: 100%;
}

/* --- UPDATE: Professional Search Input --- */
.modern-search-input {
  border-radius: 50px !important;
  padding: 1rem 1.5rem !important;
  font-size: 1.1rem;
  box-shadow: var(--shadow);
  border: 2px solid transparent;
  /* Add padding to the right to make space for the button */
  padding-right: 170px !important;
}

.modern-search-input:focus {
  border-color: var(--brand);
  box-shadow: var(--shadow-hover);
}

/* --- UPDATE: Professional Search Button --- */
.modern-search-button {
  position: absolute;
  top: 50%;
  right: 6px; /* Space from edge */
  transform: translateY(-50%);
  border-radius: 50px; /* Match input pill shape */
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.75rem 1.25rem; /* Professional padding */
  transition: all 0.3s ease;
  height: calc(100% - 12px); /* Make button slightly smaller than input */
  line-height: 1; /* Ensure text/icon aligns well */
}

.modern-search-button:hover {
  transform: translateY(-50%) scale(1.02); /* Softer transform */
  box-shadow: var(--shadow-hover);
}

/* --- UPDATE: Mobile styles for Search Button/Input --- */
@media (max-width: 767.98px) {
  .modern-search-input {
    padding-right: 70px !important; /* Space for just the icon button */
  }
  .modern-search-button {
    width: 48px; /* Back to circle on mobile */
    height: 48px;
    padding: 0;
    right: 8px;
    border-radius: 50%; /* Back to circle */
  }
}


.modern-profiles-wrapper {
  width: 100%;
}

.modern-profiles-select {
  border-top-left-radius: 0 !important;
  border-bottom-left-radius: 0 !important;
  text-overflow: ellipsis; /* Add ellipsis for very long text */
  padding-right: 2.5rem;   /* Add padding to avoid overlap with arrow */
}

.modern-profiles-icon {
  border-top-left-radius: .85rem !important;
  border-bottom-left-radius: .85rem !important;
  background-color: rgba(122, 106, 216, 0.1);
  color: var(--brand);
}

.modern-delete-button {
    border-top-right-radius: .85rem !important;
    border-bottom-right-radius: .85rem !important;
}

/* ADD THIS CSS FOR THE ANNOUNCEMENT BAR */
.announcement-bar {
  background: var(--brand-gradient);
  color: white;
  padding: 0.75rem 0;
  overflow: hidden;
  white-space: nowrap;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.announcement-track {
  display: inline-block;
  animation: scroll-left 30s linear infinite;
}

.announcement-text {
  display: inline-block;
  font-weight: 500;
  margin: 0 2.5rem; /* Spacing between tips */
  opacity: 0.9;
}

@keyframes scroll-left {
  0% {
    transform: translateX(0%);
  }
  100% {
    transform: translateX(-50%); /* This value should be -50% because the content is duplicated */
  }
}
    @media (max-width: 576px) {
  .announcement-bar {
    padding: 0.25rem 0;
    font-size: 14px;
  }
}

/* Aligned Action Buttons */
.action-buttons-aligned {
  display: flex;
  justify-content: center; /* Center items horizontally */
  align-items: center;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

/* --- UPDATE: Use var(--radius-btn) --- */
.action-buttons-aligned .btn {
  border-radius: var(--radius-btn);
}
@media (max-width: 576px) {
  .action-buttons-aligned {
    justify-content: space-between; /* Space out on mobile */
  }
   .action-buttons-aligned .btn {
    flex-grow: 1; /* Make buttons take equal space on mobile */
    min-width: auto; /* Allow natural shrinking */
    max-width: 32%; /* Roughly 3 buttons per row */
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
}


/* Collapsible Status Log Icon */
.status-log-chevron {
  transition: transform 0.3s ease-in-out;
}
a[aria-expanded="true"] .status-log-chevron {
  transform: rotate(180deg);
}


#openProfileManagerBtn {
    border-top-right-radius: .85rem !important;
    border-bottom-right-radius: .85rem !important;
    border-left: 0;
}

    /* ADD THIS CSS FOR THE PREMIUM CGPA DISPLAY */
.gpa-result-card-premium {
  background: rgba(255, 255, 255, 0.8);
  border-radius: var(--radius);
  padding: 2rem;
  box-shadow: var(--shadow);
  margin-bottom: 2rem;
  margin-top: 2rem;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.2);
}
[data-theme="dark"] .gpa-result-card-premium {
  background: rgba(26, 32, 48, 0.8);
}
.gpa-result-card-premium:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-hover);
}

.student-info-header {
  text-align: center;
  margin-bottom: 2rem;
  border-bottom: 1px solid rgba(122, 106, 216, 0.2);
  padding-bottom: 1.5rem;
}
.student-info-header h2 {
  font-size: 1.5rem;
}

.cgpa-dashboard {
  display: flex;
  justify-content: center;
  margin-bottom: 2rem;
}

.cgpa-progress-circle {
  width: 180px;
  height: 180px;
  position: relative;
}
.cgpa-progress-circle svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}
.cgpa-progress-circle .circle-bg {
  fill: none;
  stroke: rgba(122, 106, 216, 0.15);
  stroke-width: 3.8;
}
[data-theme="dark"] .cgpa-progress-circle .circle-bg {
    stroke: rgba(122, 106, 216, 0.2);
}
.cgpa-progress-circle .circle {
  fill: none;
  stroke: var(--brand);
  stroke-width: 3.8;
  stroke-linecap: round;
  transition: stroke-dasharray 1s ease-in-out;
}

.cgpa-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.cgpa-progress-text .cgpa-value {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
  color: var(--brand);
  background: var(--brand-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.cgpa-progress-text .cgpa-label {
  display: block;
  font-size: 1rem;
  font-weight: 500;
  color: var(--muted);
  margin-top: 0.25rem;
}

.secondary-stats {
  display: flex;
  justify-content: center;
  gap: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(122, 106, 216, 0.2);
}
.stat-item {
  text-align: center;
}
.stat-label {
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--muted);
  display: block;
  margin-bottom: 0.5rem;
}
.stat-value {
  font-size: 1.75rem;
  font-weight: 600;
  color: var(--text);
}
[data-theme="dark"] .stat-value {
    color: #e5e7eb;
}
.stat-sub-value {
    font-size: 1rem;
    color: var(--muted);
}
.stat-divider {
  width: 1px;
  background: rgba(122, 106, 216, 0.2);
}

@media (max-width: 576px) {
  .gpa-result-card-premium {
    padding: 1.5rem;
  }
  .cgpa-progress-circle {
    width: 150px;
    height: 150px;
  }
  .cgpa-progress-text .cgpa-value {
    font-size: 1.70rem;
  }
  .secondary-stats {
    gap: 1rem;
  }
  .stat-value {
    font-size: 1.25rem;
  }
}


/* ----------- DARK MODE IMPROVED ----------- */
[data-theme="dark"] {
  --text: #e5e7eb;
  --text-light: #d1d5db;
  --muted: #9ca3af;
}

[data-theme="dark"] body {
  background: linear-gradient(180deg, #0b0e13 0%, #0f1320 70%);
  color: #f1f5f9;
}

[data-theme="dark"] .navbar {
  background-color: rgba(17, 24, 39, 0.8);
}

[data-theme="dark"] .navbar .nav-link {
  color: #d1d5db;
}

[data-theme="dark"] .navbar .nav-link:hover {
  color: #fff;
}

[data-theme="dark"] .card-modern {
  background: rgba(15, 20, 34, 0.8);
  color: #e5e7eb;
}

[data-theme="dark"] .card-modern .card-header {
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.3), rgba(122, 106, 216, 0.15));
}

[data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4, [data-theme="dark"] h5 {
  color: #ffffff;
}

[data-theme="dark"] .lead {
  color: #9ca3af;
}

/* --- UPDATE: Make subtitle visible in dark mode --- */
[data-theme="dark"] .calculator-section-modern .text-muted {
    color: var(--text-light) !important;
}

[data-theme="dark"] .subject-row {
  background: rgba(26, 31, 46, 0.8);
  border-color: rgba(122, 106, 216, 0.3);
}

[data-theme="dark"] label {
  color: #e5e7eb;
}

[data-theme="dark"] .form-control, [data-theme="dark"] .form-select {
  background: rgba(11, 16, 32, 0.8);
  color: #f1f5f9;
  border-color: rgba(122, 106, 216, 0.3);
}

[data-theme="dark"] .form-control::placeholder {
  color: #9ca3af;
}

[data-theme="dark"] .form-text {
  color: var(--muted);
}

[data-theme="dark"] .input-group-text {
  background: rgba(31, 41, 55, 0.8);
  color: #e5e7eb;
}

[data-theme="dark"] .footer {
  color: #9ca3af;
  background: rgba(17, 24, 39, 0.8);
}

[data-theme="dark"] a {
  color: rgb(158, 141, 240);
}

[data-theme="dark"] a:hover {
  color: #9f8df0;
}

[data-theme="dark"] .status-log {
  background: rgba(26, 32, 48, 0.8);
}

[data-theme="dark"] .status-line {
  border-bottom-color: rgba(45, 55, 72, 0.5);
}

[data-theme="dark"] .gpa-result-card {
  background: rgba(26, 32, 48, 0.8);
}

[data-theme="dark"] .semester-card {
  background: rgba(26, 32, 48, 0.8);
}

[data-theme="dark"] .course-table th,
[data-theme="dark"] .course-table td {
  border-bottom-color: rgba(45, 55, 72, 0.5);
}

[data-theme="dark"] .course-table th {
  background: rgba(122, 106, 216, 0.1);
}

[data-theme="dark"] .add-course-form {
  background: rgba(26, 31, 46, 0.8);
}

[data-theme="dark"] .loading-container {
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.15), rgba(122, 106, 216, 0.08));
}

[data-theme="dark"] .grade-A { background-color: rgba(21, 128, 61, 0.3); color: #86efac; }
[data-theme="dark"] .grade-B { background-color: rgba(30, 64, 175, 0.3); color: #93c5fd; }
[data-theme="dark"] .grade-C { background-color: rgba(146, 64, 14, 0.3); color: #fed7aa; }
[data-theme="dark"] .grade-D { background-color: rgba(153, 27, 27, 0.3); color: #fecaca; }
[data-theme="dark"] .grade-F { background-color: rgba(55, 65, 81, 0.3); color: #d1d5db; }

/* Dark mode for modals */
[data-theme="dark"] .modal-content {
    background: rgba(26, 32, 48, 0.95);
    color: #e5e7eb;
}
[data-theme="dark"] .modal-header {
    background: linear-gradient(135deg, rgba(122, 106, 216, 0.3), rgba(122, 106, 216, 0.15));
    border-bottom-color: rgba(45, 55, 72, 0.5);
}
[data-theme="dark"] .modal-header .btn-close {
    filter: invert(1);
}
[data-theme="dark"] .alert-info {
  background-color: rgba(23, 162, 184, 0.2);
  border-color: rgba(23, 162, 184, 0.3);
  color: #71d4f0;
}
[data-theme="dark"] .alert-warning {
  background-color: rgba(255, 193, 7, 0.2);
  border-color: rgba(255, 193, 7, 0.3);
  color: #ffd351;
}
[data-theme="dark"] .extra-enrolled { background-color: rgba(245, 158, 11, 0.3); color: #fcd34d; }
[data-theme="dark"] .attendance-import-badge { background-color: rgba(59, 130, 246, 0.3); color: #93c5fd; }
[data-theme="dark"] .custom-badge { background-color: rgba(107, 114, 128, 0.3); color: #d1d5db; }


/* Dark mode contrast improvements */
[data-theme="dark"] .text-body-secondary {
  color: #d1d5db !important;
}

[data-theme="dark"] .btn-primary-action {
  color: #ffffff !important;
}

.cursor-dot {
  position: fixed;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--brand);
  pointer-events: none;
  transform: translate(-50%, -50%);
  opacity: .7;
  mix-blend-mode: multiply;
  z-index: 9999;
  transition: all 0.1s ease;
}

[data-theme="dark"] .cursor-dot {
  mix-blend-mode: screen;
}

/* Course action buttons */
.course-actions i {
  cursor: pointer;
  font-size: 14px;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.3s ease;
}

.delete-course {
  color: #dc3545;
}

.delete-course:hover {
  background-color: rgba(220, 53, 69, 0.1);
  transform: scale(1.2);
}

.restore-course {
  color: #10ac84;
}

.restore-course:hover {
  background-color: rgba(16, 172, 132, 0.1);
  transform: scale(1.2);
}

/* Clickable info icon */
.clickable-info {
  cursor: pointer;
  color: var(--brand);
  transition: all 0.3s ease;
}

.clickable-info:hover {
  opacity: 0.8;
  transform: scale(1.1);
}


/* Restore the original horizontal margin for the icon */
.course-code-container .fa-info-circle {
    margin-left: 0.3rem !important;
}

/* --- Mobile responsive adjustments --- */
@media (max-width: 575.98px) {
  .hero {
    padding: 2rem 0;
  }
  .hero h1 {
    font-size: 2.2rem !important;
  }
  /* --- UPDATE: Removed width: 100% --- */
  .d-flex.gap-2 .btn {
    max-width: 300px;
    margin-bottom: 0.5rem;
  }
  .toast {
    min-width: 250px;
    max-width: 300px;
    padding: 12px 16px;
  }
  .toast-message {
    font-size: 0.75rem;
  }
  .card-modern .card-header {
    padding: 1rem 1.25rem;
  }
  #themeToggle {
    font-size: 0.8rem; /* Adjust the font size to make the icon smaller */
    padding: 0.3rem 0.6rem; /* Adjust padding to make the button smaller */
  }
}

/* Ensure subject columns are 2-up on very small screens: change from col-12 col-md-6 -> col-6 col-md-6 */
@media (max-width: 420px) {
  .subject-row .col-6 {
    padding-right: .4rem;
    padding-left: .4rem;
  }
}

/* UPDATED: Narrow calculator container on desktop */
@media (min-width: 992px) {
  #Auto-Calculator .col-md-10 {
    width: 100%;
  }
}

@media (min-width: 992px) {
  .navbar-expand-lg .navbar-nav .nav-link {
    padding-right: var(--bs-navbar-nav-link-padding-x);
    margin-right: 20px;
  }
}

@media (min-width: 768px) {
  .col-md-10 {
    flex: 0 0 auto;
    width: 100%;
  }
}

@media (min-width: 768px) {
  .col-md-4 {
    flex: 0 0 auto;
    width: 48.3%;
  }
}

/* --- Mobile responsive table --- */
@media screen and (max-width: 768px) {
  body {
    font-size: 0.9rem;
  }
  .gpa-result-card {
    width: 95%;
    padding: 1.25rem;
  }
  .course-code-container .fa-info-circle {
    display: none;
  }
  .semester-card {
    padding: 1.25rem;
    max-width: 420px; /* Limit width */
    margin-left: auto; /* Center */
    margin-right: auto; /* Center */
  }
  .semester-card h5 {
    font-size: 0.9rem;
  }
  .semester-card .text-end .small {
    font-size: 0.65rem;
  }
  .custom-course-btn {
    padding: 4px 8px;
    font-size: 0.7rem;
    margin-top: 5px;
  }
  .course-table {
    font-size: 0.65rem;
  }
  /* Reduce padding to decrease gaps between columns */
  .course-table th, .course-table td {
    padding: 0.75rem 0.4rem; /* Reduced horizontal padding */
  }
  .course-table td:first-child {
    font-size: 0.7rem;
    font-weight: 500;
  }
  /* Make grade text smaller */
  .grade-badge {
    font-size: 0.6rem;
    padding: 0.2rem 0.35rem;
  }
  .btn {
    padding: 0.6rem 0.9rem;
    font-size: 0.9rem;
  }
  .loading-animation {
    width: 50px;
    height: 50px;
  }
  .loading-text {
    font-size: 0.9rem;
  }
  .loading-subtext {
    font-size: 0.75rem;
  }
  .cgpa-main-info h2 {
    font-size: 1.3rem;
  }
  .cgpa-metric-value {
    font-size: 1.35rem;
  }
  .action-buttons .btn {
    font-size: 0.75rem;
    padding: 0.6rem 0.4rem;
  }
  /* Table alignment rules */
  .course-table th:nth-child(n+3),
  .course-table td:nth-child(n+3) {
      text-align: center;
  }
  .course-table th:nth-child(1), .course-table td:nth-child(1),
  .course-table th:nth-child(2), .course-table td:nth-child(2) {
      text-align: left;
  }
  .semester-grid {
    display: block; /* Stack semesters on mobile */
  }
}

/* Center buttons only in specific sections */
.scraping-section .center-buttons,
.log-section .center-buttons {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}

@media (max-width: 576px) {
  .scraping-section .center-buttons,
  .log-section .center-buttons {
    flex-direction: column;
    align-items: center;
  }

  .scraping-section .center-buttons .btn,
  .log-section .center-buttons .btn {
    width: auto;
    min-width: 180px;
  }
}

/* New layout improvements */
.results-section {
  margin-top: 2rem;
}

.student-info-section {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.student-details {
  flex: 1;
  min-width: 300px;
}

.cgpa-display {
  flex: 0 0 auto;
  text-align: right;
  min-width: 200px;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  justify-content: center;
}

@media (max-width: 768px) {
  .student-info-section {
    flex-direction: column;
    gap: 1rem;
  }

  .cgpa-display {
    text-align: left;
    margin-top: 1rem;
  }

  .action-buttons {
    flex-direction: row;
    justify-content: space-between;
    width: 100%;
    align-items: center;
  }

  .action-buttons .btn {
    flex-grow: 1;
    margin: 0 0.25rem;
    min-width: auto;
  }
}

/* Section separators */
.section-container {
  margin-bottom: 2rem;
}

.section-title {
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid rgba(122, 106, 216, 0.3);
  position: relative;
}

.section-title::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 60px;
  height: 2px;
  background: var(--brand-gradient);
}

/* Student info logo style */
.student-info-logo {
  background: linear-gradient(135deg, rgba(122, 106, 216, 0.2), rgba(122, 106, 216, 0.1));
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  transition: all 0.3s ease;
}

.student-info-logo:hover {
  transform: rotate(15deg);
}

.student-info-logo i {
  font-size: 1.5rem;
  color: var(--brand);
}

/* Desktop-specific smaller text for semester sections */
@media (min-width: 992px) {
  .semester-card {
    font-size: 0.95rem;
  }

  .semester-card h5 {
    font-size: 1.15rem;
  }

  .course-table {
    font-size: 0.9rem;
  }
}

/* Semester section layout improvements */
.semester-results-container {
  width: 100%;
}

.semester-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  width: 100%;
}

@media (min-width: 992px) {
  .semester-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* NEW STYLES FOR UPDATES */
.repeated-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background-color: #ffc107;
  color: #856404;
  font-size: 8px;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: bold;
}

/* --- UPDATE: Use var(--radius-btn) --- */
.custom-course-btn {
  background: var(--brand-gradient);
  color: white;
  border: none;
  border-radius: var(--radius-btn);
  padding: 8px 12px;
  font-size: 0.9rem;
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.custom-course-btn:hover {
  background: var(--brand-gradient-hover);
  transform: translateY(-2px);
}

.undo-notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(51, 51, 51, 0.9);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 10000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(10px);
  width: calc(100% - 40px);
  max-width: 400px;
  justify-content: space-between;
}

.undo-btn {
  background: var(--brand-gradient);
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.undo-btn:hover {
  background: var(--brand-gradient-hover);
  transform: translateY(-1px);
}
@media (max-width: 576px) {
  .undo-notification {
    bottom: 70px; /* Raise it above mobile browser UI */
    padding: 10px 15px;
    font-size: 0.9rem;
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }
  .undo-btn {
    width: 100%;
    padding: 6px 10px;
  }
}


/* Updated CGPA Display Layout */
.cgpa-display-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1.5rem;
}

.cgpa-main-info {
  text-align: center;
  width: 100%;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(122, 106, 216, 0.3);
}

.cgpa-metrics-row {
  display: flex;
  justify-content: space-between;
  width: 100%;
  gap: 1rem;
}

.cgpa-metric {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.cgpa-metric-left {
  align-items: flex-start;
}

.cgpa-metric-center {
  align-items: center;
}

.cgpa-metric-right {
  align-items: flex-end;
}

.cgpa-metric-label {
  font-size: 1rem;
  font-weight: 600;
  color: var(--muted);
  margin-bottom: 0.5rem;
}

.cgpa-metric-value {
  font-size: 1.75rem;
  font-weight: 650;
  color: var(--brand);
  line-height: 1.2;
  background: var(--brand-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.cgpa-metric-subvalue {
  font-size: 0.9rem;
  color: var(--muted);
}

/* --- Mobile responsive adjustments for CGPA --- */
@media (max-width: 768px) {
  .cgpa-metrics-row {
    flex-direction: column;
    gap: 1.5rem;
  }

  .cgpa-metric {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(122, 106, 216, 0.1);
  }

  .cgpa-metric:last-child {
    border-bottom: none;
  }

  .cgpa-metric-left,
  .cgpa-metric-center,
  .cgpa-metric-right {
    align-items: center;
  }

  .cgpa-metric-label {
    margin-bottom: 0;
    min-width: 100px;
    text-align: left;
  }

  .cgpa-metric-value-container {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

}

/* Contact form improvements */
#contact-form {
  background: rgba(255, 255, 255, 0.5);
  padding: 2rem;
  border-radius: var(--radius);
  backdrop-filter: blur(10px);
}

[data-theme="dark"] #contact-form {
  background: rgba(26, 32, 48, 0.5);
}

/* Animation for form elements */
.form-control, .form-select {
  transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
  transform: translateY(-2px);
}

/* Pulse animation for important elements */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.pulse {
  animation: pulse 2s infinite;
}

/* Floating animation */
@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}

.float {
  animation: float 3s ease-in-out infinite;
}

/* Improved scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(122, 106, 216, 0.1);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--brand);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--brand-600);
}

[data-theme="dark"] ::-webkit-scrollbar-track {
  background: rgba(122, 106, 216, 0.2);
}

[data-theme="dark"] ::-webkit-scrollbar-thumb {
  background: var(--brand-600);
}

[data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
  background: var(--brand);
}

/* NEW STYLES FOR ADDED FEATURES */

/* Back to Top Button */
#backToTop {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--brand-gradient);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 5px 15px rgba(122, 106, 216, 0.3);
  z-index: 1000;
}

#backToTop.visible {
  opacity: 1;
  visibility: visible;
}

#backToTop:hover {
  background: var(--brand-gradient-hover);
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(122, 106, 216, 0.4);
}

/* Gradient Text Animation */
.gradient-text {
  background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary));
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradient-text 3s ease infinite;
}

@keyframes gradient-text {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Why Choose Section */
.why-choose-section {
  padding: 5rem 0;
}

.why-choose-section .text-center {
  margin-bottom: 4rem;
}

.why-choose-section h2 {
  font-weight: 800;
  margin-bottom: 1rem;
}

.why-choose-section .lead {
  color: var(--text-light);
  font-size: 1.25rem;
}

.feature-card {
  background: rgba(255, 255, 255, 0.8);
  border-radius: var(--radius);
  padding: 2rem;
  height: 100%;
  text-align: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
}

.feature-card:hover {
  transform: translateY(-10px);
  box-shadow: var(--shadow-hover);
}

.feature-icon {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  background: var(--brand-gradient);
  color: white;
  font-size: 1.5rem;
  transition: all 0.3s ease;
}

.feature-card:hover .feature-icon {
  transform: scale(1.1) rotate(5deg);
}

.feature-card h5 {
  font-weight: 700;
  margin-bottom: 1rem;
  color: var(--text);
}

.feature-card p {
  color: var(--text-light);
}

/* Dark mode for Why Choose section */
[data-theme="dark"] .why-choose-section {
  background: transparent; /* Inherit from body gradient */
}

[data-theme="dark"] .feature-card {
  background: rgba(15, 20, 34, 0.8);
}

[data-theme="dark"] .feature-card h5 {
  color: #ffffff;
}

[data-theme="dark"] .feature-card p.text-muted {
    color: var(--muted) !important;
}
[data-theme="dark"] .why-choose-section .lead.text-muted {
    color: var(--text-light) !important;
}


/* Hide Why Choose section on mobile */
@media (max-width: 991.98px) {
  .why-choose-section {
    display: none;
  }
}

/* Animation for hero text */
.hero-text-gradient {
  background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary));
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradient-text 3s ease infinite;
}


/* Animation for robot icon */
.robot-icon-gradient {
  background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary), var(--accent), var(--brand-primary));
  background-size: 300% 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradient-text 3s ease infinite;
}

/* PDF Download Button */
.btn-pdf-download {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: white;
  border: 0;
  box-shadow: 0 6px 18px rgba(231, 76, 60, 0.2);
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: var(--radius-btn); /* Consistent radius */
}

.btn-pdf-download:hover {
  background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
}

/* Action buttons container */
.action-buttons {
  display: flex;
  justify-content: center; /* Center the single button */
  align-items: center;
  margin-top: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

/* Center Registration Number Input */
.scraping-section .mb-3 {
    text-align: center;
}
.scraping-section #registrationNumber {
    max-width: 350px;
    margin: 0 auto;
    text-align: center;
}

/* Drag and Drop Styles (Desktop Only) */
@media (min-width: 992px) {
  .course-table tbody tr {
    cursor: grab;
  }
  .course-table tbody tr.dragging {
    opacity: 0.5;
    background: #e9e6f8;
  }
  .semester-card.drag-over {
    border: 2px dashed var(--brand);
    transform: scale(1.02);
    background-color: rgba(122, 106, 216, 0.1);
  }
  [data-theme="dark"] .semester-card.drag-over {
    background-color: rgba(122, 106, 216, 0.2);
  }
}

/* NEW: Scroll Animation Styles */
.fade-in-on-scroll {
  opacity: 0;
  transform: translateY(30px);
  transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}
.fade-in-on-scroll.is-visible {
  opacity: 1;
  transform: translateY(0);
}

/* NEW: Forecast/Info Button Style */
.btn-info-action {
  background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
  color: white;
  border: 0;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: var(--radius-btn); /* Consistent radius */
}
.btn-info-action:hover {
  background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);
  color: white;
  transform: translateY(-2px);
}

/* NEW: Profile Manager Styles */
.profile-manager-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(122, 106, 216, 0.2);
    margin-bottom: 1rem;
}
.profile-manager-stats {
    font-size: 0.85rem;
    color: var(--muted);
}
.profile-manager-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
}
.profile-list {
    list-style: none;
    padding: 0;
    max-height: 50vh;
    overflow-y: auto;
}
.profile-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-radius: 0.75rem;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid rgba(122, 106, 216, 0.1);
    position: relative;
    background-color: rgba(98, 71, 255, 0.02);
    margin-bottom: 10px;
}
.profile-item:last-child {
    border-bottom: none;
}
.profile-item:hover {
    background-color: rgba(122, 106, 216, 0.05);
}
[data-theme="dark"] .profile-item:hover {
    background-color: rgba(122, 106, 216, 0.1);
}
.profile-item .form-check-input {
    margin-top: 0;
    transform: scale(1.2);
}
.profile-item-details {
    flex-grow: 1;
    margin-left: 1rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0 1rem;
}
.profile-item-name {
    grid-column: 1 / -1;
    font-weight: 600;
    color: var(--text);
}
.profile-item-meta {
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.3rem;
}
.profile-item-actions {
    display: flex;
    gap: 0.5rem;
}
.profile-item-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

/* Custom Confirmation Modal */
.confirmation-modal .modal-content {
    border-radius: var(--radius);
}
.confirmation-modal .modal-header {
    border-bottom: none;
}
.confirmation-modal .modal-body {
    text-align: center;
}
.confirmation-modal .modal-body .fa-triangle-exclamation {
    font-size: 2.5rem;
    color: #f39c12;
}
.confirmation-modal .modal-footer {
    border-top: none;
    justify-content: center;
}

/* Mobile adjustments for Profile Manager */
@media (max-width: 767.98px) {
    .profile-manager-toolbar {
        flex-direction: row; /* Keep in a row */
        justify-content: space-between; /* Space out items */
        align-items: center; /* Align vertically */
    }
    .profile-manager-toolbar .ms-auto {
        margin-left: 0 !important; /* Remove margin */
        width: auto; /* Allow natural width */
        margin-top: 0; /* Remove top margin */
        display: flex;
        gap: 0.5rem; /* Reduce gap */
    }
    /* --- UPDATE: Removed padding override --- */
    .profile-manager-toolbar .btn {
        font-size: 0.8rem;
        /* Removed padding rule */
    }

    .profile-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    .profile-item .form-check-input {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
    }
    .profile-item-details {
        margin-left: 0;
        grid-template-columns: 1fr; /* Stack details vertically */
        gap: 0.25rem;
    }
    .profile-item-actions {
        width: 100%;
        justify-content: space-around;
        border-top: 1px solid rgba(122, 106, 216, 0.1);
        padding-top: 0.75rem;
    }
}

/* --- Z-index and Blur for modals --- */
#renameProfileModal, #confirmationModal, #attendanceImportModal {
  z-index: 1060; /* Higher z-index to appear on top */
}
/* When rename or confirm modal is open, apply blur to profile manager */
#profileManagerModal.blur-backdrop {
  filter: blur(4px);
  transition: filter 0.15s linear;
}

/* --- Profile data buttons --- */
.profile-data-buttons {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1rem;
}
/* --- UPDATE: Use var(--radius-btn) --- */
.profile-data-buttons .btn {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-btn);
}
/* --- Mobile styles for Import/Export buttons --- */
@media (max-width: 575.98px) {
    .profile-data-buttons {
        flex-direction: row; /* Keep in row */
        gap: 0.5rem; /* Reduce gap */
        justify-content: center; /* Center horizontally */
    }
    .profile-data-buttons .btn {
        width: auto; /* Allow natural width */
        max-width: none;
        font-size: 0.8rem; /* Slightly smaller */
        padding: 0.5rem 0.8rem; /* Adjust padding */
        flex-grow: 1; /* Allow buttons to grow equally */
        max-width: 50%; /* Limit width to half */
    }
}
/* NEW: Styles for Attendance Import Modal */
.attendance-modal-toolbar {
    display: flex;
    justify-content: flex-end; /* Align button to the right */
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(122, 106, 216, 0.2);
    margin-bottom: 1rem;
}

#attendanceCourseList {
    max-height: 50vh; /* Limit height and allow scrolling */
    overflow-y: auto;
}

.attendance-course-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem;
  border-bottom: 1px solid rgba(122, 106, 216, 0.1);
  transition: background-color 0.2s ease;
}
.attendance-course-item:last-child {
  border-bottom: none;
}
.attendance-course-item.already-exists {
  opacity: 0.6;
  background-color: rgba(108, 117, 125, 0.05);
}
[data-theme="dark"] .attendance-course-item.already-exists {
    background-color: rgba(108, 117, 128, 0.1);
}
.attendance-course-item.already-exists .form-check-input {
  /* Prevent checking already existing items unless 'Show All' is active */
  /* pointer-events: none; /* Removed: Allow override */
}
.attendance-course-item .form-check {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-grow: 1; /* Allow text section to grow */
  margin-right: 1rem; /* Space before CH select */
}
.attendance-course-item .form-check-label {
  line-height: 1.3;
}
.attendance-course-item .form-check-label small {
  font-size: 0.8rem;
  white-space: normal; /* Allow title to wrap */
}
.attendance-course-item .form-check-label .already-exists-label {
    font-size: 0.7rem;
    color: var(--muted);
    font-style: italic;
    margin-left: 5px;
}
.attendance-course-item .import-ch-select {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0; /* Prevent shrinking */
}
.attendance-course-item .import-ch-select .form-select {
  width: 80px;
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
  font-size: 0.9rem;
}

@media (max-width: 576px) {
  .attendance-course-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
   .attendance-course-item .form-check {
       width: 100%;
       margin-right: 0;
   }
  .attendance-course-item .import-ch-select {
    width: 100%;
    justify-content: space-between;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px dashed rgba(122, 106, 216, 0.2);
  }
}
  </style>
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CMENQJ4ELS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CMENQJ4ELS');
</script>

<body>

  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MJW7HPPS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="cursor-dot" id="cursorDot"></div>

  <div id="backToTop">
    <i class="fas fa-arrow-up"></i>
  </div>

  <!-- MODALS -->
  <div class="modal fade course-details-modal" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="courseDetailsModalTitle">Course Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="courseDetailsModalBody">
            <!-- Content will be injected by JS -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-plus-circle me-2"></i>Add Custom Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCourseForm">
            <input type="hidden" id="addCourseSemester" value="">
            <div class="mb-3">
              <label for="courseCode" class="form-label">Course Code</label>
              <input type="text" class="form-control" id="courseCode" placeholder="e.g., CHEM-101" required>
            </div>
            <div class="mb-3">
              <label for="courseTitle" class="form-label">Course Title</label>
              <input type="text" class="form-control" id="courseTitle" placeholder="e.g., Inorganic Chemistry" required>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label for="creditHours" class="form-label">Credit Hours</label>
                <select class="form-select" id="creditHours" required>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label for="courseMarks" class="form-label">Marks Obtained</label>
                <input type="number" class="form-control" id="courseMarks" min="0" max="100" placeholder="e.g., 75" required>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action rounded-pill" id="saveCourseBtn">Add Course</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="renameProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg"> <!-- Added shadow -->
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Rename Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="renameProfileForm">
            <div class="mb-3">
              <label for="newProfileName" class="form-label">Profile Name</label>
              <input type="text" class="form-control" id="newProfileName" required>
              <div class="form-text">Give this profile a unique name (e.g., "My Final Year Forecast").</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action rounded-pill" id="saveProfileNameBtn">Save Name</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE IMPORT MODAL -->
  <div class="modal fade" id="attendanceImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-clipboard-user me-2"></i>Import Courses from Attendance System</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
           <div class="attendance-modal-toolbar">
                <button class="btn btn-sm btn-secondary-action rounded-pill" id="toggleShowAllAttendanceBtn">
                    <i class="fa-solid fa-eye me-1"></i> Show All Courses
                </button>
            </div>
          <p class="text-muted small" id="attendanceModalDescription">Select courses to import and set their credit hours. Courses marked in grey might already exist in your LMS results.</p>
          <div id="attendanceCourseList">
             <!-- Courses will be dynamically loaded here -->
             <p class="text-center text-muted p-3">Loading attendance data...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary-action rounded-pill" id="importAttendanceCoursesBtn">Import Selected Courses</button>
        </div>
      </div>
    </div>
  </div>


  <!-- PROFILE MANAGER MODAL -->
  <div class="modal fade" id="profileManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-users-gear me-2"></i>Profile Manager</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="profile-manager-header">
                    <h6 class="mb-0">Manage Your Saved Profiles</h6>
                    <div class="profile-manager-stats">
                        <span id="profileCountStat">0 Profiles</span> |
                        <span id="lastBackupStat">Last Backup: Never</span>
                    </div>
                </div>
                <div class="profile-manager-toolbar">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllProfiles">
                        <label class="form-check-label" for="selectAllProfiles">Select All</label>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-secondary-action btn-sm dropdown-toggle rounded-3" type="button" id="bulkActionsBtn" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                            Bulk Actions
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="bulkActionsBtn">
                            <li><a class="dropdown-item text-danger" href="#" id="deleteSelectedBtn"><i class="fa-solid fa-trash-can me-2"></i>Delete Selected</a></li>
                        </ul>
                    </div>
                    <div class="ms-auto d-flex gap-2">
                         <button class="btn btn-success-action btn-sm rounded-3" id="importProfilesBtnModal"><i class="fa-solid fa-upload me-2"></i>Import</button>
                         <button class="btn btn-info-action btn-sm rounded-3" id="exportProfilesBtnModal" disabled><i class="fa-solid fa-download me-2"></i>Export Selected</button>
                    </div>
                </div>
                <ul class="profile-list" id="profileManagerList">
                    <!-- Profiles will be dynamically inserted here -->
                     <li class="text-center text-muted p-4">Loading profiles...</li>
                </ul>
            </div>
        </div>
    </div>
  </div>

  <!-- CUSTOM CONFIRMATION MODAL -->
  <div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body">
          <i class="fa-solid fa-triangle-exclamation mb-3"></i>
          <h5 class="modal-title mb-2" id="confirmationModalTitle">Are you sure?</h5>
          <p id="confirmationModalBody" class="text-muted small">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary-action rounded-pill" data-bs-dismiss="modal" id="confirmationCancelBtn">Cancel</button>
          <button type="button" class="btn btn-danger-action rounded-pill" id="confirmationConfirmBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg sticky-top border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <span class="badge rounded-pill badge-brand">UAF</span>
        <span class="gradient-text">CGPA Calculator</span>
      </a>
      <div class="d-flex align-items-center gap-2 order-lg-2">
        <button id="themeToggle" class="btn btn-sm btn-soft rounded-pill" type="button" aria-label="Toggle dark mode" style="margin-bottom: 0.01rem;">
          <i class="fa-solid fa-moon"></i>
        </button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item">
            <a class="nav-link" href="#Home"><i class="fa-solid fa-house me-2"></i>Home</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#Auto-Calculator"><i class="fa-solid fa-calculator me-2"></i>CGPA Calculator</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#features"><i class="fa-solid fa-star me-2"></i>Features</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#faq"><i class="fa-solid fa-circle-question me-2"></i>FAQ</a>
            </li>
            <li class="nav-item">
            <a class="nav-link" href="#contact-us"><i class="fa-solid fa-envelope me-2"></i>Contact</a>
            </li>
        </ul>
        </div>
    </div>
  </nav>

  <!-- HERO SECTION -->
  <section class="hero" id="Home">
    <div class="container">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <span class="badge rounded-pill badge-brand mb-3">University of Agriculture Faisalabad</span>
          <h1 class="display-5 mb-3">Calculate Your <span class="hero-text-gradient">CGPA & Percentage </span>Automatically from <span class="hero-text-gradient">UAF CGPA Calculator</span></h1>
          <p class="lead mb-4">Enter your <strong>registration number</strong> to fetch your results directly from UAF LMS &amp; Attendance System. Automatically compute your CGPA and Percentage.</p>
          <div class="d-flex gap-2">
            <a href="#Auto-Calculator" class="btn btn-primary-action btn-lg rounded-pill" style="font-size: 1.05rem; padding: 0.9rem;">
              <i class="fa-solid fa-bolt me-2"></i>Try It Now
            </a>
            <a href="#features" class="btn btn-secondary-action rounded-pill" style="display:block; padding:14px">
              <i class="fa-solid fa-star me-2"></i>Features
            </a>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card card-modern fade-in-on-scroll">
            <div class="card-body p-4">
              <div class="d-flex align-items-center gap-3">
                <div class="display-6 robot-icon-gradient"><i class="fa-solid fa-robot"></i></div>
                <div>
                  <h3 class="mb-1 fw-bold" style="font-size:22px">Key Features</h3>
                  <p class="mb-0 text-body-secondary">Automatically fetch & analyze your official UAF results.</p>
                </div>
              </div>
              <hr class="my-4" />
              <ul class="list-unstyled m-0">
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> Fetch from both LMS & Attendance System.</li>
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> Import missing courses easily.</li>
                <li class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-check text-success"></i> Forecast your future CGPA with editing tools.</li>
                <li class="d-flex align-items-center gap-2"><i class="fa-solid fa-check text-success"></i> Download a professional PDF transcript.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ANNOUNCEMENT BAR -->
  <div class="announcement-bar">
    <div class="announcement-track">
        <span class="announcement-text"><i class="fa-solid fa-circle-info me-2"></i>Highest marks in repeated courses count towards CGPA.</span>
        <span class="announcement-text"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Use 'Forecast Semester' to plan future grades.</span>
        <span class="announcement-text"><i class="fa-solid fa-arrows-up-down-left-right me-2"></i>Drag & drop courses between semesters (Desktop).</span>
        <span class="announcement-text"><i class="fa-solid fa-clipboard-user me-2"></i>Use 'Attendance System' to import missing courses.</span>
        <!-- Duplicated for smooth scrolling -->
        <span class="announcement-text"><i class="fa-solid fa-circle-info me-2"></i>Highest marks in repeated courses count towards CGPA.</span>
        <span class="announcement-text"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Use 'Forecast Semester' to plan future grades.</span>
        <span class="announcement-text"><i class="fa-solid fa-arrows-up-down-left-right me-2"></i>Drag & drop courses between semesters (Desktop).</span>
        <span class="announcement-text"><i class="fa-solid fa-clipboard-user me-2"></i>Use 'Attendance System' to import missing courses.</span>
    </div>
</div>

  <!-- CALCULATOR SECTION -->
  <section class="py-5" id="Auto-Calculator" style="padding-bottom: 0rem !important;">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-10">
          <div class="calculator-section-modern fade-in-on-scroll">
            <div class="text-center mb-4">
              <h2 class="fw-bold">
                <i class="fa-solid fa-calculator me-2 gradient-text"></i>
                <span class="gradient-text">UAF CGPA Calculator</span>
              </h2>
              <p class="text-muted">Enter a registration number or select a saved profile.</p>
            </div>
            <form id="resultForm" class="text-center">
              <div class="search-and-profiles-container">
                <div class="modern-search-wrapper">
                  <input type="text" class="form-control modern-search-input" id="registrationNumber" placeholder="e.g., 2020-ag-1234" required />
                  <button type="submit" class="btn btn-primary-action modern-search-button">
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                    <span class="d-none d-md-inline ms-2">Fetch Result</span>
                  </button>
                </div>

                <div class="profile-data-buttons">
                    <button class="btn btn-success-action btn-sm" type="button" id="importProfilesBtn"><i class="fa-solid fa-upload me-2"></i>Import Profiles</button>
                    <button class="btn btn-info-action btn-sm" type="button" id="exportProfilesBtn"><i class="fa-solid fa-download me-2"></i>Export Profiles</button>
                </div>

                <div id="profileManagement" class="modern-profiles-wrapper" style="display: none;">
                  <div class="input-group">
                    <span class="input-group-text modern-profiles-icon"><i class="fa-solid fa-user-check"></i></span>
                    <select class="form-select modern-profiles-select" id="profileSwitcher"></select>
                    <button class="btn btn-primary-action" type="button" id="openProfileManagerBtn" title="Manage All Profiles">
                      <i class="fa-solid fa-users-gear"></i><span class="d-none d-sm-inline ms-1">Manage</span>
                    </button>
                  </div>
                </div>
              </div>
            </form>
            <div class="loading-container" id="loadingContainer">
              <div class="loading-stage" id="connectingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Connecting...</p><p class="loading-subtext">Establishing secure connection to university servers</p></div>
              <div class="loading-stage" id="fetchingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Fetching Results...</p><p class="loading-subtext">Retrieving academic records from the database</p></div>
              <div class="loading-stage" id="processingStage"><div class="loading-animation loading-connecting"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div><p class="loading-text">Processing Data...</p><p class="loading-subtext">Analyzing grades and calculating CGPA</p></div>
              <div class="loading-stage" id="completeStage"><div class="loading-animation loading-complete"><div class="checkmark"></div></div><p class="loading-text">Results Ready!</p><p class="loading-subtext">CGPA calculated successfully</p></div>
            </div>
          </div> <!-- End calculator-section-modern -->

          <!-- RESULTS CONTAINER -->
          <div id="resultContainer" class="result-container">

            <!-- Premium CGPA Display -->
            <div class="gpa-result-card-premium fade-in-on-scroll">
              <div class="student-info-header">
                <h2 class="mb-0 fw-bold" id="studentName"><i class="fa-solid fa-user-graduate me-2"></i>Student Name</h2>
                <p class="mb-0 text-body-secondary" id="studentReg">Registration Number</p>
              </div>
              <div class="cgpa-dashboard">
                <div class="cgpa-progress-circle">
                  <svg viewBox="0 0 36 36">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path id="cgpaCircle" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                  </svg>
                  <div class="cgpa-progress-text">
                    <span id="totalCgpa" class="cgpa-value">0.00</span>
                    <span class="cgpa-label">CGPA</span>
                  </div>
                </div>
              </div>
              <div class="secondary-stats">
                  <div class="stat-item">
                      <span class="stat-label">Percentage</span>
                      <span class="stat-value" id="totalPercentage">0.00%</span>
                  </div>
                  <div class="stat-divider"></div>
                  <div class="stat-item">
                      <span class="stat-label">Total Marks</span>
                      <span class="stat-value">
                          <span id="totalMarksObtained">0</span><span id="totalMaxMarks" class="stat-sub-value">/ 0</span>
                      </span>
                  </div>
              </div>
            </div>

            <!-- GPA Trend Chart -->
             <div class="card card-modern mt-4 fade-in-on-scroll" id="gpaChartContainer" style="display: none;">
                <div class="card-header p-0">
                <a href="#gpaChartCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="gpaChartCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 text-body"><i class="fa-solid fa-chart-line me-2"></i>GPA Trend</h4>
                    <i class="fa-solid fa-chevron-down text-body" id="gpaChartChevron"></i>
                    </div>
                </a>
                </div>
                <div class="collapse" id="gpaChartCollapse">
                <div class="card-body">
                    <canvas id="gpaTrendChart"></canvas>
                </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-aligned fade-in-on-scroll">
              <button id="fetchAttendanceBtn" class="btn btn-success-action"><i class="fa-solid fa-clipboard-user me-2"></i>Attendance System</button>
              <button id="downloadPdfBtn" class="btn btn-pdf-download"><i class="fa-solid fa-file-pdf me-2"></i>Download PDF</button>
              <button id="addForecastSemesterBtn" class="btn btn-info-action"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Forecast Semester</button>
            </div>

            <!-- Semester Results -->
            <div class="semester-results-container">
              <div id="semesterResults" class="semester-grid">
                  <!-- Semester cards will be loaded here -->
              </div>
            </div>

          </div> <!-- End resultContainer -->

          <!-- STATUS LOG -->
          <div class="card card-modern mt-4 fade-in-on-scroll">
            <div class="card-header p-0">
                <a href="#statusLogCollapse" class="d-block text-decoration-none p-3" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="statusLogCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 text-body"><i class="fa-solid fa-terminal me-2"></i>Status Log</h4>
                        <i class="fa-solid fa-chevron-down text-body status-log-chevron"></i>
                    </div>
                </a>
            </div>
            <div class="collapse" id="statusLogCollapse">
                <div class="card-body p-4">
                    <div class="status-log" id="statusLog">
                        <div class="status-line status-info">Ready to fetch results. Enter registration number and click "Fetch Result".</div>
                    </div>
                    <div class="log-section center-buttons mt-3">
                        <button id="downloadLogBtn" class="btn btn-secondary-action rounded-pill"><i class="fa-solid fa-file-lines me-2"></i>Download Log</button>
                        <button id="clearLogBtn" class="btn btn-danger-action rounded-pill"><i class="fa-solid fa-trash me-2"></i>Clear Log</button>
                    </div>
                </div>
            </div>
          </div> <!-- End Status Log Card -->

        </div> <!-- End col-md-10 -->
      </div> <!-- End row -->
    </div> <!-- End container -->
  </section>

  <!-- FEATURES SECTION -->
  <section class="why-choose-section" id="features">
    <div class="container">
      <div class="text-center mb-5 fade-in-on-scroll">
        <h2 class="fw-bold">Why Choose Our <span class="gradient-text">CGPA Calculator</span></h2>
        <p class="lead text-muted">The most advanced and feature-rich calculation tool for UAF students.</p>
      </div>
      <div class="row g-4">
        <div class="col-md-6 col-lg-3">
          <div class="feature-card fade-in-on-scroll">
            <div class="feature-icon"><i class="fas fa-robot"></i></div>
            <h5>Instant & Automatic</h5>
            <p class="text-muted">Fetch your complete academic record from UAF LMS & Attendance System in seconds. No manual entry needed.</p>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="feature-card fade-in-on-scroll">
            <div class="feature-icon"><i class="fas fa-edit"></i></div>
            <h5>Forecast & Edit</h5>
            <p class="text-muted">Forecast CGPA by adding courses, deleting semesters, or drag-and-dropping subjects between semesters.</p>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="feature-card fade-in-on-scroll">
            <div class="feature-icon"><i class="fas fa-file-pdf"></i></div>
            <h5>Premium PDF Export</h5>
            <p class="text-muted">Generate a beautifully designed, professional transcript of your results with a single click for your records.</p>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="feature-card fade-in-on-scroll">
            <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
            <h5>Secure & Personal</h5>
            <p class="text-muted">No password needed. Data saved locally in your browser. Modern interface with dark mode & profile management.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <main>
    <section class="py-5" id="faq">
      <div class="container">
        <div class="text-center mb-5 fade-in-on-scroll">
          <h2 class="fw-bold">Frequently Asked Questions</h2>
          <p class="lead text-muted">Answers to common questions about the UAF CGPA Calculator.</p>
        </div>
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="accordion" id="faqAccordion">
              <div class="accordion-item card-modern mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    How does the UAF CGPA Calculator work?
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <strong>Our CGPA Calculator</strong> securely connects to the public UAF LMS portal and Attendance System using your registration number. It fetches your official results, processes grades and credit hours per the official UAF formula, allows importing missing courses, and instantly calculates your Semester GPA and Cumulative GPA (CGPA).
                  </div>
                </div>
              </div>
              <div class="accordion-item card-modern mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Is it safe to use my registration number?
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <strong>Yes, This CGPA Calculator by M Saqlain is completely safe.</strong> It only requires your registration number (no password). Your info is used solely for fetching results during your current session and isn't stored on external servers. The connection is secure. Data profiles are saved locally in *your* browser.
                  </div>
                </div>
              </div>
              <div class="accordion-item card-modern mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingThree">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Can I use this for other universities?
                  </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    This calculator is specifically for <strong>University of Agriculture Faisalabad (UAF)</strong> students. It uses UAF's grading system and connects to UAF's specific portals (LMS & Attendance), so it won't work for other universities.
                  </div>
                </div>
              </div>
               <div class="accordion-item card-modern mb-3 fade-in-on-scroll">
                <h2 class="accordion-header" id="headingFour">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                    Why use the 'Attendance System' button?
                  </button>
                </h2>
                <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    Sometimes, courses might appear in the UAF Attendance System results (<a href="http://121.52.152.24/" target="_blank" rel="noopener noreferrer">http://121.52.152.24/</a>) but might be missing or delayed in the main LMS portal. Clicking the 'Attendance System' button fetches results from there and allows you to easily import any missing courses (like electives or recently graded subjects) into your profile for a more complete and accurate CGPA calculation. You'll need to specify the credit hours for imported courses.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- CONTACT SECTION -->
  <section class="py-5" id="contact-us">
    <div class="container">
      <div class="row g-4">
        <div class="col-lg-6 fade-in-on-scroll">
          <h3 class="fw-bold mb-2">Contact</h3>
          <p class="text-body-secondary">Questions or suggestions? Send a message.</p>
          <form id="contact-form" action="https://formspree.io/f/xblrolwp" method="post" class="needs-validation" novalidate>
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label" for="name">Your Name</label><input class="form-control" id="name" name="name" placeholder="e.g., Ali Raza" required /><div class="invalid-feedback">Please enter your name.</div></div>
              <div class="col-md-6"><label class="form-label" for="email">Email</label><input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required /><div class="invalid-feedback">Enter a valid email.</div></div>
              <div class="col-12"><label class="form-label" for="message">Message</label><textarea class="form-control" id="message" name="message" rows="4" placeholder="Write your message..." required></textarea><div class="invalid-feedback">Please write a message.</div></div>
              <div class="col-12"><button class="btn btn-primary-action rounded-pill" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Send</button></div>
              <div id="contact-form-status" class="mt-2 small"></div>
            </div>
          </form>
        </div>
        <div class="col-lg-6 fade-in-on-scroll">
          <div class="h-100 p-4 p-lg-5 rounded-4" style="background:linear-gradient(180deg, rgba(122,106,216,.15), rgba(122,106,216,.05));">
            <h5 class="fw-bold">Developer</h5>
            <div class="d-flex align-items-center gap-3 mt-2">
              <img src="assets/images/UAF CGPA Calculator Developer - M Saqlain.webp" alt="Muhammad Saqlain - Developer of UAF CGPA Calculator" class="rounded-circle" width="86" height="86" />
              <div>
                <div class="fw-semibold">Muhammad Saqlain</div><div class="text-body-secondary small">BS Chemistry (2020â€“2024)</div>
                <div class="d-flex gap-3 mt-2">
                  <a class="text-decoration-none" href="https://www.facebook.com/UAFChemist.Rustam" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-facebook"></i></a>
                  <a class="text-decoration-none" href="https://x.com/M_Saqlain_Akbar" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-x-twitter"></i></a>
                  <a class="text-decoration-none" href="https://www.linkedin.com/in/muhammad-saqlain-akbar/" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-linkedin"></i></a>
                </div>
              </div>
            </div>
            <hr class="my-4" /><p class="mb-0 small text-body-secondary">Share this tool with your friends to support the project. â™¥</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="border-top py-4" style="margin-top: 30px;">
    <div class="container text-center footer">
      <p class="mb-1">UAF CGPA Calculator - A project by <a href="#contact-us">M Saqlain</a>.</p>
      <p class="mb-0">Â© 2025 UAFTools. All rights reserved.</p>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const resultForm = document.getElementById('resultForm');
      const registrationNumber = document.getElementById('registrationNumber');
      const resultContainer = document.getElementById('resultContainer');
      const statusLog = document.getElementById('statusLog');
      const themeToggle = document.getElementById('themeToggle');
      const cursorDot = document.getElementById('cursorDot');
      const contactForm = document.getElementById('contact-form');
      const downloadLogBtn = document.getElementById('downloadLogBtn');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const semesterResults = document.getElementById('semesterResults');
      const studentName = document.getElementById('studentName');
      const studentReg = document.getElementById('studentReg');
      const totalCgpa = document.getElementById('totalCgpa');
      const totalPercentage = document.getElementById('totalPercentage');
      const totalMarksObtained = document.getElementById('totalMarksObtained');
      const totalMaxMarks = document.getElementById('totalMaxMarks');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      const courseDetailsModalEl = document.getElementById('courseDetailsModal');
      const courseDetailsModal = new bootstrap.Modal(courseDetailsModalEl);
      const addCourseModalEl = document.getElementById('addCourseModal');
      const addCourseModal = new bootstrap.Modal(addCourseModalEl);
      const saveCourseBtn = document.getElementById('saveCourseBtn');
      const addCourseForm = document.getElementById('addCourseForm');
      const loadingContainer = document.getElementById('loadingContainer');
      const backToTopButton = document.getElementById('backToTop');
      const addForecastSemesterBtn = document.getElementById('addForecastSemesterBtn');
      const gpaChartContainer = document.getElementById('gpaChartContainer');
      const gpaTrendChartCanvas = document.getElementById('gpaTrendChart').getContext('2d');
      const profileManagementDiv = document.getElementById('profileManagement');
      const profileSwitcher = document.getElementById('profileSwitcher');
      const renameProfileModalEl = document.getElementById('renameProfileModal'); // Get the element
      const renameProfileModal = new bootstrap.Modal(renameProfileModalEl);
      const saveProfileNameBtn = document.getElementById('saveProfileNameBtn');

      // Attendance System Elements
      const fetchAttendanceBtn = document.getElementById('fetchAttendanceBtn');
      const attendanceImportModalEl = document.getElementById('attendanceImportModal'); // Get the element
      const attendanceImportModal = new bootstrap.Modal(attendanceImportModalEl);
      const importAttendanceCoursesBtn = document.getElementById('importAttendanceCoursesBtn');
      const toggleShowAllAttendanceBtn = document.getElementById('toggleShowAllAttendanceBtn');
      const attendanceCourseListEl = document.getElementById('attendanceCourseList');

      // Profile Manager Elements
      const openProfileManagerBtn = document.getElementById('openProfileManagerBtn');
      const profileManagerModalEl = document.getElementById('profileManagerModal'); // Get the element
      const profileManagerModal = new bootstrap.Modal(profileManagerModalEl);
      const confirmationModalEl = document.getElementById('confirmationModal'); // Get the element
      const confirmationModal = new bootstrap.Modal(confirmationModalEl);

      // Import/Export buttons
      const importProfilesBtn = document.getElementById('importProfilesBtn');
      const exportProfilesBtn = document.getElementById('exportProfilesBtn');
      const importProfilesBtnModal = document.getElementById('importProfilesBtnModal'); // In modal
      const exportProfilesBtnModal = document.getElementById('exportProfilesBtnModal'); // In modal

      // State
      let allLogs = [];
      let processedData = null; // Holds the current profile data (LMS + custom/imported)
      let deletedSemesters = {};
      let gpaChart = null;
      let isInitialLoad = true;
      let confirmationCallback = null;
      let allAttendanceCourses = []; // Store all fetched attendance courses
      let showAllAttendance = false; // Flag for modal view toggle

      const API_ENDPOINT = `/api/result-scraper?action=scrape_single`;
      const ATTENDANCE_API_ENDPOINT = `/api/result-scraper?action=scrape_attendance`;

      // --- Initialization ---
      function init() {
        migrateOldProfiles();
        initCustomCursor();
        initTheme();
        initContactForm();
        createToastContainer();
        initBackToTop();
        initScrollAnimations();
        loadProfiles();
        initModalZIndexHandlers();
        // Disable attendance button initially until results are loaded
        fetchAttendanceBtn.disabled = true;
      }

      function initModalZIndexHandlers() {
        [renameProfileModalEl, confirmationModalEl, attendanceImportModalEl].forEach(modalEl => {
          modalEl.addEventListener('show.bs.modal', function () {
            if (profileManagerModalEl.classList.contains('show')) {
                 profileManagerModalEl.classList.add('blur-backdrop');
            } else {
                 // Blur main content if profile manager isn't open
                 document.querySelector('.hero').style.filter = 'blur(4px)';
                 document.querySelector('#Auto-Calculator').style.filter = 'blur(4px)';
            }
          });
          modalEl.addEventListener('hide.bs.modal', function () {
            profileManagerModalEl.classList.remove('blur-backdrop');
            document.querySelector('.hero').style.filter = 'none';
            document.querySelector('#Auto-Calculator').style.filter = 'none';
          });
        });
      }


      // --- Profile Management (No changes needed from previous version) ---
       function migrateOldProfiles() {
          const oldProfilesData = localStorage.getItem('uafCalculatorProfiles');
          if (oldProfilesData) {
              try {
                  const oldProfiles = JSON.parse(oldProfilesData);
                  const newProfiles = getProfiles();
                  let migratedCount = 0;

                  Object.keys(oldProfiles).forEach(oldId => {
                      const oldProfile = oldProfiles[oldId];
                      // Ensure old profile has necessary structure before migration
                      if (oldProfile && oldProfile.studentInfo && oldProfile.studentInfo.registration) {
                           const alreadyExists = Object.values(newProfiles).some(
                                p => p.studentInfo && p.studentInfo.registration === oldProfile.studentInfo.registration
                            );

                            if (!alreadyExists) {
                                const newProfile = {
                                    ...oldProfile,
                                    displayName: `${oldProfile.studentInfo.name || 'Profile'} (${oldProfile.studentInfo.registration})`,
                                    createdAt: new Date().toISOString(),
                                    lastModified: new Date().toISOString()
                                };
                                const newId = `profile_${Date.now()}_${migratedCount}`;
                                newProfiles[newId] = newProfile;
                                migratedCount++;
                            }
                      }
                  });

                  if (migratedCount > 0) {
                      saveProfiles(newProfiles);
                      showToast(`${migratedCount} profile(s) from a previous version migrated!`, 'success');
                  }
                  localStorage.removeItem('uafCalculatorProfiles');
              } catch (e) {
                  console.error("Failed to migrate old profiles:", e);
              }
          }
      }
      function getProfiles() { return JSON.parse(localStorage.getItem('uafCalculatorProfiles_v2') || '{}'); }
      function saveProfiles(profiles) { localStorage.setItem('uafCalculatorProfiles_v2', JSON.stringify(profiles)); }
      function getActiveProfileId() { return localStorage.getItem('uafCalculatorActiveProfile_v2'); }
      function setActiveProfileId(id) { localStorage.setItem('uafCalculatorActiveProfile_v2', id || ''); } // Ensure empty string if no id
      function getBackupInfo() { return JSON.parse(localStorage.getItem('uafCalculatorBackupInfo') || '{}'); }
      function saveBackupInfo(info) { localStorage.setItem('uafCalculatorBackupInfo', JSON.stringify(info)); }
      function loadProfiles() {
        const profiles = getProfiles();
        const activeProfileId = getActiveProfileId();
        updateProfileSwitcher(profiles, activeProfileId);
        if (activeProfileId && profiles[activeProfileId]) {
          loadProfile(activeProfileId);
          addStatusMessage('Loaded active profile.', 'info');
        } else {
            // No active profile, ensure UI is reset
            resultContainer.style.display = 'none';
            fetchAttendanceBtn.disabled = true; // Disable attendance btn if no profile loaded
        }
      }
      function updateProfileSwitcher(profiles, activeProfileId) {
        const profileKeys = Object.keys(profiles);
        profileSwitcher.innerHTML = '<option value="">Select a saved profile...</option>'; // Reset
        if (profileKeys.length > 0) {
          profileKeys.sort((a, b) => (profiles[b].lastModified || '').localeCompare(profiles[a].lastModified || '')) // Sort by last modified desc
            .forEach(profileId => {
              const profile = profiles[profileId];
              if (profile && profile.studentInfo) {
                  const option = document.createElement('option');
                  option.value = profileId;
                  option.textContent = profile.displayName || `${profile.studentInfo.name || 'Unnamed'} (${profile.studentInfo.registration || 'N/A'})`;
                  if (profileId === activeProfileId) {
                    option.selected = true;
                  }
                  profileSwitcher.appendChild(option);
              }
            });
          profileManagementDiv.style.display = 'block';
        } else {
          profileManagementDiv.style.display = 'none';
        }
      }
       function loadProfile(profileId) {
        const profiles = getProfiles();
        if (profiles[profileId]) {
          processedData = profiles[profileId];
          isInitialLoad = true;
          // Ensure originalSemester is present (for backward compatibility)
          Object.values(processedData.semesters).forEach(sem => {
              sem.courses.forEach(c => {
                  if (!c.originalSemester) c.originalSemester = sem.originalName;
              })
          });

          const cgpaData = calculateCGPA(processedData); // Recalculate on load
          displayCGPAResults(processedData, cgpaData);
          registrationNumber.value = processedData.studentInfo.registration || '';
          setActiveProfileId(profileId);
          updateProfileSwitcher(profiles, profileId);
           fetchAttendanceBtn.disabled = false; // Enable attendance btn when a profile is loaded
        } else {
             showToast(`Profile with ID ${profileId} not found.`, 'error');
             setActiveProfileId(''); // Clear invalid active ID
             loadProfiles(); // Reload to reset UI
        }
      }
      function switchProfile(event) {
        const profileId = event.target.value;
        if (profileId) {
          loadProfile(profileId);
          showToast(`Switched to profile: ${getProfiles()[profileId]?.displayName || 'Selected Profile'}`, 'info');
        } else {
            // User selected "Select a saved profile..."
            processedData = null;
            resultContainer.style.display = 'none';
            setActiveProfileId('');
            registrationNumber.value = '';
            fetchAttendanceBtn.disabled = true;
        }
      }
      function saveActiveProfile() {
        const activeProfileId = getActiveProfileId();
        if (activeProfileId && processedData) {
            const profiles = getProfiles();
            if (profiles[activeProfileId]) {
                processedData.lastModified = new Date().toISOString();
                profiles[activeProfileId] = processedData; // Save the entire current state
                saveProfiles(profiles);
            }
        }
      }
      function openRenameModal(profileId) { /* ... no changes ... */ }
      function renameProfile() { /* ... no changes ... */ }
      function showConfirmationModal(title, body, onConfirm) { /* ... no changes ... */ }
      function handleConfirm() { /* ... no changes ... */ }
      function renderProfileManager() { /* ... no changes ... */ }
      function handleBulkAction() { /* ... no changes ... */ }
      function deleteProfiles(idsToDelete) { /* ... no changes, but ensures fetchAttendanceBtn is disabled if active profile deleted */
          const profiles = getProfiles();
          let deletedCount = 0;
          let activeDeleted = false;
          idsToDelete.forEach(id => {
              if (profiles[id]) {
                  delete profiles[id];
                  deletedCount++;
                  if (getActiveProfileId() === id) {
                      setActiveProfileId('');
                      activeDeleted = true;
                  }
              }
          });
          saveProfiles(profiles);
          showToast(`Successfully deleted ${deletedCount} profile(s).`, 'success');
          renderProfileManager();
          updateProfileSwitcher(profiles, getActiveProfileId());
          if (activeDeleted) { // Reset UI only if the active one was deleted
              processedData = null;
              resultContainer.style.display = 'none';
              registrationNumber.value = '';
              fetchAttendanceBtn.disabled = true;
          }
      }
      function exportSelectedProfiles() { /* ... no changes ... */ }
      function importProfiles() { /* ... no changes ... */ }
      // --- End Profile Management ---


      // --- UI & Helpers (Theme, Cursor, Toasts, etc.) ---
      function initCustomCursor() { /* ... no changes ... */ }
      function initTheme() { /* ... no changes ... */ }
      function initContactForm() { /* ... no changes ... */ }
      function createToastContainer() { /* ... no changes ... */ }
      function showToast(message, type = 'success') { /* ... no changes ... */ }
      function addStatusMessage(message, type = 'info') { /* ... no changes ... */ }
      function showLoadingStage(stage) { /* ... no changes ... */ }
      function downloadLog() { /* ... no changes ... */ }
      function clearLog() { /* ... no changes ... */ }
      function initBackToTop() { /* ... no changes ... */ }
      function initScrollAnimations() { /* ... no changes ... */ }
      function formatNumber(value, places = 4) { return parseFloat(Number(value).toFixed(places)); } // Added Number() for robustness
      // --- End UI & Helpers ---


      // --- Semester & Course Processing ---

        /**
         * Processes semester names from LMS or Attendance system strings into a standardized format.
         * Applies the specific year logic for Winter vs. Spring.
         * Example LMS: "Spring Semester 2024-25" -> "Spring 2025"
         * Example LMS: "Winter Semester 2024-25" -> "Winter 2024"
         * Example Attendance: "Spring25" -> "Spring 2025"
         * Example Attendance: "Winter24" -> "Winter 2024"
         */
        function processSemesterName(semester) {
            if (!semester || typeof semester !== 'string') return 'Unknown Semester';
            semester = semester.toLowerCase().trim();
            let season = '';
            let year = '';

            // Extract season
            if (semester.includes('winter')) season = 'Winter';
            else if (semester.includes('spring')) season = 'Spring';
            else if (semester.includes('summer')) season = 'Summer';
            else if (semester.includes('fall')) season = 'Fall';
            else return semester.charAt(0).toUpperCase() + semester.slice(1); // Return original if no known season

            // Extract year (handles formats like 2024-25, 24-25, 25, 2025)
            const yearMatch = semester.match(/(\d{4})[-â€“]?(\d{2,4})?|\b(\d{2})\b/); // Matches YYYY-YY, YYYY-YYYY, YY, YYYY
            if (yearMatch) {
                if (yearMatch[1]) { // Format YYYY-YY or YYYY-YYYY
                    const startYear = parseInt(yearMatch[1]);
                    if (season === 'Spring' || season === 'Summer') {
                        // Spring/Summer belong to the *ending* year of the session
                        if (yearMatch[2]) { // YYYY-YY or YYYY-YYYY
                             year = yearMatch[2].length === 2 ? `20${yearMatch[2]}` : yearMatch[2];
                        } else { // Only YYYY found
                             // Assume it's the start year, add 1 for Spring/Summer? This is ambiguous.
                             // Let's assume if only YYYY is found, it IS the correct year.
                             year = startYear.toString();
                        }
                    } else { // Winter/Fall belong to the *starting* year
                        year = startYear.toString();
                    }
                } else if (yearMatch[3]) { // Format YY found (likely from attendance system)
                    const shortYear = parseInt(yearMatch[3]);
                    // Basic assumption: YY refers to 20YY
                    year = `20${shortYear}`;
                    // Apply Spring/Summer +1 year logic ONLY if it looks like a session end year
                    // This is tricky. Let's assume Spring YY means 20YY, not 20(YY+1) unless LMS data suggests otherwise.
                    // The comparison logic will handle matching 'Spring 2025' and 'Spring25'.
                }
            } else {
                 // Try simple YYYY match if session format failed
                 const simpleYearMatch = semester.match(/(\d{4})/);
                 if (simpleYearMatch) {
                     year = simpleYearMatch[1];
                 } else {
                     return `${season} UnknownYear`; // Fallback if no year found
                 }
            }

             return `${season} ${year}`;
        }


        /**
         * Generates a sort key for semesters (YYYY-S). Handles short years.
         */
        function getSemesterOrderKey(semesterName) {
            if (!semesterName || typeof semesterName !== 'string') return '9999-9';
            semesterName = semesterName.toLowerCase();

            if (semesterName.startsWith('forecast')) {
                const num = parseInt(semesterName.split(' ')[1] || '1');
                return `3000-${num}`;
            }

            let year = '9999';
            let seasonOrder = 9;

            const yearMatch = semesterName.match(/\b(20\d{2}|\d{2})\b/); // Matches 20YY or YY
            if (yearMatch) {
                year = yearMatch[1].length === 2 ? `20${yearMatch[1]}` : yearMatch[1];
            } else {
                 // Fallback: try finding any 4-digit number if the main regex fails
                 const fallbackYearMatch = semesterName.match(/(\d{4})/);
                 if (fallbackYearMatch) {
                     year = fallbackYearMatch[1];
                 }
            }


            if (semesterName.includes('winter')) seasonOrder = 1;
            else if (semesterName.includes('spring')) seasonOrder = 2;
            else if (semesterName.includes('summer')) seasonOrder = 3;
            else if (semesterName.includes('fall')) seasonOrder = 4;

            return `${year}-${seasonOrder}`;
        }


      /**
       * Processes raw scraped data (from LMS) into the structured profile format.
       */
      function processScrapedData(data) {
        if (!data || !data.resultData) return null;

        // Extract student info - prioritize first record but allow override if subsequent records have fuller names
        let studentInfo = {
            name: data.resultData[0]?.StudentName?.trim() || 'N/A',
            registration: data.resultData[0]?.RegistrationNo?.trim() || 'N/A'
        };
        data.resultData.forEach(course => {
            if (course.StudentName && course.StudentName.trim() && course.StudentName.trim() !== 'N/A' && studentInfo.name === 'N/A') {
                studentInfo.name = course.StudentName.trim();
            }
             if (course.RegistrationNo && course.RegistrationNo.trim() && course.RegistrationNo.trim() !== 'N/A' && studentInfo.registration === 'N/A') {
                studentInfo.registration = course.RegistrationNo.trim();
            }
        });


        const semesters = {};
        const courseHistory = {}; // Used temporarily for processing repeats

        data.resultData.forEach(course => {
          const originalSemester = course.Semester || 'Unknown Semester'; // Keep the raw name
          const semesterName = processSemesterName(originalSemester); // Use the processed name for grouping
          const courseCode = (course.CourseCode || '').trim().toUpperCase(); // Normalize code
          const historyKey = courseCode;

          if (!semesters[semesterName]) {
            semesters[semesterName] = {
                originalName: originalSemester, // Store the raw name
                sortKey: getSemesterOrderKey(semesterName),
                courses: []
            };
          }

          const creditHoursStr = course.CreditHours || '0';
          const creditHoursMatch = creditHoursStr.match(/(\d+)\s*\(/); // Extract CH before parenthesis "3(3-0)" -> 3
          const creditHours = creditHoursMatch ? parseInt(creditHoursMatch[1]) : parseInt(creditHoursStr.match(/\d+/)?.[0] || '0');

          const marks = parseFloat(course.Total || '0');
          let grade = (course.Grade || '').trim().toUpperCase();
          if (!grade) { // If grade is missing, calculate it
              grade = calculateCustomGrade(marks, creditHours);
          }
          let qualityPoints = calculateQualityPoints(marks, creditHours);
          if (grade === 'F') { qualityPoints = 0; } // Ensure F grade gives 0 QP

          const courseData = {
            code: courseCode,
            title: (course.CourseTitle || '').trim(),
            creditHours: creditHours,
            creditHoursDisplay: creditHoursStr, // Store original CH string
            marks: marks,
            qualityPoints: qualityPoints,
            grade: grade,
            teacher: (course.TeacherName || '').trim(),
            mid: course.Mid || '0',
            assignment: course.Assignment || '0',
            final: course.Final || '0',
            practical: course.Practical || '0',
            total: course.Total || '0',
            isExtraEnrolled: false,
            isRepeated: false,
            isDeleted: false,
            isCustom: false,
            source: 'lms', // Mark source
            originalSemester: originalSemester // Store original semester name for details modal
          };

           // Add to temporary history for repeat processing
          if (historyKey) { // Only process if course code exists
             if (!courseHistory[historyKey]) { courseHistory[historyKey] = []; }
             courseHistory[historyKey].push({
                 semesterSortKey: getSemesterOrderKey(semesterName),
                 marks: marks,
                 grade: grade, // Include grade for comparison
                 data: courseData // Reference to the object in semesters
             });
          }

          semesters[semesterName].courses.push(courseData);
        });

        // Process repeats using the temporary history
        Object.values(courseHistory).forEach(history => {
          if (history.length > 1) {
            history.sort((a, b) => a.semesterSortKey.localeCompare(b.semesterSortKey)); // Sort by semester order

             // Find the best attempt (highest marks, ignore 'F' grades unless all are 'F')
             const passedAttempts = history.filter(item => item.grade !== 'F');
             let bestAttempt;
             if (passedAttempts.length > 0) {
                 bestAttempt = passedAttempts.reduce((prev, current) => (prev.marks >= current.marks) ? prev : current);
             } else { // All attempts resulted in 'F'
                 bestAttempt = history.reduce((prev, current) => (prev.marks >= current.marks) ? prev : current); // Still pick highest marks among F's
             }


            history.forEach(item => {
              item.data.isRepeated = true; // Mark all as repeated if > 1 attempt
              item.data.isExtraEnrolled = (item !== bestAttempt); // Mark non-best attempts
            });
          } else if (history.length === 1) {
              history[0].data.isRepeated = false; // Not repeated if only one instance
          }
        });

        return { studentInfo, semesters }; // Return without courseHistory
      }


      // --- CGPA Calculation Logic ---
       function calculateQualityPoints(marks, creditHours) {
        marks = parseFloat(marks);
        creditHours = parseInt(creditHours);
        let qualityPoints = 0;
        // Ensure inputs are valid numbers
        if (isNaN(marks) || isNaN(creditHours) || creditHours <= 0) {
            return 0;
        }

        // Apply UAF's specific formula based on credit hours
        if (creditHours === 10) {
            if (marks >= 160) qualityPoints = 40;
            else if (marks >= 100) qualityPoints = 40 - ((160 - marks) * 0.3333333); // More precision
            else if (marks >= 80) qualityPoints = 20 - ((100 - marks) * 0.5); // Range corrected
            else qualityPoints = 0; // Below 80 is F
        } else if (creditHours === 9) {
            if (marks >= 144) qualityPoints = 36;
            else if (marks >= 90) qualityPoints = 36 - ((144 - marks) * 0.3333333);
            else if (marks >= 72) qualityPoints = 18 - ((90 - marks) * 0.5);
            else qualityPoints = 0;
        } else if (creditHours === 8) {
            if (marks >= 128) qualityPoints = 32;
            else if (marks >= 80) qualityPoints = 32 - ((128 - marks) * 0.3333333);
            else if (marks >= 64) qualityPoints = 16 - ((80 - marks) * 0.5);
            else qualityPoints = 0;
        } else if (creditHours === 7) {
            if (marks >= 112) qualityPoints = 28;
            else if (marks >= 70) qualityPoints = 28 - ((112 - marks) * 0.3333333);
            else if (marks >= 56) qualityPoints = 14 - ((70 - marks) * 0.5);
            else qualityPoints = 0;
        } else if (creditHours === 6) {
            if (marks >= 96) qualityPoints = 24;
            else if (marks >= 60) qualityPoints = 24 - ((96 - marks) * 0.3333333);
            else if (marks >= 48) qualityPoints = 12 - ((60 - marks) * 0.5);
            else qualityPoints = 0;
        } else if (creditHours === 5) {
            if (marks >= 80) qualityPoints = 20;
            else if (marks >= 50) qualityPoints = 20 - ((80 - marks) * 0.3333333);
            else if (marks >= 40) qualityPoints = 10 - ((50 - marks) * 0.5);
            else qualityPoints = 0;
        } else if (creditHours === 4) {
            if (marks >= 64) qualityPoints = 16; // A Grade 4.0 * 4CH
            else if (marks >= 52) qualityPoints = 16 - ((64 - marks) * 0.3333333); // B Grade range (3.0-3.99) * 4CH
            else if (marks >= 40) qualityPoints = 8 + ((marks - 40) * ( (3.0*4 - 2.0*4) / (52-40) ) ); // C Grade range (2.0-2.99) * 4CH - Linear interpolation
            else if (marks >= 32) qualityPoints = 4 + ((marks - 32) * ( (2.0*4 - 1.0*4) / (40-32) ) ); // D Grade range (1.0-1.99) * 4CH - Linear interpolation
            else qualityPoints = 0; // F Grade
        } else if (creditHours === 3) {
            if (marks >= 48) qualityPoints = 12; // A Grade 4.0 * 3CH
            else if (marks >= 39) qualityPoints = 12 - ((48 - marks) * 0.3333333); // B Grade range (3.0-3.99) * 3CH
            else if (marks >= 30) qualityPoints = 6 + ((marks-30) * ( (3.0*3 - 2.0*3) / (39-30) ) ); // C Grade range (2.0-2.99) * 3CH - Linear interpolation
            else if (marks >= 24) qualityPoints = 3 + ((marks - 24) * ( (2.0*3 - 1.0*3) / (30-24) ) ); // D Grade range (1.0-1.99) * 3CH - Linear interpolation
            else qualityPoints = 0; // F Grade
        } else if (creditHours === 2) {
            if (marks >= 32) qualityPoints = 8; // A Grade 4.0 * 2CH
            else if (marks >= 26) qualityPoints = 8 - ((32 - marks) * 0.3333333); // B Grade range (3.0-3.99) * 2CH
            else if (marks >= 20) qualityPoints = 4 + ((marks-20) * ( (3.0*2 - 2.0*2) / (26-20) ) ); // C Grade range (2.0-2.99) * 2CH - Linear interpolation
            else if (marks >= 16) qualityPoints = 2 + ((marks - 16) * ( (2.0*2 - 1.0*2) / (20-16) ) ); // D Grade range (1.0-1.99) * 2CH - Linear interpolation
            else qualityPoints = 0; // F Grade
        } else if (creditHours === 1) {
            if (marks >= 16) qualityPoints = 4; // A Grade 4.0 * 1CH
            else if (marks >= 13) qualityPoints = 4 - ((16 - marks) * 0.3333333); // B Grade range (3.0-3.99) * 1CH
            else if (marks >= 10) qualityPoints = 2 + ((marks-10) * ( (3.0*1 - 2.0*1) / (13-10) ) ); // C Grade range (2.0-2.99) * 1CH - Linear interpolation
            else if (marks >= 8) qualityPoints = 1 + ((marks - 8) * ( (2.0*1 - 1.0*1) / (10-8) ) ); // D Grade range (1.0-1.99) * 1CH - Linear interpolation
            else qualityPoints = 0; // F Grade
        } else {
             // Fallback for CH > 10 or CH=0? Default to simple percentage-based or zero.
             // Let's assume a simple linear scale for CH > 10 for now, though unlikely.
             if (marks >= 0.8 * (creditHours * 20)) qualityPoints = 4.0 * creditHours;
             else if (marks >= 0.65 * (creditHours * 20)) qualityPoints = 3.0 * creditHours;
             else if (marks >= 0.50 * (creditHours * 20)) qualityPoints = 2.0 * creditHours;
             else if (marks >= 0.40 * (creditHours * 20)) qualityPoints = 1.0 * creditHours;
             else qualityPoints = 0;
        }

        // Ensure QP is not negative and round appropriately
        return parseFloat(Math.max(0, qualityPoints).toFixed(4)); // Increased precision for QP
      }

       function calculateCustomGrade(marks, creditHours) {
            // Updated grading scale based on UAF common practices for CH 1-4
            if (isNaN(marks) || isNaN(creditHours) || creditHours <= 0) return 'F';
             marks = parseFloat(marks);
             creditHours = parseInt(creditHours);

             // Define thresholds based on percentage of max marks (Max Marks = CH * 20)
             const maxMarks = creditHours * 20;
             if (maxMarks <= 0) return 'F'; // Avoid division by zero

             const percentage = (marks / maxMarks) * 100;

             if (percentage >= 80) return 'A'; // 80% and above
             if (percentage >= 65) return 'B'; // 65% to 79.99%
             if (percentage >= 50) return 'C'; // 50% to 64.99%
             if (percentage >= 40) return 'D'; // 40% to 49.99%
             return 'F'; // Below 40%
        }


       function calculateCGPA(data) {
        if (!data || !data.semesters) return null;
        let totalQualityPoints = 0, totalCreditHours = 0, totalMarksObtained = 0, totalMaxMarks = 0;

        // --- Start: Recalculate isExtraEnrolled before summing totals ---
        const courseHistoryRecalc = {};
        Object.values(data.semesters).forEach(semester => {
             semester.courses.forEach(course => {
                if (course.isDeleted) return; // Skip deleted
                const historyKey = course.code.toUpperCase().trim();
                 if (!historyKey) return; // Skip if no code
                if (!courseHistoryRecalc[historyKey]) { courseHistoryRecalc[historyKey] = []; }
                courseHistoryRecalc[historyKey].push({
                    semesterSortKey: semester.sortKey,
                    marks: course.marks,
                    grade: course.grade,
                    data: course // Reference
                });
            });
        });

         // Reset flags first
         Object.values(courseHistoryRecalc).flat().forEach(item => {
             item.data.isExtraEnrolled = false;
             item.data.isRepeated = false;
         });


        Object.values(courseHistoryRecalc).forEach(history => {
            if (history.length > 1) {
                history.sort((a, b) => a.semesterSortKey.localeCompare(b.semesterSortKey));
                 const passedAttempts = history.filter(item => item.grade !== 'F');
                 let bestAttempt;
                 if (passedAttempts.length > 0) {
                    bestAttempt = passedAttempts.reduce((prev, current) => (prev.marks >= current.marks) ? prev : current);
                 } else {
                    bestAttempt = history.reduce((prev, current) => (prev.marks >= current.marks) ? prev : current);
                 }

                history.forEach(item => {
                    item.data.isRepeated = true;
                    item.data.isExtraEnrolled = (item !== bestAttempt);
                });
            } else if (history.length === 1) {
                history[0].data.isRepeated = false; // Only one attempt
            }
        });
        // --- End: Recalculate isExtraEnrolled ---


        // --- Calculate Totals and Semester GPAs ---
        Object.values(data.semesters).forEach(semester => {
            semester.totalQualityPoints = 0;
            semester.totalCreditHours = 0;
            semester.totalMarksObtained = 0;
            semester.totalMaxMarks = 0;
            semester.courses.forEach(course => {
                if (!course.isExtraEnrolled && !course.isDeleted) {
                    // Recalculate QP and Grade just in case CH was changed (e.g., during import)
                    course.grade = calculateCustomGrade(course.marks, course.creditHours);
                    course.qualityPoints = calculateQualityPoints(course.marks, course.creditHours);
                     if (course.grade === 'F') course.qualityPoints = 0; // Double check F grade QP


                    semester.totalQualityPoints += course.qualityPoints;
                    semester.totalCreditHours += course.creditHours;
                    semester.totalMarksObtained += course.marks;

                    // Max marks calculation - Standard UAF: Max Marks = CH * 20
                    let maxMarksForCourse = course.creditHours * 20;
                    semester.totalMaxMarks += maxMarksForCourse;

                    // Add to overall totals
                    totalQualityPoints += course.qualityPoints;
                    totalCreditHours += course.creditHours;
                    totalMarksObtained += course.marks;
                    totalMaxMarks += maxMarksForCourse;
                }
            });
            semester.gpa = semester.totalCreditHours > 0 ? (semester.totalQualityPoints / semester.totalCreditHours) : 0;
            semester.percentage = semester.totalMaxMarks > 0 ? (semester.totalMarksObtained / semester.totalMaxMarks * 100) : 0;
        });

        const cgpa = totalCreditHours > 0 ? (totalQualityPoints / totalCreditHours) : 0;
        const percentage = totalMaxMarks > 0 ? (totalMarksObtained / totalMaxMarks * 100) : 0;

        return { cgpa, percentage, totalQualityPoints, totalCreditHours, totalMarksObtained, totalMaxMarks };
      }
      // --- End CGPA Calculation ---


      // --- UI Rendering ---
      function displayCGPAResults(data, cgpaData) {
        processedData = data; // Update global state
        resultContainer.style.display = 'block';
         fetchAttendanceBtn.disabled = false; // Enable attendance btn

        // Update header and overall stats
        studentName.innerHTML = `<i class="fa-solid fa-user-graduate me-2"></i>${data.studentInfo.name || 'N/A'}`;
        studentReg.textContent = data.studentInfo.registration || 'N/A';
        totalCgpa.textContent = formatNumber(cgpaData.cgpa, 4).toFixed(4);
        totalPercentage.textContent = `${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`;
        totalMarksObtained.textContent = formatNumber(cgpaData.totalMarksObtained, 0).toFixed(0);
        totalMaxMarks.textContent = `/ ${formatNumber(cgpaData.totalMaxMarks, 0).toFixed(0)}`;

        // Update progress circle
        const cgpaCircle = document.getElementById('cgpaCircle');
        if (cgpaCircle) {
            const cgpa = parseFloat(totalCgpa.textContent);
            const percentageValue = Math.max(0, Math.min(100, (cgpa / 4.0) * 100)); // Clamp between 0 and 100
            // Defer animation slightly for effect
            setTimeout(() => { cgpaCircle.style.strokeDasharray = `${percentageValue}, 100`; }, 100);
        }

        // Render semester cards
        semesterResults.innerHTML = ''; // Clear previous results
        Object.keys(data.semesters)
            .sort((a, b) => data.semesters[a].sortKey.localeCompare(data.semesters[b].sortKey))
            .forEach(semesterName => {
                const semester = data.semesters[semesterName];
                const semesterCard = document.createElement('div');
                const animationClass = isInitialLoad ? 'fade-in-on-scroll' : 'is-visible';
                semesterCard.className = `semester-card ${animationClass}`;
                semesterCard.dataset.semester = semesterName;

                semesterCard.innerHTML = `
                    <i class="fa-solid fa-trash delete-semester" title="Delete this semester" data-semester="${semesterName}"></i>
                    <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0"><i class="fa-solid fa-book-open me-2" style="color: var(--brand);"></i>${semesterName}</h5>
                    <div class="text-end" style="margin-right: 40px;">
                        <p class="mb-0 text-body-secondary small">GPA:</p>
                        <p class="mb-0 h4 fw-bold" style="color: var(--brand);">${formatNumber(semester.gpa, 4).toFixed(4)}</p>
                        <p class="mb-0 text-body-secondary small">${formatNumber(semester.percentage, 2).toFixed(2)}%</p>
                    </div>
                    </div>
                    <button class="custom-course-btn" data-semester="${semesterName}"><i class="fa-solid fa-plus"></i> Custom Course</button>
                    <div class="table-responsive">
                    <table class="course-table">
                        <thead><tr><th>Course</th><th>Hrs</th><th>Marks</th><th>Grade</th><th>Action</th></tr></thead>
                        <tbody>${semester.courses.map((course, index) => {
                            const courseIdentifier = `${semesterName}-${course.code}-${course.total}-${index}`; // Unique ID for drag/drop
                            const courseTitle = course.title || (course.source === 'attendance' ? 'Imported Course' : 'N/A');
                            let badges = '';
                            if(course.isRepeated && course.isExtraEnrolled) badges += '<sup class="extra-enrolled">Rep.</sup>';
                            if(course.source === 'attendance') badges += '<sup class="attendance-import-badge">Atnd</sup>';
                            else if (course.isCustom) badges += '<sup class="custom-badge">Custom</sup>';

                            return `
                            <tr data-course-identifier="${courseIdentifier}" draggable="true" class="${course.isExtraEnrolled ? 'table-warning' : ''} ${course.isDeleted ? 'table-danger text-decoration-line-through' : ''} ${course.source === 'attendance' ? 'table-info' : ''}">
                                <td>
                                <div class="course-code-container">
                                    <span class="fw-medium course-code clickable-info" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}'>
                                    ${course.code}
                                    <i class="fa-solid fa-info-circle ms-1 clickable-info small" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' title="${courseTitle}"></i>
                                    </span>
                                    ${badges}
                                </div>
                                </td>
                                <td>${course.creditHoursDisplay || course.creditHours}</td><td>${formatNumber(course.marks, 0)}</td>
                                <td><span class="grade-badge grade-${course.grade}">${course.grade}</span></td>
                                <td class="course-actions">${course.isDeleted ? `<i class="fa-solid fa-rotate-left restore-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Restore"></i>` : `<i class="fa-solid fa-trash delete-course" data-course='${JSON.stringify(course).replace(/'/g, "&#39;")}' data-semester="${semesterName}" title="Delete"></i>`}</td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                    </div>`;
                semesterResults.appendChild(semesterCard);
            });

        isInitialLoad = false; // Mark initial load as complete
        attachResultEventListeners(); // Re-attach listeners for new elements
        renderGpaChart(); // Update chart
      }

      function renderGpaChart() { /* ... no changes ... */ }
      // --- End UI Rendering ---


      // --- Event Handlers & Actions ---
      function attachResultEventListeners() {
        // Use event delegation on semesterResults container for dynamically added elements
        semesterResults.addEventListener('click', function(e) {
            const target = e.target;
            const courseDataStr = target.closest('[data-course]')?.dataset.course;
            const semesterName = target.closest('[data-semester]')?.dataset.semester;

             if (target.classList.contains('clickable-info') && courseDataStr) {
                 try {
                     showCourseDetails(JSON.parse(courseDataStr.replace(/&#39;/g, "'")));
                 } catch (err) { console.error("Error parsing course data for details:", err); }
             }
             else if (target.classList.contains('delete-semester') && semesterName) {
                 deleteSemester(e, semesterName);
             }
             else if (target.classList.contains('custom-course-btn') && semesterName) {
                 openAddCourseModal(semesterName);
             }
             else if (target.classList.contains('delete-course') && courseDataStr && semesterName) {
                  try {
                     modifyCourseState(e, JSON.parse(courseDataStr.replace(/&#39;/g, "'")), semesterName, true);
                  } catch (err) { console.error("Error parsing course data for delete:", err); }
             }
             else if (target.classList.contains('restore-course') && courseDataStr && semesterName) {
                 try {
                    modifyCourseState(e, JSON.parse(courseDataStr.replace(/&#39;/g, "'")), semesterName, false);
                 } catch (err) { console.error("Error parsing course data for restore:", err); }
             }
        });

        // Add listeners for scroll animations (only needed once, but safe to re-run)
        document.querySelectorAll('.semester-card.fade-in-on-scroll:not(.is-visible)').forEach(el => {
            const observer = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting) {
                    entries[0].target.classList.add('is-visible');
                    observer.unobserve(entries[0].target);
                }
            }, { threshold: 0.1 });
            observer.observe(el);
        });

        // Initialize drag and drop if on desktop
        if (window.innerWidth >= 992) {
          initDragAndDrop();
        }
      }

       function showCourseDetails(course) {
        document.getElementById('courseDetailsModalTitle').textContent = `${course.code} - ${course.title || 'N/A'}`;
        // Use originalSemester for display
        const displaySemester = course.originalSemester || 'N/A';
        document.getElementById('courseDetailsModalBody').innerHTML = `
          <div class="row">
            <div class="col-md-6">
                <p><strong>Semester:</strong> ${displaySemester}</p>
                <p><strong>Teacher:</strong> ${course.teacher || 'N/A'}</p>
                <p><strong>Credit Hours:</strong> ${course.creditHoursDisplay || course.creditHours}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Mid Term:</strong> ${course.mid || 'N/A'}</p>
                <p><strong>Assignment:</strong> ${course.assignment || 'N/A'}</p>
                <p><strong>Final Term:</strong> ${course.final || 'N/A'}</p>
                ${course.practical && course.practical !== '0' ? `<p><strong>Practical:</strong> ${course.practical}</p>` : ''}
            </div>
          </div>
          <div class="alert alert-info mt-3">
              <p class="mb-1"><strong>Total Marks:</strong> ${course.total || course.marks || 'N/A'}</p>
              <p class="mb-1"><strong>Grade:</strong> <span class="grade-badge grade-${course.grade}">${course.grade || 'N/A'}</span></p>
              <p class="mb-0"><strong>Quality Points:</strong> ${formatNumber(course.qualityPoints, 4).toFixed(4)}</p>
          </div>
          ${course.isExtraEnrolled ? `<div class="alert alert-warning mb-0"><i class="fa-solid fa-exclamation-triangle me-2"></i>This repeated course's marks don't count towards CGPA in this attempt.</div>` : ''}
          ${course.source === 'attendance' ? `<div class="alert alert-secondary mb-0"><i class="fa-solid fa-clipboard-user me-2"></i>Imported from Attendance System.</div>` : ''}
          ${course.isCustom && course.source !== 'attendance' ? `<div class="alert alert-secondary mb-0"><i class="fa-solid fa-plus-circle me-2"></i>Manually added custom course.</div>` : ''}`;
        courseDetailsModal.show();
      }

      function openAddCourseModal(semesterName) { /* ... no changes ... */ }
      function addCustomCourse() { /* ... Small changes made above to add originalSemester and check duplicates ... */ }
      function deleteSemester(event, semesterName) { /* ... no changes ... */ }
      function showUndoNotification(message, undoCallback) { /* ... no changes ... */ }
      function undoDeleteSemester(semesterName) { /* ... no changes ... */ }
      function modifyCourseState(event, course, semesterName, isDeleted) { /* ... Minor robustness change made above ... */ }
      function recalculateAndDisplay() { /* ... no changes ... */ }
      function addForecastSemester() { /* ... no changes ... */ }
      function copyDetailsToClipboard() { /* ... no changes ... */ }
      function generatePDF() { /* ... Minor update above to mark custom courses ... */ }
      function initDragAndDrop() { /* ... no changes ... */ }
      // --- End Event Handlers & Actions ---


      // --- Attendance System Logic ---
       async function fetchAttendanceData() {
        if (!processedData || !processedData.studentInfo || !processedData.studentInfo.registration) {
            showToast('Please fetch or load a profile first.', 'warning');
            return;
        }
        const regNum = processedData.studentInfo.registration;

        addStatusMessage(`Fetching results from Attendance System for: ${regNum}`, 'info');
        showLoadingStage('fetching');
        fetchAttendanceBtn.disabled = true;
        fetchAttendanceBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Fetching...';
        allAttendanceCourses = []; // Clear previous results

        try {
            const response = await fetch(`${ATTENDANCE_API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
            const data = await response.json();

            if (!response.ok) { // Check HTTP status first
                 throw new Error(data.message || `Attendance server responded with status ${response.status}`);
            }
             if (!data.success) { // Then check success flag from backend logic
                 throw new Error(data.message || "Failed to fetch attendance data.");
             }


            addStatusMessage(`Successfully fetched ${data.resultData?.length || 0} records from Attendance System`, 'success');
            showLoadingStage('processing');

            allAttendanceCourses = data.resultData || []; // Store all results
            showAllAttendance = false; // Reset view state
            toggleShowAllAttendanceBtn.textContent = 'Show All Courses'; // Reset button text

            renderAttendanceImportModal(); // Render initially with only missing
            attendanceImportModal.show();

        } catch (error) {
            console.error("Attendance Fetch Error:", error);
             let userMessage = error.message || 'Could not retrieve Attendance System results. Please try again.';
             addStatusMessage(`Error fetching from Attendance System: ${userMessage}`, 'error');
            showToast(userMessage, 'error');
        } finally {
            showLoadingStage(null);
            fetchAttendanceBtn.disabled = false;
            fetchAttendanceBtn.innerHTML = '<i class="fa-solid fa-clipboard-user me-2"></i>Attendance System';
        }
      }

        /**
        * Renders the content of the Attendance Import modal based on the showAllAttendance flag.
        */
        function renderAttendanceImportModal() {
            attendanceCourseListEl.innerHTML = ''; // Clear previous list

            if (!processedData) {
                attendanceCourseListEl.innerHTML = '<p class="text-center text-danger p-3">Error: No active profile data loaded.</p>';
                importAttendanceCoursesBtn.disabled = true;
                return;
            }
             if (allAttendanceCourses.length === 0) {
                 attendanceCourseListEl.innerHTML = '<p class="text-center text-muted p-3">No courses found in the Attendance System for this registration number.</p>';
                 importAttendanceCoursesBtn.disabled = true;
                 return;
             }


            // Create a lookup for existing LMS courses: key = "CODE_SEMESTER", value = course object
            const lmsCourseLookup = new Map();
            Object.entries(processedData.semesters).forEach(([semName, semester]) => {
                // Use the *processed* semester name for the lookup key
                 const processedLmsSemName = processSemesterName(semester.originalName || semName);
                 semester.courses.forEach(course => {
                    if (!course.isDeleted) {
                        const key = `${course.code.toUpperCase().trim()}_${processedLmsSemName}`;
                        lmsCourseLookup.set(key, course);
                    }
                });
            });

            let missingCoursesFound = false;
            let itemsRendered = 0;

            allAttendanceCourses.forEach((attCourse, index) => {
                const courseCode = (attCourse.CourseCode || '').toUpperCase().trim();
                // Use the *original* semester name from attendance for processing
                 const processedAttSemName = processSemesterName(attCourse.Semester);
                 const uniqueKey = `${courseCode}_${processedAttSemName}`;

                const existingLmsCourse = lmsCourseLookup.get(uniqueKey);
                let isAlreadyPresent = false;
                 // Check if it exists AND marks/grade match (handle potential float inaccuracies)
                 if (existingLmsCourse) {
                     const marksMatch = Math.abs(parseFloat(existingLmsCourse.marks) - parseFloat(attCourse.Total || '0')) < 0.01;
                     const gradeMatch = existingLmsCourse.grade.toUpperCase() === (attCourse.Grade || '').toUpperCase();
                     isAlreadyPresent = marksMatch && gradeMatch;
                 }


                 // Determine if this item should be shown based on the toggle
                 const shouldShow = showAllAttendance || !isAlreadyPresent;

                if (shouldShow) {
                    itemsRendered++;
                    const courseId = `att-course-${index}`;
                    const selectId = `att-ch-${index}`;
                    const item = document.createElement('div');
                    item.className = `attendance-course-item ${isAlreadyPresent ? 'already-exists' : ''}`;

                     // Clean up display text
                     let displayTitle = attCourse.CourseName === 'N/A' ? '' : attCourse.CourseName;
                     let displayTeacher = attCourse.TeacherName === 'N/A' ? '' : `Teacher: ${attCourse.TeacherName}`;
                     let detailsText = `Marks: ${attCourse.Total || 'N/A'}, Grade: ${attCourse.Grade || 'N/A'}`;
                     if (displayTeacher) detailsText += `, ${displayTeacher}`;


                    item.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${index}" id="${courseId}" ${!isAlreadyPresent ? 'checked' : ''} ${isAlreadyPresent && !showAllAttendance ? 'disabled' : ''}>
                            <label class="form-check-label" for="${courseId}">
                                <strong>${courseCode}</strong> (${processedAttSemName})
                                ${displayTitle ? `<span class="d-block text-muted small">${displayTitle}</span>` : ''}
                                <small class="d-block text-muted">${detailsText}</small>
                                ${isAlreadyPresent ? '<span class="already-exists-label">(Already in Profile)</span>' : ''}
                            </label>
                        </div>
                        <div class="import-ch-select">
                            <label for="${selectId}" class="form-label mb-0 small">CH:</label>
                            <select class="form-select form-select-sm" id="${selectId}">
                                ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(ch => `<option value="${ch}" ${ch === 3 ? 'selected' : ''}>${ch}</option>`).join('')}
                            </select>
                        </div>
                    `;
                    // Store course data directly on the checkbox element
                    item.querySelector(`#${courseId}`).dataset.courseData = JSON.stringify(attCourse);
                    attendanceCourseListEl.appendChild(item);

                     if (!isAlreadyPresent) {
                         missingCoursesFound = true;
                     }
                }
            });

             // Update description based on what's shown
             const descriptionEl = document.getElementById('attendanceModalDescription');
             if (showAllAttendance) {
                 descriptionEl.textContent = 'Showing all courses found in Attendance System. Select courses to import/override and set credit hours. Greyed items likely match existing profile data.';
             } else {
                  descriptionEl.textContent = 'Showing courses found in Attendance System potentially missing from your profile. Select courses to import and set credit hours.';
             }


            if (itemsRendered === 0 && !showAllAttendance) {
                 attendanceCourseListEl.innerHTML = '<p class="text-center text-muted p-3">No missing courses found compared to your current profile.</p>';
                 importAttendanceCoursesBtn.disabled = true;
             } else {
                 importAttendanceCoursesBtn.disabled = false;
             }

        }

        /**
         * Toggles the view in the Attendance Import modal between missing and all courses.
         */
        function toggleAttendanceView() {
            showAllAttendance = !showAllAttendance;
            if (showAllAttendance) {
                toggleShowAllAttendanceBtn.innerHTML = '<i class="fa-solid fa-eye-slash me-1"></i> Show Only Missing';
            } else {
                toggleShowAllAttendanceBtn.innerHTML = '<i class="fa-solid fa-eye me-1"></i> Show All Courses';
            }
            renderAttendanceImportModal(); // Re-render the list
        }


      /**
       * Imports selected courses from the Attendance modal into the main profile data.
       */
      function importSelectedAttendanceCourses() {
        const selectedCheckboxes = document.querySelectorAll('#attendanceCourseList .form-check-input:checked');
        let importedCount = 0;
        let errors = 0;

        if (!processedData) {
            showToast('Cannot import: No active profile loaded.', 'error');
            return;
        }


        selectedCheckboxes.forEach(checkbox => {
            try {
                const courseDataRaw = JSON.parse(checkbox.dataset.courseData);
                const index = checkbox.value;
                const creditHoursSelect = document.getElementById(`att-ch-${index}`);
                const creditHours = parseInt(creditHoursSelect.value);

                if (!isNaN(creditHours) && creditHours > 0 && creditHours <= 10) {
                    const originalAttSemester = courseDataRaw.Semester; // Use original attendance semester string
                    const semesterName = processSemesterName(originalAttSemester); // Processed name for grouping
                    const courseCode = (courseDataRaw.CourseCode || '').toUpperCase().trim();
                    const marks = parseFloat(courseDataRaw.Total || '0');

                    // Ensure semester exists in processedData
                    if (!processedData.semesters[semesterName]) {
                        processedData.semesters[semesterName] = {
                            originalName: originalAttSemester, // Store original name
                            sortKey: getSemesterOrderKey(semesterName),
                            courses: []
                        };
                         addStatusMessage(`Created new semester entry: ${semesterName} during import`, 'info');
                    }

                    // Create the new course object
                    const newCourse = {
                        code: courseCode,
                        title: courseDataRaw.CourseName === 'N/A' ? 'Imported from Attendance' : courseDataRaw.CourseName,
                        creditHours: creditHours,
                        creditHoursDisplay: `${creditHours}(${creditHours}-0)`, // Default format
                        marks: marks,
                        qualityPoints: calculateQualityPoints(marks, creditHours),
                        grade: calculateCustomGrade(marks, creditHours),
                        teacher: courseDataRaw.TeacherName === 'N/A' ? 'Attendance System' : courseDataRaw.TeacherName,
                        mid: courseDataRaw.Mid || 'N/A',
                        assignment: courseDataRaw.Assignment || 'N/A', // Use correct key
                        final: courseDataRaw.Final || 'N/A',
                        practical: courseDataRaw.Practical || 'N/A',
                        total: marks,
                        isExtraEnrolled: false, // Will be recalculated by calculateCGPA
                        isRepeated: false,      // Will be recalculated
                        isDeleted: false,
                        isCustom: true,         // Treat as custom for editing purposes
                        source: 'attendance',   // Mark source
                        originalSemester: originalAttSemester // Store original name from attendance
                    };

                    // Check if *exactly* this course (code and semester) already exists and is NOT deleted
                    const semester = processedData.semesters[semesterName];
                    const existingIndex = semester.courses.findIndex(c =>
                        !c.isDeleted && c.code.toUpperCase() === newCourse.code
                    );

                    if (existingIndex === -1) {
                         // Add new course if no non-deleted version exists
                         semester.courses.push(newCourse);
                         importedCount++;
                         addStatusMessage(`Imported course ${newCourse.code} for ${semesterName}.`, 'info');
                    } else {
                         // Course with this code already exists in this semester. Replace it.
                         semester.courses[existingIndex] = newCourse; // Overwrite
                         importedCount++; // Count it as imported/updated
                         addStatusMessage(`Updated existing course ${newCourse.code} for ${semesterName} with Attendance data.`, 'info');
                    }


                } else {
                    errors++;
                    showToast(`Invalid Credit Hours (${creditHoursSelect.value}) selected for ${courseDataRaw.CourseCode}`, 'warning');
                }
            } catch (err) {
                 errors++;
                 console.error("Error processing course for import:", err, checkbox.dataset.courseData);
                 showToast(`Error importing a course. Check console log.`, 'error');
            }
        });

        if (importedCount > 0) {
            recalculateAndDisplay(); // This now correctly handles repeats and recalculates everything
            showToast(`${importedCount} course(s) imported/updated successfully!`, 'success');
        } else if (errors === 0) {
            showToast('No new courses were selected for import.', 'info');
        } else {
             showToast(`Import finished with ${errors} error(s). ${importedCount} courses processed.`, 'warning');
        }


        attendanceImportModal.hide();
    }
      // --- End Attendance System Logic ---


      // --- Main Fetch Function ---
      async function fetchResult() {
        const regNum = registrationNumber.value.trim();
        if (!regNum) { showToast('Please enter a registration number', 'error'); return; }

        resultContainer.style.display = 'none';
        fetchAttendanceBtn.disabled = true; // Disable attendance btn during fetch
        showLoadingStage('connecting');
        addStatusMessage(`Fetching LMS result for: ${regNum}`, 'info');
        semesterResults.innerHTML = '';
        gpaChartContainer.style.display = 'none';
        processedData = null; // Clear previous data on new fetch

        try {
          const response = await fetch(`${API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
          showLoadingStage('fetching');
          const data = await response.json();

          if (!response.ok) { // Check HTTP status
            throw new Error(data.message || `LMS Server responded with status ${response.status}`);
          }
           if (!data.success) { // Check backend success flag
                throw new Error(data.message || "Failed to fetch LMS data.");
           }


          showLoadingStage('processing');

          if (data.resultData && data.resultData.length > 0) {
            addStatusMessage('LMS Result fetched successfully', 'success');
            isInitialLoad = true; // For animations
            const processed = processScrapedData(data); // Process LMS data
            const cgpaData = calculateCGPA(processed); // Initial calculation

            // Profile saving logic
            const profiles = getProfiles();
            const studentInfo = processed.studentInfo;
            let baseName = `${studentInfo.name || 'Profile'} (${studentInfo.registration || 'N/A'})`;
            let finalName = baseName;
            let copyNum = 1;
            const allDisplayNames = Object.values(profiles).map(p => p.displayName);
            while(allDisplayNames.includes(finalName)) { finalName = `${baseName} - Copy ${copyNum++}`; }

            processed.displayName = finalName;
            processed.createdAt = new Date().toISOString();
            processed.lastModified = new Date().toISOString();
            const newProfileId = `profile_${Date.now()}_${Math.random().toString(16).slice(2)}`; // More unique ID
            profiles[newProfileId] = processed; // Add the fully processed data
            saveProfiles(profiles);
            setActiveProfileId(newProfileId);

            showLoadingStage('complete');
            setTimeout(() => {
              displayCGPAResults(processed, cgpaData); // Display the results
              showLoadingStage(null);
              showToast('New profile created successfully!', 'success');
              updateProfileSwitcher(profiles, newProfileId); // Update dropdown
            }, 1000);

          } else {
             // Backend reported success:true but resultData is empty or null
             throw new Error("No result records found in LMS for this registration number.");
          }
        } catch (error) {
            console.error("LMS Fetch Error:", error);
            let userMessage = error.message || 'Could not retrieve LMS results. Please try again.';
            addStatusMessage(`Error fetching from LMS: ${userMessage}`, 'error');
            showToast(userMessage, 'error');
            showLoadingStage(null);
            fetchAttendanceBtn.disabled = true; // Keep disabled on error
        }
      }
      // --- End Main Fetch Function ---


      // --- Final Event Listeners Setup ---
      resultForm.addEventListener('submit', (e) => { e.preventDefault(); fetchResult(); });
      downloadLogBtn.addEventListener('click', downloadLog);
      clearLogBtn.addEventListener('click', clearLog);
      downloadPdfBtn.addEventListener('click', generatePDF);
      saveCourseBtn.addEventListener('click', addCustomCourse);
      addForecastSemesterBtn.addEventListener('click', addForecastSemester);
      profileSwitcher.addEventListener('change', switchProfile);
      saveProfileNameBtn.addEventListener('click', renameProfile);
      document.getElementById('confirmationConfirmBtn').addEventListener('click', handleConfirm);
      fetchAttendanceBtn.addEventListener('click', fetchAttendanceData);
      importAttendanceCoursesBtn.addEventListener('click', importSelectedAttendanceCourses);
      toggleShowAllAttendanceBtn.addEventListener('click', toggleAttendanceView); // Listener for the new toggle
      importProfilesBtn.addEventListener('click', importProfiles);
      importProfilesBtnModal.addEventListener('click', importProfiles);
      exportProfilesBtn.addEventListener('click', () => { // Main export button opens manager
         if (Object.keys(getProfiles()).length === 0) { showToast('No profiles available to export.', 'info'); return; }
         renderProfileManager();
         profileManagerModal.show();
         showToast('Select profiles from the manager to export.', 'info');
      });
      exportProfilesBtnModal.addEventListener('click', exportSelectedProfiles); // Modal export button uses selection
      openProfileManagerBtn.addEventListener('click', () => { renderProfileManager(); profileManagerModal.show(); });
      document.getElementById('selectAllProfiles').addEventListener('change', e => {
          const isChecked = e.target.checked;
          document.querySelectorAll('.profile-checkbox').forEach(cb => cb.checked = isChecked);
          document.getElementById('bulkActionsBtn').disabled = !isChecked;
          exportProfilesBtnModal.disabled = !isChecked;
      });
       document.getElementById('profileManagerList').addEventListener('change', e => { // Delegate listener for checkboxes in profile list
            if (e.target.classList.contains('profile-checkbox')) {
                const anyChecked = !!document.querySelector('#profileManagerList .profile-checkbox:checked');
                document.getElementById('bulkActionsBtn').disabled = !anyChecked;
                exportProfilesBtnModal.disabled = !anyChecked;
                // Update "Select All" checkbox state
              const allCheckboxes = document.querySelectorAll('#profileManagerList .profile-checkbox');
              const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
              const selectAllCheckbox = document.getElementById('selectAllProfiles');
              selectAllCheckbox.checked = allChecked;
              selectAllCheckbox.indeterminate = !allChecked && anyChecked;

          }
      });

      document.getElementById('deleteSelectedBtn').addEventListener('click', handleBulkAction);

      // --- Initialize ---
      init();
    });
</script>
</body>
</html>
