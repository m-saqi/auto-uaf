<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>UAF CGPA Calculator | Automatic & Accurate | University of Agriculture Faisalabad</title>
  
  <meta name="description" content="The best UAF CGPA Calculator. Automatically fetches results from the UAF LMS to calculate your exact CGPA and percentage. Fast, accurate, and easy to use for all UAF students." />
  <meta name="keywords" content="uaf cgpa calculator, university of agriculture faisalabad, uaf lms results, uaf gpa calculator, uaf percentage calculator, calculate cgpa uaf" />
  <meta name="author" content="Muhammad Saqlain" />
  
  <link rel="canonical" href="https://uafcgpacalculator.vercel.app" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="og:title" content="UAF CGPA Calculator | Automatic & Accurate" />
  <meta property="og:description" content="The best UAF CGPA Calculator. Automatically fetches results from the UAF LMS to calculate your exact CGPA and percentage." />
  <meta property="og:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />
  <meta property="og:site_name" content="UAF CGPA Calculator" />

  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://uafcgpacalculator.vercel.app/" />
  <meta property="twitter:title" content="UAF CGPA Calculator | Automatic & Accurate" />
  <meta property="twitter:description" content="The best UAF CGPA Calculator. Automatically fetches results from the UAF LMS to calculate your exact CGPA and percentage." />
  <meta property="twitter:image" content="https://uafcgpacalculator.vercel.app/uafcgpacalculator.png" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "UAF CGPA Calculator",
    "url": "https://uafcgpacalculator.vercel.app/",
    "applicationCategory": "EducationalApplication",
    "description": "An automatic CGPA calculator for students of the University of Agriculture Faisalabad (UAF) that fetches results directly from the university's LMS.",
    "operatingSystem": "All",
    "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "PKR" },
    "creator": { "@type": "Person", "name": "Muhammad Saqlain" },
    "mainEntity": {
      "@type": "FAQPage",
      "mainEntity": [
        { "@type": "Question", "name": "How does the UAF CGPA Calculator work?", "acceptedAnswer": { "@type": "Answer", "text": "The UAF CGPA Calculator securely connects to the public UAF LMS portal using your registration number. It fetches your official results, processes the grades and credit hours according to the official UAF grading formula, and instantly calculates your precise Semester GPA and Cumulative GPA (CGPA)." }},
        { "@type": "Question", "name": "Is it safe to use my registration number?", "acceptedAnswer": { "@type": "Answer", "text": "Yes, it is completely safe. The calculator only requires your registration number, not your password. Your information is used only for fetching your result for the current session and is never stored or shared. The connection is secure and private." }},
        { "@type": "Question", "name": "Can I use this calculator for other universities?", "acceptedAnswer": { "@type": "Answer", "text": "This calculator is specifically designed for the students of the University of Agriculture, Faisalabad (UAF). It uses UAF's unique grading system and connects directly to the UAF LMS, so it will not work for other universities." }}
      ]
    }
  }
  </script>
  
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --font-heading: 'Playfair Display', serif;
      --font-body: 'Inter', sans-serif;
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    [data-theme="light"] {
      --bg-primary: #F7F7F8;
      --bg-secondary: #FFFFFF;
      --bg-glass: rgba(255, 255, 255, 0.6);
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #8a8a8e;
      --border-color: rgba(0, 0, 0, 0.1);
      --accent-primary: #0071e3;
      --accent-secondary: #c79233;
      --danger: #d9363e;
      --success: #2a8a44;
      --info: #0071e3;
    }
    
    [data-theme="dark"] {
      --bg-primary: #0D0D0F;
      --bg-secondary: #161618;
      --bg-glass: rgba(22, 22, 24, 0.6);
      --text-primary: #f5f5f7;
      --text-secondary: #8e8e93;
      --text-tertiary: #636366;
      --border-color: rgba(255, 255, 255, 0.1);
      --accent-primary: #0A84FF;
      --accent-secondary: #D4AF37;
      --danger: #ff453a;
      --success: #30d158;
      --info: #0A84FF;
    }
    
    body {
      font-family: var(--font-body);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; z-index: -1;
      background: radial-gradient(circle at 10% 20%, color-mix(in srgb, var(--accent-primary) 15%, transparent) 40%),
                  radial-gradient(circle at 90% 80%, color-mix(in srgb, var(--accent-secondary) 15%, transparent) 40%);
      animation: background-pan 30s infinite alternate;
    }
    @keyframes background-pan {
      from { transform: translate(0%, 0%) scale(1.2); }
      to { transform: translate(-10%, 10%) scale(1.4); }
    }
    
    .animate-in { opacity: 0; transform: translateY(20px); transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1), transform 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
    .animate-in.is-visible { opacity: 1; transform: translateY(0); }
    
    .navbar { background: var(--bg-glass); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 1rem 0; }
    .navbar-brand { font-family: var(--font-heading); font-weight: 700; color: var(--text-primary); }
    .nav-link { color: var(--text-secondary); font-weight: 500; transition: var(--transition); }
    .nav-link:hover { color: var(--text-primary); }
    
    .btn { border-radius: 12px; font-weight: 600; padding: 12px 24px; transition: var(--transition); border: none; }
    .btn-primary-action { background: var(--accent-primary); color: #fff; }
    .btn-primary-action:hover { opacity: 0.8; transform: translateY(-2px); box-shadow: 0 10px 20px color-mix(in srgb, var(--accent-primary) 10%, transparent); }
    .btn-secondary-action { background: var(--bg-glass); color: var(--text-primary); border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
    .btn-secondary-action:hover { background: var(--bg-secondary); border-color: var(--text-secondary); }
    .btn-icon { background: transparent; color: var(--text-secondary); border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid transparent; }
    .btn-icon:hover { color: var(--text-primary); background: var(--bg-secondary); border-color: var(--border-color); }
    
    .hero { text-align: center; padding: 8rem 0; }
    .hero h1 { font-family: var(--font-heading); font-size: clamp(2.5rem, 6vw, 4.5rem); font-weight: 700; max-width: 800px; margin: 0 auto 1.5rem auto; line-height: 1.1; }
    .hero .lead { font-size: 1.25rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto 2.5rem auto; }
    
    .calculator-wrapper { background: var(--bg-glass); border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); padding: 3rem; margin-top: -5rem; position: relative; z-index: 10; backdrop-filter: blur(20px); }
    
    .form-control, .form-select { height: 56px; text-align: center; font-size: 1.1rem; background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 12px; }
    .form-control:focus, .form-select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent-primary) 20%, transparent); }
    
    .loading-container { display: none; padding: 4rem 0; text-align: center; }
    .loader { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 1.5rem; }
    .loader-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--accent-primary); animation: loader-bounce 1.4s infinite ease-in-out both; }
    .loader-dot:nth-child(1) { animation-delay: -0.32s; } .loader-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes loader-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    
    .result-container { display: none; }
    .results-header { border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; margin-bottom: 2rem; }
    .results-header .student-info h2 { font-family: var(--font-heading); font-size: clamp(1.8rem, 4vw, 2.5rem); }
    .results-header .student-info p { color: var(--text-secondary); font-size: 1.1rem; }
    .cgpa-metric .label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .cgpa-metric .value { font-size: clamp(2rem, 5vw, 2.75rem); font-weight: 700; color: var(--accent-secondary); line-height: 1; }
    .cgpa-metric .sub-value { font-size: 0.9rem; color: var(--text-tertiary); }
    
    .semester-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 992px) { .semester-grid { grid-template-columns: 1fr 1fr; } }
    .semester-section { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 1.5rem; transition: var(--transition); position: relative; }
    .semester-section:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--border-color); }
    .semester-header h5 { font-family: var(--font-heading); font-size: 1.5rem; }
    .semester-gpa .value { font-size: 1.75rem; font-weight: 700; color: var(--accent-secondary); }
    .semester-actions { position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.25rem; }

    .course-table th { border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-weight: 500; font-size: 0.8rem; padding-bottom: 0.5rem; }
    .course-table td { border-bottom: 1px solid var(--border-color); padding: 0.75rem 0.25rem; }
    .course-table tr:last-child td { border-bottom: none; }
    .clickable-info { font-weight: 600; cursor: pointer; }
    .course-table .course-actions i { cursor: pointer; padding: 5px; border-radius: 50%; transition: var(--transition); }
    .delete-course { color: var(--danger); } .delete-course:hover { background-color: color-mix(in srgb, var(--danger) 10%, transparent); }
    .restore-course { color: var(--success); } .restore-course:hover { background-color: color-mix(in srgb, var(--success) 10%, transparent); }
    
    .status-log-wrapper, .feature-card, .accordion-item, #contact-form-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); }
    
    .modal-content { background: var(--bg-glass); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: var(--radius); }
    
    #toast-container { position: fixed; top: 75px; right: 20px; z-index: 9999; }
    .toast { min-width: 300px; background: var(--bg-glass); backdrop-filter: blur(20px); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .toast-header { background-color: transparent; border-bottom-color: var(--border-color); }
    
    #undo-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; background: var(--bg-secondary); color: var(--text-primary); padding: 12px 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
    .undo-btn { background: var(--accent-secondary); color: var(--bg-primary); border: none; padding: 5px 10px; border-radius: 8px; cursor: pointer; }

    #backToTop { position: fixed; bottom: 20px; right: 20px; width: 44px; height: 44px; border-radius: 50%; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; visibility: hidden; transition: var(--transition); z-index: 1000; }
    #backToTop.visible { opacity: 1; visibility: visible; }
    #backToTop:hover { border-color: var(--accent-primary); color: var(--accent-primary); transform: translateY(-3px); }

    @media (min-width: 992px) {
        .course-table tbody tr { cursor: grab; }
        .course-table tbody tr.dragging { opacity: 0.4; background: var(--bg-secondary); }
        .semester-section.drag-over { border: 2px dashed var(--accent-primary); transform: scale(1.02); background: color-mix(in srgb, var(--accent-primary) 5%, transparent); }
    }
    
    @media (max-width: 767px) {
        .calculator-wrapper { padding: 1.5rem; margin-top: -3rem; }
        .results-header { text-align: center; }
        .results-header .student-info { margin-bottom: 1.5rem; }
        .cgpa-overview { justify-content: space-around !important; }
    }
  </style>
</head>
<body>

  <div id="backToTop"><i class="fas fa-arrow-up"></i></div>
  
  <div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="courseDetailsModalTitle">Course Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="courseDetailsModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Close</button></div></div>
    </div>
  </div>
  <div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add Custom Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><form id="addCourseForm"><input type="hidden" id="addCourseSemester" value=""><div class="mb-3"><label for="courseCode" class="form-label">Course Code</label><input type="text" class="form-control text-start" id="courseCode" placeholder="e.g., CHEM-101" required></div><div class="mb-3"><label for="courseTitle" class="form-label">Course Title</label><input type="text" class="form-control text-start" id="courseTitle" placeholder="e.g., Inorganic Chemistry" required></div><div class="row"><div class="col-6 mb-3"><label for="creditHours" class="form-label">Credit Hours</label><select class="form-select text-start" id="creditHours" required><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div><div class="col-6 mb-3"><label for="courseMarks" class="form-label">Marks</label><input type="number" class="form-control text-start" id="courseMarks" min="0" max="100" placeholder="e.g., 75" required></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary-action" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary-action" id="saveCourseBtn">Add Course</button></div></div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
      <a class="navbar-brand" href="/">ðŸŽ“ UAF CGPA Calculator</a>
      <div class="d-flex align-items-center gap-2">
        <button id="themeToggle" class="btn btn-icon" type="button" aria-label="Toggle theme"><i class="fa-solid fa-moon"></i></button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"><span class="navbar-toggler-icon"></span></button>
      </div>
      <div class="collapse navbar-collapse" id="mainNav"><ul class="navbar-nav ms-auto"><li class="nav-item"><a class="nav-link" href="#Auto-Calculator">Calculator</a></li><li class="nav-item"><a class="nav-link" href="#features">Features</a></li><li class="nav-item"><a class="nav-link" href="#faq">FAQ</a></li><li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li></ul></div>
    </div>
  </nav>

  <header class="hero" id="Home">
    <div class="container"><h1 class="animate-in">Unlock Your Academic Potential.</h1><p class="lead animate-in" style="animation-delay: 0.1s;">The definitive CGPA calculator for students of the University of Agriculture, Faisalabad. Instant, precise, and effortlessly elegant.</p><div class="animate-in" style="animation-delay: 0.2s;"><a href="#Auto-Calculator" class="btn btn-primary-action btn-lg">Calculate CGPA</a></div></div>
  </header>

  <main class="container my-5" id="Auto-Calculator">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-9">
        
        <div class="calculator-wrapper animate-in" style="animation-delay: 0.3s;">
          <div id="formContainer">
            <form id="resultForm">
              <div id="profileManagement" class="mb-3" style="display: none;"><label for="profileSwitcher" class="form-label">Saved Profiles</label><div class="input-group"><select class="form-select text-start" id="profileSwitcher"></select><button class="btn btn-outline-danger" type="button" id="deleteProfileBtn" title="Delete Selected Profile"><i class="fa-solid fa-trash-can"></i></button></div></div>
              <div class="mb-3"><input type="text" class="form-control" id="registrationNumber" placeholder="Enter registration number (e.g., 2020-ag-1234)" required></div>
              <div class="d-grid gap-2 d-md-flex justify-content-md-center"><button type="submit" class="btn btn-primary-action">Fetch Result</button><button type="button" id="startNewSearchBtn" class="btn btn-secondary-action">New Search</button></div>
            </form>
          </div>
          <div class="loading-container" id="loadingContainer"><div class="loader"><div class="loader-dot"></div><div class="loader-dot"></div><div class="loader-dot"></div></div><p class="loading-text" id="loadingStatusText">Connecting...</p></div>
          <div class="result-container" id="resultContainer">
            <div class="results-header row align-items-center">
                <div class="col-md-7 student-info"><h2 id="studentName">Student Name</h2><p id="studentReg">Registration Number</p></div>
                <div class="col-md-5 d-flex justify-content-md-end gap-3 gap-md-4 cgpa-overview"><div class="cgpa-metric"><p class="label">CGPA</p><p class="value" id="totalCgpa">0.00</p></div><div class="cgpa-metric"><p class="label">Percentage</p><p class="value" id="totalPercentage">0%</p></div><div class="cgpa-metric"><p class="label">Marks</p><p class="value" id="totalMarksObtained">0</p><p class="sub-value" id="totalMaxMarks">/ 0</p></div></div>
            </div>
            <div class="d-flex justify-content-center flex-wrap gap-2 action-buttons"><button id="downloadPdfBtn" class="btn btn-secondary-action">Download PDF</button><button id="copyDetailsBtn" class="btn btn-secondary-action">Copy Details</button><button id="addForecastSemesterBtn" class="btn btn-secondary-action">Forecast Semester</button></div>
            <div class="my-4" id="gpaChartContainer" style="display: none;"><canvas id="gpaTrendChart"></canvas></div>
            <div id="semesterResults" class="semester-grid"></div>
          </div>
        </div>

        <div class="status-log-wrapper mt-4 p-4 animate-in">
            <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0 fw-bold">Activity Log</h5><div class="d-flex gap-2"><button id="downloadLogBtn" class="btn btn-sm btn-secondary-action">Download</button><button id="clearLogBtn" class="btn btn-sm btn-secondary-action">Clear</button></div></div>
            <div class="status-log p-3" id="statusLog" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; border-radius: 8px;"><div class="status-line status-info">Waiting for input.</div></div>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="py-5" style="border-top: 1px solid var(--border-color);">
    <div class="container text-center text-secondary"><p class="mb-0">A project by Muhammad Saqlain. Â© 2025 UAFTools. All rights reserved.</p></div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const resultForm = document.getElementById('resultForm');
      const registrationNumber = document.getElementById('registrationNumber');
      const formContainer = document.getElementById('formContainer');
      const resultContainer = document.getElementById('resultContainer');
      const statusLog = document.getElementById('statusLog');
      const themeToggle = document.getElementById('themeToggle');
      const downloadLogBtn = document.getElementById('downloadLogBtn');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const semesterResults = document.getElementById('semesterResults');
      const studentName = document.getElementById('studentName');
      const studentReg = document.getElementById('studentReg');
      const totalCgpa = document.getElementById('totalCgpa');
      const totalPercentage = document.getElementById('totalPercentage');
      const totalMarksObtained = document.getElementById('totalMarksObtained');
      const totalMaxMarks = document.getElementById('totalMaxMarks');
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      const courseDetailsModal = new bootstrap.Modal(document.getElementById('courseDetailsModal'));
      const addCourseModal = new bootstrap.Modal(document.getElementById('addCourseModal'));
      const saveCourseBtn = document.getElementById('saveCourseBtn');
      const addCourseForm = document.getElementById('addCourseForm');
      const loadingContainer = document.getElementById('loadingContainer');
      const loadingStatusText = document.getElementById('loadingStatusText');
      const backToTopButton = document.getElementById('backToTop');
      const startNewSearchBtn = document.getElementById('startNewSearchBtn'); 
      const addForecastSemesterBtn = document.getElementById('addForecastSemesterBtn');
      const copyDetailsBtn = document.getElementById('copyDetailsBtn');
      const gpaChartContainer = document.getElementById('gpaChartContainer');
      const gpaTrendChartCanvas = document.getElementById('gpaTrendChart').getContext('2d'); 
      const profileManagementDiv = document.getElementById('profileManagement');
      const profileSwitcher = document.getElementById('profileSwitcher');
      const deleteProfileBtn = document.getElementById('deleteProfileBtn');
      
      let allLogs = [];
      let processedData = null;
      let deletedSemesters = {};
      let gpaChart = null; 
      
      const API_ENDPOINT = `/api/result-scraper?action=scrape_single`;
      
      function init() {
        initTheme();
        createToastContainer();
        initBackToTop();
        initScrollAnimations(); 
        loadProfiles();
      }

      function initScrollAnimations() {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1 });
        document.querySelectorAll('.animate-in').forEach(el => observer.observe(el));
      }

      function loadProfiles() {
        const profiles = JSON.parse(localStorage.getItem('uafCalculatorProfiles') || '{}');
        const activeProfileReg = localStorage.getItem('uafCalculatorActiveProfile');
        updateProfileSwitcher(profiles, activeProfileReg);
        if (activeProfileReg && profiles[activeProfileReg]) {
          loadProfile(activeProfileReg);
          addStatusMessage('Loaded active profile from session.', 'info');
        }
      }

      function updateProfileSwitcher(profiles, activeProfileReg) {
        const profileKeys = Object.keys(profiles);
        if (profileKeys.length > 0) {
          profileSwitcher.innerHTML = '<option value="">Select a saved profile...</option>';
          profileKeys.forEach(regNum => {
            const option = document.createElement('option');
            option.value = regNum;
            option.textContent = `${profiles[regNum].studentInfo.name} (${regNum})`;
            if (regNum === activeProfileReg) option.selected = true;
            profileSwitcher.appendChild(option);
          });
          profileManagementDiv.style.display = 'block';
        } else {
          profileManagementDiv.style.display = 'none';
        }
      }

      function loadProfile(regNum) {
        const profiles = JSON.parse(localStorage.getItem('uafCalculatorProfiles') || '{}');
        if (profiles[regNum]) {
          processedData = profiles[regNum];
          const cgpaData = calculateCGPA(processedData);
          displayCGPAResults(processedData, cgpaData);
          registrationNumber.value = regNum;
          localStorage.setItem('uafCalculatorActiveProfile', regNum);
          updateProfileSwitcher(profiles, regNum);
        }
      }

      function switchProfile(event) {
        const regNum = event.target.value;
        if (regNum) {
          loadProfile(regNum);
          showToast(`Switched to profile: ${regNum}`, 'info');
        }
      }

      function deleteCurrentProfile() {
        const activeProfileReg = localStorage.getItem('uafCalculatorActiveProfile');
        if (!activeProfileReg) { showToast('No active profile to delete.', 'warning'); return; }
        if (confirm(`Are you sure you want to delete the profile for ${activeProfileReg}? This cannot be undone.`)) {
          const profiles = JSON.parse(localStorage.getItem('uafCalculatorProfiles') || '{}');
          delete profiles[activeProfileReg];
          localStorage.setItem('uafCalculatorProfiles', JSON.stringify(profiles));
          localStorage.removeItem('uafCalculatorActiveProfile');
          showToast(`Profile for ${activeProfileReg} deleted.`, 'success');
          addStatusMessage(`Deleted profile: ${activeProfileReg}`, 'info');
          setTimeout(() => location.reload(), 500);
        }
      }

      function startNewSearch() {
          showToast('Ready for a new search.', 'info');
          location.reload();
      }
      
      function initBackToTop() {
        window.addEventListener('scroll', () => backToTopButton.classList.toggle('visible', window.pageYOffset > 300));
        backToTopButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }
      
      function createToastContainer() {
        if (!document.getElementById('toast-container')) {
          const toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
          document.body.appendChild(toastContainer);
        }
      }
      
      function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        const toastTypeClasses = { success: 'text-bg-success', error: 'text-bg-danger', warning: 'text-bg-warning', info: 'text-bg-info' };
        const toastHTML = `
          <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${toastTypeClasses[type]}">
              <strong class="me-auto">Notification</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">${message}</div>
          </div>`;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement, {delay: 3000});
        bsToast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
      }
      
      function initTheme() {
        const THEME_KEY = 'uaf-theme-premium';
        const applyTheme = (theme) => {
          document.documentElement.setAttribute('data-theme', theme);
          localStorage.setItem(THEME_KEY, theme);
          themeToggle.innerHTML = theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
          if(gpaChart) renderGpaChart();
        };
        const currentTheme = localStorage.getItem(THEME_KEY) || 'dark';
        applyTheme(currentTheme);
        themeToggle.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'));
      }
      
      function addStatusMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        allLogs.push({ timestamp, message, type });
        const messageEl = document.createElement('div');
        const typeClasses = { success: 'text-success', error: 'text-danger', warning: 'text-warning', info: 'text-info' };
        messageEl.className = `status-line ${typeClasses[type]}`;
        messageEl.textContent = `[${timestamp}] ${message}`;
        statusLog.prepend(messageEl);
      }
      
      function showLoadingStage(message) {
        formContainer.style.display = 'none';
        resultContainer.style.display = 'none';
        loadingContainer.style.display = 'block';
        loadingStatusText.textContent = message;
      }
      
      function downloadLog() { /* ... full logic from original ... */ }
      function clearLog() { statusLog.innerHTML = ''; allLogs = []; addStatusMessage('Log cleared', 'info'); }
      function processSemesterName(s) { if(!s)return'Unknown';if(s.includes('Winter')){const m=s.match(/(\d{4})/);if(m)return`Winter ${m[1]}`}else if(s.includes('Spring')){const m=s.match(/(\d{4})-(\d{2,4})/);if(m&&m[2].length===4)return`Spring ${m[2]}`;if(m&&m[2].length===2)return`Spring 20${m[2]}`}else if(s.includes('Summer')){const m=s.match(/(\d{4})/);if(m)return`Summer ${m[1]}`}else if(s.includes('Fall')){const m=s.match(/(\d{4})/);if(m)return`Fall ${m[1]}`}return s}
      function getSemesterOrderKey(s){if(!s)return'9999-9';if(s.toLowerCase().startsWith('forecast')){const n=parseInt(s.split(' ')[1]||'1');return`3000-${n}`}let y='9999',o=9;const m=s.match(/\b(20\d{2})\b/);if(m)y=m[1];if(s.toLowerCase().includes('winter'))o=1;else if(s.toLowerCase().includes('spring'))o=2;else if(s.toLowerCase().includes('summer'))o=3;else if(s.toLowerCase().includes('fall'))o=4;return`${y}-${o}`}
      function processScrapedData(d){if(!d||!d.resultData)return null;const si={name:d.resultData[0]?.StudentName||'',registration:d.resultData[0]?.RegistrationNo||''};const sems={};const hist={};d.resultData.forEach(c=>{const sName=processSemesterName(c.Semester);const cCode=c.CourseCode||'';const hKey=cCode.toUpperCase();if(!sems[sName])sems[sName]={originalName:c.Semester,sortKey:getSemesterOrderKey(sName),courses:[]};const chStr=c.CreditHours||'0';const ch=parseInt(chStr.match(/\d+/)?.[0]||'0');const m=parseFloat(c.Total||'0');let qp=calculateQualityPoints(m,ch);if(c.Grade==='F')qp=0;const cData={code:cCode,title:c.CourseTitle||'',creditHours:ch,creditHoursDisplay:chStr,marks:m,qualityPoints:qp,grade:c.Grade||'',teacher:c.TeacherName||'',mid:c.Mid||'0',assignment:c.Assignment||'0',final:c.Final||'0',practical:c.Practical||'0',total:c.Total||'0',isExtraEnrolled:false,isRepeated:false,isDeleted:false,isCustom:false};if(!hist[hKey])hist[hKey]=[];hist[hKey].push({semester:sName,semesterSortKey:getSemesterOrderKey(sName),marks:m,data:cData});sems[sName].courses.push(cData)});Object.values(hist).forEach(h=>{if(h.length>1){h.sort((a,b)=>a.semesterSortKey.localeCompare(b.semesterSortKey));const hi=h.reduce((p,c)=>(p.marks>c.marks)?p:c);h.forEach(i=>{i.data.isRepeated=true;if(i!==hi)i.data.isExtraEnrolled=true})}});return{studentInfo:si,semesters:sems,courseHistory:hist}}
      function calculateQualityPoints(m,c){m=parseFloat(m);c=parseInt(c);let q=0;if(c===5){if(m>=80)q=20;else if(m>=50)q=20-((80-m)*.33333);else if(m<50)q=10-((50-m)*.5);if(m<40)q=0}else if(c===4){if(m>=64)q=16;else if(m>=40)q=16-((64-m)*.33333);else if(m<40)q=8-((40-m)*.5);if(m<32)q=0}else if(c===3){if(m>=48)q=12;else if(m>=30)q=12-((48-m)*.33333);else if(m<30)q=6-((30-m)*.5);if(m<24)q=0}else if(c===2){if(m>=32)q=8;else if(m>=20)q=8-((32-m)*.33333);else if(m<20)q=4-((20-m)*.5);if(m<16)q=0}else if(c===1){if(m>=16)q=4;else if(m>=10)q=4-((16-m)*.33333);else if(m<10)q=2-((10-m)*.5);if(m<8)q=0}return parseFloat(Math.max(0,q).toFixed(2))}
      function calculateCustomGrade(m,c){const g={5:{A:80,B:50,D:40},4:{A:64,B:52,C:40,D:32},3:{A:48,B:39,C:30,D:24},2:{A:32,B:26,C:20,D:16},1:{A:16,B:13,C:10,D:8}};const s=g[c];if(!s)return'F';if(m>=s.A)return'A';if(m>=s.B)return'B';if(s.C&&m>=s.C)return'C';if(m>=s.D)return'D';return'F'}
      function calculateCGPA(d){if(!d)return null;let tqp=0,tch=0,tmo=0,tmm=0;Object.values(d.semesters).forEach(s=>{s.totalQualityPoints=0;s.totalCreditHours=0;s.totalMarksObtained=0;s.totalMaxMarks=0;s.courses.forEach(c=>{if(!c.isExtraEnrolled&&!c.isDeleted){s.totalQualityPoints+=c.qualityPoints;s.totalCreditHours+=c.creditHours;s.totalMarksObtained+=c.marks;let mm={5:100,4:80,3:60,2:40,1:20}[c.creditHours]||0;s.totalMaxMarks+=mm;tqp+=c.qualityPoints;tch+=c.creditHours;tmo+=c.marks;tmm+=mm}});s.gpa=s.totalCreditHours>0?(s.totalQualityPoints/s.totalCreditHours):0;s.percentage=s.totalMaxMarks>0?(s.totalMarksObtained/s.totalMaxMarks*100):0});const cgpa=tch>0?(tqp/tch):0;const p=tmm>0?(tmo/tmm*100):0;return{cgpa,percentage:p,totalQualityPoints:tqp,totalCreditHours:tch,totalMarksObtained:tmo,totalMaxMarks:tmm}}
      function formatNumber(v,p=4){return parseFloat(v.toFixed(p))}
      
      function displayCGPAResults(data, cgpaData) {
        processedData = data;
        loadingContainer.style.display = 'none';
        resultContainer.style.display = 'block';
        
        studentName.textContent = data.studentInfo.name;
        studentReg.textContent = data.studentInfo.registration;
        totalCgpa.textContent = formatNumber(cgpaData.cgpa).toFixed(4);
        totalPercentage.textContent = `${formatNumber(cgpaData.percentage, 2).toFixed(2)}%`;
        totalMarksObtained.textContent = cgpaData.totalMarksObtained.toFixed(0);
        totalMaxMarks.textContent = `/ ${cgpaData.totalMaxMarks.toFixed(0)}`;
        
        semesterResults.innerHTML = '';
        Object.keys(data.semesters).sort((a,b) => data.semesters[a].sortKey.localeCompare(data.semesters[b].sortKey)).forEach(semesterName => {
          const semester = data.semesters[semesterName];
          const semesterCard = document.createElement('div');
          semesterCard.className = 'semester-section';
          semesterCard.dataset.semester = semesterName;
          semesterCard.innerHTML = `
            <div class="semester-header d-flex justify-content-between align-items-start">
              <div><h5>${semesterName}</h5><small class="text-secondary">${semester.totalCreditHours || 0} Credit Hours</small></div>
              <div class="text-end semester-gpa"><p class="value mb-0">${formatNumber(semester.gpa, 4).toFixed(4)}</p><small class="text-secondary">GPA</small></div>
            </div>
            <div class="semester-actions">
              <button class="btn btn-icon" data-semester="${semesterName}" onclick="openAddCourseModal('${semesterName}')" title="Add Custom Course"><i class="fa-solid fa-plus"></i></button>
              <button class="btn btn-icon" data-semester="${semesterName}" onclick="deleteSemester('${semesterName}')" title="Delete Semester"><i class="fa-solid fa-trash"></i></button>
            </div>
            <hr style="border-color: var(--border-color); opacity: 0.5;">
            <div class="table-responsive"><table class="course-table table table-borderless">
                <thead><tr><th>Course</th><th class="text-center">Marks</th><th class="text-center">Grade</th><th></th></tr></thead>
                <tbody>${semester.courses.map((course, index) => {
                    const courseIdentifier = `${semesterName}-${course.code}-${course.total}-${index}`;
                    const courseJSON = JSON.stringify(course).replace(/'/g, "&#39;");
                    return `
                    <tr data-course-identifier="${courseIdentifier}" draggable="true" class="${course.isExtraEnrolled ? 'table-warning' : ''} ${course.isDeleted ? 'opacity-50 text-decoration-line-through' : ''}">
                      <td onclick='showCourseDetails(${courseJSON})'><span class="clickable-info">${course.code}</span><small class="d-block text-secondary">${course.title}</small></td>
                      <td class="text-center align-middle">${course.marks.toFixed(0)}</td>
                      <td class="text-center align-middle">${course.grade}</td>
                      <td class="text-end align-middle course-actions">${course.isDeleted ? `<i class="fa-solid fa-rotate-left restore-course" onclick='modifyCourseState(${courseJSON}, "${semesterName}", false)' title="Restore"></i>` : `<i class="fa-solid fa-trash delete-course" onclick='modifyCourseState(${courseJSON}, "${semesterName}", true)' title="Delete"></i>`}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table></div>`;
          semesterResults.appendChild(semesterCard);
        });
        attachResultEventListeners();
        renderGpaChart(); 
      }

      function renderGpaChart() { /* ... full logic from original ... */ }
      function attachResultEventListeners() { if (window.innerWidth >= 992) initDragAndDrop(); }
      function initDragAndDrop() { /* ... full logic from original ... */ }
      window.showCourseDetails = function(course) { /* ... full logic from original ... */ document.getElementById('courseDetailsModalTitle').textContent = `${course.code} - ${course.title}`; document.getElementById('courseDetailsModalBody').innerHTML = `...`; courseDetailsModal.show(); }
      window.openAddCourseModal = function(semesterName) { document.getElementById('addCourseSemester').value = semesterName; addCourseForm.reset(); addCourseModal.show(); }
      function addCustomCourse() { /* ... full logic from original ... */ }
      window.deleteSemester = function(name) { if (!processedData||!processedData.semesters[name]) return; deletedSemesters[name] = JSON.parse(JSON.stringify(processedData.semesters[name])); delete processedData.semesters[name]; recalculateAndDisplay(); showUndoNotification(`Semester "${name}" deleted`, () => undoDeleteSemester(name)); }
      function showUndoNotification(msg, cb) { document.getElementById('undo-notification')?.remove(); const n = document.createElement('div'); n.id = 'undo-notification'; n.className = 'undo-notification'; n.innerHTML = `<span>${msg}</span> <button class="undo-btn">Undo</button>`; document.body.appendChild(n); n.querySelector('.undo-btn').onclick = () => { cb(); n.remove(); }; setTimeout(() => n.remove(), 5000); }
      function undoDeleteSemester(name) { if (!deletedSemesters[name]) return; processedData.semesters[name] = deletedSemesters[name]; delete deletedSemesters[name]; recalculateAndDisplay(); }
      window.modifyCourseState = function(course, semester, isDeleted) { const c = processedData.semesters[semester]?.courses.find(c => c.code === course.code && c.total === course.total); if (c) { c.isDeleted = isDeleted; recalculateAndDisplay(); } }
      function recalculateAndDisplay() { const cgpaData = calculateCGPA(processedData); displayCGPAResults(processedData, cgpaData); const activeReg = localStorage.getItem('uafCalculatorActiveProfile'); if (activeReg) { const p = JSON.parse(localStorage.getItem('uafCalculatorProfiles')||'{}'); if (p[activeReg]) { p[activeReg] = processedData; localStorage.setItem('uafCalculatorProfiles', JSON.stringify(p)); } } }
      function addForecastSemester() { /* ... full logic from original ... */ }
      function copyDetailsToClipboard() { /* ... full logic from original ... */ }
      function generatePDF() { /* ... full logic from original ... */ }

      async function fetchResult() {
        const regNum = registrationNumber.value.trim();
        if (!regNum) { showToast('Please enter a registration number', 'error'); return; }
        showLoadingStage('Connecting to UAF LMS...');
        addStatusMessage(`Fetching result for: ${regNum}`, 'info');

        try {
          const response = await fetch(`${API_ENDPOINT}&registrationNumber=${encodeURIComponent(regNum)}`);
          if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
          showLoadingStage('Fetching Your Results...');
          const data = await response.json();
          showLoadingStage('Processing Data...');
          
          if (data.success && data.resultData && data.resultData.length > 0) {
            addStatusMessage('Result fetched successfully', 'success');
            const processed = processScrapedData(data);
            const cgpaData = calculateCGPA(processed);
            
            const profiles = JSON.parse(localStorage.getItem('uafCalculatorProfiles') || '{}');
            profiles[regNum] = processed;
            localStorage.setItem('uafCalculatorProfiles', JSON.stringify(profiles));
            localStorage.setItem('uafCalculatorActiveProfile', regNum);
            
            displayCGPAResults(processed, cgpaData);
            showToast('Result fetched successfully!', 'success');
            updateProfileSwitcher(profiles, regNum);
          } else { throw new Error(data.message || "No result found."); }
        } catch (error) {
            addStatusMessage(`Error: ${error.message}`, 'error');
            showToast(error.message, 'error');
            loadingContainer.style.display = 'none';
            formContainer.style.display = 'block';
        }
      }
      
      resultForm.addEventListener('submit', (e) => { e.preventDefault(); fetchResult(); });
      downloadLogBtn.addEventListener('click', downloadLog);
      clearLogBtn.addEventListener('click', clearLog);
      downloadPdfBtn.addEventListener('click', generatePDF);
      saveCourseBtn.addEventListener('click', addCustomCourse);
      startNewSearchBtn.addEventListener('click', startNewSearch);
      addForecastSemesterBtn.addEventListener('click', addForecastSemester); 
      copyDetailsBtn.addEventListener('click', copyDetailsToClipboard);
      profileSwitcher.addEventListener('change', switchProfile);
      deleteProfileBtn.addEventListener('click', deleteCurrentProfile);
      
      init();
    });
  </script>

</body>
</html>
